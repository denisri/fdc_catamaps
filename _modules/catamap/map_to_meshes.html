<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>catamap.map_to_meshes &#8212; CataMap 2.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CataMap 2.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">catamap.map_to_meshes</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for catamap.map_to_meshes</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># coding: UTF-8</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Catacombs maps using SVG source map with codes inside it.</span>

<span class="sd">The program allows to produce:</span>

<span class="sd">* 2D &quot;readable&quot; maps with symbols changed to larger ones, second level shifted to avoid superimposition of corridors, enlarged zooms, shadowing etc.</span>

<span class="sd">* 3D maps to be used in a 3D visualization program, a webGL server, or the CataZoom app.</span>

<span class="sd">Requirements</span>
<span class="sd">============</span>

<span class="sd">* Having inkscape installed on the system and available in the PATH.</span>
<span class="sd">  A recent version of inkscape (1.0 at least) is recommended to avoid units and</span>
<span class="sd">  scaling problems.</span>
<span class="sd">* Either:</span>

<span class="sd">  * the Pillow (PIL) python module (see later)</span>
<span class="sd">  * or ImageMagick &quot;convert&quot; tool to convert PNG to JPEG. If Pillow is present,</span>
<span class="sd">    then convert will not be</span>
<span class="sd">    used.</span>

<span class="sd">    **Warning:** https://github.com/ImageMagick/ImageMagick/issues/396</span>
<span class="sd">    ImageMagick cache (disk limit) size is too small.</span>
<span class="sd">    Edit /etc/ImageMagick-6/policy.xml and change disk resource limit::</span>

<span class="sd">        &lt;policy domain=&quot;resource&quot; name=&quot;memory&quot; value=&quot;12GiB&quot;/&gt;</span>
<span class="sd">        &lt;policy domain=&quot;resource&quot; name=&quot;map&quot; value=&quot;20GiiB&quot;/&gt;</span>
<span class="sd">        &lt;policy domain=&quot;resource&quot; name=&quot;width&quot; value=&quot;50KP&quot;/&gt;</span>
<span class="sd">        &lt;policy domain=&quot;resource&quot; name=&quot;height&quot; value=&quot;50KP&quot;/&gt;</span>
<span class="sd">        &lt;policy domain=&quot;resource&quot; name=&quot;area&quot; value=&quot;20GiB&quot;/&gt;</span>
<span class="sd">        &lt;policy domain=&quot;resource&quot; name=&quot;disk&quot; value=&quot;80GiB&quot;/&gt;</span>

<span class="sd">Python modules:</span>

<span class="sd">These can be installed using the command::</span>

<span class="sd">    python -m pip install six numpy scipy Pillow</span>

<span class="sd">* :mod:`~catamap.svg_to_mesh` submodule and its requirements (part of this</span>
<span class="sd">  project)</span>
<span class="sd">* xml ElementTree</span>
<span class="sd">* six</span>
<span class="sd">* numpy</span>
<span class="sd">* scipy</span>
<span class="sd">* Pillow (PIL) optionally for PNG/JPEG image conversion. Otherwise ImageMagick</span>
<span class="sd">  &quot;convert&quot; tool will be used (see above)</span>

<span class="sd">The 3D part has additional requirements:</span>

<span class="sd">* soma.aims (https://github.com/brainvisa/aims-free)</span>
<span class="sd">* anatomist (https://github.com/brainvisa/anatomist-free and</span>
<span class="sd">  https://github.com/brainvisa/anatomist-gpl)</span>
<span class="sd">* json</span>

<span class="sd">The maps differences tool (:mod:`~catamap.diff_svg`) also needs:</span>

<span class="sd">* yaml (pip module ``pyyaml``)</span>

<span class="sd">Usage</span>
<span class="sd">=====</span>

<span class="sd">* set the ``python`` subdirectory of the project in your ``PYTHONPATH`` environment variable. Under Unix sh/bash shells, this would be::</span>

<span class="sd">    export PYTHONPATH=&quot;~/fdc_catamaps/python:$PYTHONPATH&quot;</span>

<span class="sd">  (it can be set in a ``.bash_profile`` or ``.bashrc`` init file)</span>

<span class="sd">* get or make the source SVG file with codes inside, for instance ``plan_14_fdc_2021_04_29.svg``</span>
<span class="sd">main</span>
<span class="sd">* go to the directory containing it</span>
<span class="sd">* run the module ``catamap`` as a program::</span>

<span class="sd">    python -m catamap --2d plan_14_fdc_2021_04_29.svg</span>

<span class="sd">It should work using either python2 or python3.</span>
<span class="sd">The 2D maps options will produce files with suffixes in the current directory:</span>
<span class="sd">modified .svg files, .pdf and .jpg files.</span>

<span class="sd">The 3D maps option will produce meshes in a subdirectory.</span>

<span class="sd">Use the commandline with the &#39;-h&#39; option to get all parameters help.</span>


<span class="sd">Inkscape SVG files</span>
<span class="sd">==================</span>

<span class="sd">SVG files may (should) contain additional XML properties that can be set in the XML editor in the Inkscape software. They allow to specify how objects should be parsed, grouped, represented etc. For now they are mainly used in the 3D part, but the 2D part also uses ``level``, ``label``, and ``private`` information information.</span>

<span class="sd">Codes correspond to properties used in the program, and can be set in XML elements in the SVG file.</span>

<span class="sd">Bool properties can be written ``true``, ``True``, ``1``, or ``false``, ``False``, ``0``.</span>

<span class="sd">Properties are inherited from parent (group/layer) to children. Thus if a layer has the property ``corridor`` set to ``true``, all objects in this layer will be marked as ``corridor``.</span>

<span class="sd">In the program, elements are grouped into meshes: a mesh will be the concatenation of all elements of the same kind, to avoid having dozens of thousands of mesh files to load. An object &quot;kind&quot; (a group making a single mesh) is identified by several of its properties, but not all. Namely the identifier is::</span>

<span class="sd">    &lt;label&gt;_&lt;level&gt;_&lt;public/private&gt;_&lt;accessible/inaccessible&gt;[_&lt;category&gt;]</span>

<span class="sd">Other properties are not discriminative, so in some conditions may not be taken into account. For instance if a layer defines a label, level, public and accessible states, and marks items as corridors, if one element inside adds a property ``block``, it will be part of the same mesh group anyway, and the ``block`` property will be ignored.</span>

<span class="sd">Properties list</span>
<span class="sd">---------------</span>

<span class="sd">**alt_colors:** JSON dict (**2D and 3D maps**)</span>
<span class="sd">    color to be used alternatively in maps. This is a string representing a</span>
<span class="sd">    JSON format dictionary. Keys are colorsets names, values are a second level</span>
<span class="sd">    of dictionary which specifies color properties, a bit like for SVG elements</span>
<span class="sd">    style. The</span>
<span class="sd">    default colorset for 3D maps is ``map_3d``.</span>
<span class="sd">    Ex::</span>

<span class="sd">        {&quot;map_3d&quot;: &quot;#cccccc4c&quot;}</span>

<span class="sd">    see also: :ref:`colorsets`</span>

<span class="sd">**arrow:** bool (**3D maps**)</span>
<span class="sd">    arrows join a text label to a location on map. They are filar meshes. Most</span>
<span class="sd">    of them are just a segment (2 points) but they may contain more points.</span>
<span class="sd">    Points orientation is important as the arrow goes from the text (above the</span>
<span class="sd">    meshes) down to the pointed item below.</span>
<span class="sd">**arrow_base_height_shift:** float (**3D maps**)</span>
<span class="sd">    z shift of the base of an arrow element in the upper layer depth. The arrow head shift is specified using height_shift.</span>
<span class="sd">**block:** bool (**3D maps**)</span>
<span class="sd">    block elements have a ceiling and walls. Meshes are extruded and tesselated</span>
<span class="sd">    to be filled.</span>
<span class="sd">**border:** bool (**3D maps**)</span>
<span class="sd">    not used if I remember...</span>
<span class="sd">**category:** str (**3D maps**)</span>
<span class="sd">    the category string the element will be associated in the 3D views.</span>
<span class="sd">    Categories can be displayed/hidden using buttons or menus in 3D views.</span>
<span class="sd">**catflap:** bool (**3D maps**)</span>
<span class="sd">    In catflaps, paths are replaced with striped tubes.</span>
<span class="sd">**colorset_inheritance:** JSON dict (**2D and 3D maps**)</span>
<span class="sd">    used as a property of the ``metadata`` layer only, it specifies colorsets</span>
<span class="sd">    which can inherit the colors defined by another, in order to minimally</span>
<span class="sd">    specialize it.</span>

<span class="sd">    see also: :ref:`colorsets`</span>

<span class="sd">**corridor:** bool (**3D maps**)</span>
<span class="sd">    corridors have a floor and walls. Meshes are extruded and tesselated to be</span>
<span class="sd">    filled.</span>
<span class="sd">**date:** str (**2D maps**)</span>
<span class="sd">    the date text will be replaced with the date of the map build.</span>
<span class="sd">**depth_map:** bool (**3D maps**)</span>
<span class="sd">    the layer is a depth map. It should contain a ``level`` property to define</span>
<span class="sd">    the level it maps. See :ref:`depth_maps` for details.</span>
<span class="sd">**glabel:** str (**2D maps**)</span>
<span class="sd">    &quot;group label&quot; used to replace elements with ones from the legends layer.</span>
<span class="sd">    The ``glabel`` is associated to one legends element if the legends element</span>
<span class="sd">    ``label`` property has the value of the ``glabel`` property of the element</span>
<span class="sd">    plus the duffix ``_proto``. Ex, in the legends::</span>

<span class="sd">        label: colim_proto</span>

<span class="sd">    in the map elements::</span>

<span class="sd">        glabel: colim</span>

<span class="sd">**height_map:** bool (**3D maps**)</span>
<span class="sd">    the layer is a height map. This is the same as **depth_map** except that</span>
<span class="sd">    heights are inverted compared to depths. All related attributes are the</span>
<span class="sd">    same as for **depth_map** otherwise.</span>
<span class="sd">**height_shift:** float (**3D maps**)</span>
<span class="sd">    z shift of the element (esp. for corridor, block, wall elements, but also</span>
<span class="sd">    wells and arrows). An element with a height shift will not begin on the</span>
<span class="sd">    ground, but above or below as specified.</span>
<span class="sd">**hidden:** bool (**2D and 3D maps**)</span>
<span class="sd">    removed from 3D maps.</span>
<span class="sd">**inaccessible:** bool (**3D maps**)</span>
<span class="sd">    inaccessible elements will be separated from others, and set in the</span>
<span class="sd">    ``Inaccessible`` display category.</span>
<span class="sd">**item_height:** float (**3D maps**)</span>
<span class="sd">    height of the element (esp. for corridor, block, wall elements).</span>
<span class="sd">    **WARNING:** it is ``item_height``, not ``height`` as height is already an</span>
<span class="sd">    official SVG attribute for some elements (rectangles for instance).</span>
<span class="sd">**label:** str (**2D and 3D maps**)</span>
<span class="sd">    name of the element type</span>
<span class="sd">**label_alt_colors:** JSON dict (**2D and 3D maps**)</span>
<span class="sd">    Like alt_colors, except that the dict has an upper-level which keys area</span>
<span class="sd">    object labels. The dict can be applied hierarchically, thus put in a layer.</span>
<span class="sd">    Ex::</span>

<span class="sd">        {&quot;repetiteur&quot;: {&quot;black&quot;: {&quot;bg&quot;: &quot;#cccccc4c&quot;}}}</span>

<span class="sd">    see also: :ref:`colorsets`</span>

<span class="sd">**legend:** bool (**2D maps**)</span>
<span class="sd">    set on a layer, indicates that this layer contains the legend symbols and</span>
<span class="sd">    can be searched for replacement symbols (wells, etc) which will replace</span>
<span class="sd">    those in the map to enlarge them and ease view from a bit further.</span>
<span class="sd">**level:** str (**2D and 3D maps**)</span>
<span class="sd">    depth level name (sup, inf, surf, tech, metro, esc...). Levels are an</span>
<span class="sd">    &quot;open&quot; property, there is no predefined list of levels, apart for 2</span>
<span class="sd">    exceptions:</span>

<span class="sd">    * items which don&#39;t specify a level are set by default to a level named</span>
<span class="sd">      ``sup`` (generally superior corridor level).</span>
<span class="sd">    * a ``surf`` level represents the ground surface, and is automatically</span>
<span class="sd">      built. It is flat, altitude 0 by default, but can be associated to an</span>
<span class="sd">      altitude map and geolocalisation information. See :ref:`altitude_maps`</span>
<span class="sd">      later.</span>

<span class="sd">    Levels are associated to depth maps, so for each level used (except</span>
<span class="sd">    ``surf``), a ``depth_map`` layer is supposed to be defined. See</span>
<span class="sd">    :ref:`depth_maps`.</span>
<span class="sd">**main_clip_rect_id:** JSON dict (**2D maps**)</span>
<span class="sd">    set in the Inkscape metadata layer, it indicates the clip rectangle ID (in</span>
<span class="sd">    the XML elements IDs) for each map type. A default (fallback) one can be</span>
<span class="sd">    given under the key ``default`` in the dict. Ex::</span>

<span class="sd">        {&quot;default&quot;: &quot;clip_general&quot;, &quot;private&quot;: &quot;clip_all&quot;}</span>

<span class="sd">    so that, in this example, the ``private`` map gets a different field of</span>
<span class="sd">    view from the other ones.</span>

<span class="sd">**map_transform:** SVG transformation spec (**2D maps**)</span>
<span class="sd">    additional transformation applied to elements, used for</span>
<span class="sd">    instance to shift lower level parts when they are superimposed under an</span>
<span class="sd">    upper level. Without this shift, they would not be seen because they are</span>
<span class="sd">    hidden by the upper level. The transform is specified in the same way as</span>
<span class="sd">    the standard SVG ``transform`` property.</span>

<span class="sd">    This propery can be set to paths, groups, and arrows (which will thus point</span>
<span class="sd">    to a shifted location).</span>
<span class="sd">**marker:** str (**3D maps**)</span>
<span class="sd">    set on a layer to specify that this layer is a **markers layer**. Two types</span>
<span class="sd">    of markers are currently recognized: ``sounds`` and ``photos``.</span>

<span class="sd">    See :ref:`markers` for more details.</span>

<span class="sd">**markers_base_url:** bool (**3D maps**)</span>
<span class="sd">    set on a :ref:`marker layer &lt;markers&gt;` to specify that marekrs in this</span>
<span class="sd">    layer have URLS which point to the server directory specified here.</span>
<span class="sd">    Individual markers will be appended to this base URL. The URL may be</span>
<span class="sd">    absolute (``https://photos.google.com/xyzsomething``) or relative to the</span>
<span class="sd">    map server (``photos/photo_dir``). If not specified, the default base url</span>
<span class="sd">    is the markers type (``photos``, ``sounds``), in relative mode.</span>
<span class="sd">**markers_map:** str (**3D maps**)</span>
<span class="sd">    Set on a :ref:`marker layer &lt;markers&gt;`: correspondence map file name (CSV</span>
<span class="sd">    file) for markers text. See :ref:`markers` for more details.</span>
<span class="sd">**non_visibility:** str (**2D maps**)</span>
<span class="sd">    list of maps types (json-like), for which this layer is removed. The</span>
<span class="sd">    inverse of **visibility** (see below).</span>
<span class="sd">**private:** bool (**2D and 3D maps**)</span>
<span class="sd">    private elements will only be visible if a code is provided</span>
<span class="sd">**proto_scale:** float (**2D maps**)</span>
<span class="sd">    Only in the legend layers elements which are prototypes for symbols</span>
<span class="sd">    replacements, this is the scale to be applied when replacing. The default</span>
<span class="sd">    scale is 0.5 (replaced elements will be half the size they have in the</span>
<span class="sd">    legend).</span>
<span class="sd">**radius:** float (**3D maps)</span>
<span class="sd">    used in a &quot;marker&quot; layer to specify the max radius between the user click</span>
<span class="sd">    and the marker position for it to be triggered. It can be set on the marker</span>
<span class="sd">    layer itself, or on any marker item inside.</span>

<span class="sd">    See :ref:`markers` for more details.</span>

<span class="sd">**replace_children:** bool (**2D maps**)</span>
<span class="sd">    should be set only in replacement symbols in the legend layer (wells signs,</span>
<span class="sd">    etc) to indicate that children of matching elements should be parsed</span>
<span class="sd">    recursively and their children may be replaced also.</span>
<span class="sd">**symbol:** bool (**3D maps**)</span>
<span class="sd">    not sure it is used, after all...</span>
<span class="sd">**text:** bool (**3D maps**)</span>
<span class="sd">    text layers.</span>
<span class="sd">**title:** bool (**3D maps**)</span>
<span class="sd">    The title string(s) will be used and displayed in the web site title.</span>
<span class="sd">**upper_level:** str (**3D maps**)</span>
<span class="sd">    depth level for the top of elements. Only used for elements joining two</span>
<span class="sd">    levels (wells, arrows)</span>
<span class="sd">**use_height_map:** str (**3D maps**)</span>
<span class="sd">    When set on a corridor, block or wall layer, it replaces the constant</span>
<span class="sd">    **item_height** when extruding the height with a height map whose level is</span>
<span class="sd">    given by the value of this property.</span>
<span class="sd">**visibility:** str (**2D and 3D maps**)</span>
<span class="sd">    may be either: ``private``: alternative to ``private: true``, or a list of</span>
<span class="sd">    maps types (json-like), for which this layer is kept visible. If such a</span>
<span class="sd">    list is specified, then maps types not listed here will drop the layer.</span>
<span class="sd">    As ``visibility`` has now a broader meaning, it is better to specify</span>
<span class="sd">    ``private: true`` for private things, to avoid ambiguities.</span>
<span class="sd">**wall:** bool (**3D maps**)</span>
<span class="sd">    wall elements have only side walls (no floor or ceiling).</span>
<span class="sd">**well:** bool (**3D maps**)</span>
<span class="sd">    wells are replaced with custom elements, which type is the element label</span>
<span class="sd">    (PE, PS, PSh, échelle, sans, P ossements, ...). Well elements (or groups,</span>
<span class="sd">    or layers) shoud specify the level and upper_level.</span>
<span class="sd">**well_read_mode:** str (**3D maps**)</span>
<span class="sd">    tells if well elements should be read in the XML file as a single &quot;path&quot;</span>
<span class="sd">    element (a circle for instance), or a group (a grop containing a circle,</span>
<span class="sd">    and additional lines). Thus allowed values are ``path`` or ``group``.</span>
<span class="sd">**z_scale:** float or &quot;auto&quot; (**3D maps)</span>
<span class="sd">    Can be set **in the SVG metadtadata layer**. This scale factor applies to</span>
<span class="sd">    depths and heights in order to match x, y scalings which may be arbitraty.</span>
<span class="sd">    The default is 0.5 and is also arbitrary. If it is set to &quot;auto&quot;, then if</span>
<span class="sd">    **lambert93** coordinates are provied in the appropriate layer, the scale</span>
<span class="sd">    factor will be processed according to these &quot;true&quot; coordinates to match x</span>
<span class="sd">    and y scales.</span>

<span class="sd">.. _depth_maps:</span>

<span class="sd">Depth maps</span>
<span class="sd">----------</span>

<span class="sd">Depth maps are layers containing depth information, **and nothing else**.</span>

<span class="sd">Each depth information specifies the depth of a specifi point in the map. They can be specified in several ways:</span>

<span class="sd">* a *text element*: the position of the element (its center if the text is centered) will be used as the position. The text should specify a floating point number which is the depth at this position.</span>
<span class="sd">* a group containing a text element and a segment path: the text is a float number specifying the depth, and the segment (2 points, oriented from the text toward the application point) specifies where the depth applied: the end pont of the segment will be assigned the given depth.</span>
<span class="sd">* a rectangle: this was originally the way to specify depth, but it proved to be difficult to read and is thus obsolete. Prefer the two above methods. In 2 words, the min of the rectangle is the depth, and the position of the rectangle (its center) is the position. Well, better forget it.</span>


<span class="sd">.. _altitude_maps:</span>

<span class="sd">Altitude maps</span>
<span class="sd">-------------</span>

<span class="sd">Altitude maps can be built and used to shift all other depth maps, which are supposed to be relative to the surface ground altitude map (for now at least: we may change this later using an ``upper_level`` property in depth maps which could be any other map).</span>

<span class="sd">To work we require more information, because we need actual altitude maps, and a geolocalisation of the inkscape SVG file.</span>

<span class="sd">Geolocalisation of the SVG file</span>
<span class="sd">+++++++++++++++++++++++++++++++</span>

<span class="sd">The SVG file should contain a layer named ``lambert93`` which contains, as its name says it, world coordinates in the **Lambert 93 coordinates system**.</span>

<span class="sd">Coordinates can be spacified at any location of the map. At least 3 points are needed to estimate a transformation, but the more points are provided, the more precise the estimation will be. The coordinates transformation between the SVG positions and the Lambert93 coordinates will be estimated as a linear transformation fit to all SVG/Lambert 93 coortinates couples.</span>

<span class="sd">A Lambert93 point is specified in this ``lambert93`` layer as a group containing 2 objects:</span>

<span class="sd">* a text item with text being the 2 cooridinates separated by a coma, ex::</span>

<span class="sd">    652470.89,6858871.84</span>

<span class="sd">* a segment line (2 points, oriented) going from the text toward the application point on the map.</span>

<span class="sd">Lambert 93 positions can be found using https://www.geoportail.gouv.fr/carte: on the map, select &quot;tools&quot; on the right, and enable &quot;display coordinates&quot;. Then select for &quot;reference system&quot; the &quot;Lambert 93&quot; mode.</span>

<span class="sd">Altitude maps</span>
<span class="sd">+++++++++++++</span>

<span class="sd">Altitude maps can be retreived from BDAlti: https://geoservices.ign.fr/documentation/diffusion/telechargement-donnees-libres.html#bd-alti</span>

<span class="sd">Then maps have to be converted using tools in :mod:`catamap.altitude.bdalti`.</span>
<span class="sd">The ``altitude`` directory should be located in the same directory as the SVG map file.</span>

<span class="sd">Example</span>
<span class="sd">-------</span>

<span class="sd">See the map: :download:`example map &lt;static/example_map.svg&gt;`</span>
<span class="sd">The result in 2D is (left: original map, right: result):</span>

<span class="sd">.. image:: static/example_map.png</span>
<span class="sd">    :height: 400</span>

<span class="sd">.. image:: static/example_map_imprimable.jpg</span>
<span class="sd">    :height: 400</span>

<span class="sd">In 3D: `here &lt;_static/example_3d/index.html&gt;`_</span>

<span class="sd">See for instance how wells indications are enlarged in the &quot;printable&quot; 2D map, the inferior level is shifted to allow seing it when it is superimposed with the upper level, while they are still superposed in the 3D map.</span>


<span class="sd">.. _colorsets:</span>

<span class="sd">Colorsets</span>
<span class="sd">---------</span>

<span class="sd">Both 2D and 3D maps, while processed, may assign different colorsets to elements, if specified via the ``--color`` option. A colorset is a defined by a name. Each element, group, layer, or labelled element can be assigned a different color for each colorset. Colorsets are defined dynamically in the map SVG source file. XML elements having a ``alt_colors`` property can both define colorsets and assign colors.</span>

<span class="sd">A few &quot;hard-coded&quot; colorsets are expected to exist (even it it is not mandatory) and are used by default:</span>

<span class="sd">* 3D maps use by default the ``map_3d`` colorset.</span>
<span class="sd">* 2D maps using &quot;igc&quot; mode (with ICC maps overlayed) use the ``igc`` colorset.</span>

<span class="sd">Colorsets inheritance</span>
<span class="sd">+++++++++++++++++++++</span>

<span class="sd">Some colorsets may be slight variants to other existing ones. To avoid redefining every element color in the SVG file, it is possible to specify some &quot;colorset inheritances&quot;. This is done using the ``colorset_inheritance`` property in the ``metadata`` layer (a hidden layer made for SVG / inkscape). This property is a JSON dictionary, with a ``{&#39;child&#39;: &#39;parent&#39;}`` shape. The meaning is that a child inherits all its parent colors, and then can override some.</span>

<span class="sd">Colors specifications</span>
<span class="sd">+++++++++++++++++++++</span>

<span class="sd">An ``alt_colors`` property applies recursively to all its children. It is a JSON dictionary, whith the followin shape:</span>

<span class="sd">* primary keys are colorset names</span>
<span class="sd">* primary values are `color specs`</span>

<span class="sd">A `color spec` is normally also a dict, with the following shape:</span>

<span class="sd">* keys are like in SVG elements style, ``fg`` (foreground), ``bg`` (background), ``stroke-width``</span>
<span class="sd">* values are strings, either containing the RGBA color, or a float value for ``stroke-width``.</span>
<span class="sd">* colorsets used only in 3D may shunt the second level and specify directly a single RGBA color string as colorspec value.</span>

<span class="sd">Ex::</span>

<span class="sd">    {&quot;map_3d&quot;: &quot;#c0c0c0ff&quot;,</span>
<span class="sd">     &quot;igc&quot;: {&quot;bg&quot;: &quot;#ff0000ff&quot;},</span>
<span class="sd">     &quot;black&quot;: {&quot;fg&quot;: &quot;#ffffffff&quot;, &quot;bg&quot;: &quot;#c0606060ff&quot;, &quot;stroke-width&quot;: &quot;0.2&quot;}}</span>

<span class="sd">A ``label_alt_colors`` property has an additional upper level whick key is the element label, and the primary value is like the ``alt_colors`` dict::</span>

<span class="sd">    {&quot;repetiteur&quot;: {&quot;black&quot;: {&quot;bg&quot;: &quot;#c0c0c0ff&quot;}},</span>
<span class="sd">     &quot;marches&quot;: {&quot;black&quot;: {&quot;fg&quot;: &quot;#c0c0c0ff&quot;}}}</span>

<span class="sd">.. _markers:</span>

<span class="sd">Markers</span>
<span class="sd">-------</span>

<span class="sd">**Markers** are small marker objects pointing to external links, such as photographs, or sounds. When the user clicks on a marker, or sufficiently close to it in a given radius, it triggers a link to an external resource (an web URL).</span>

<span class="sd">Markers are recorded in dedicated layers in the SVG file. Such layer must have a ``marker`` property, which value is the type of markers in the layer. Currently two types of markers are handled: ``photos`` (links to photographs URLS) or ``sounds``.</span>

<span class="sd">Sounds are handled specificly using a media player inside the 3D map, whereas photographs are just web links, and may actually point to any web resource or page (web page, photo file, video, or anything).</span>

<span class="sd">A marker layer can have ``markers_base_url`` or ``radius`` properties, which respectively specify the base URL for all markers, and the max distance to the marker for which a user click will trigger the marker.</span>

<span class="sd">The layer contents are similar to depth layers: they are text objects, or groups containing a text object and a line object to make an arrow from the text to the marker exact location. The layer may not have other kind of groups, it is not recursive.</span>

<span class="sd">Items in the marker layer are thus text at specified locations. The text is the URL of the resource (sound, photo, ...) and is appended to the base URL above. If no ``markers_base_url`` is specified, the marker value (type) is used as a relative directory as base URL (``sounds/...`` or ``photos/...``).</span>

<span class="sd">Each item may get a specific ``radius`` property, which may overload the layer radius. If no radius is specified, a default is used (10., which would correspond to 10 m radisu, depending on the map scale).</span>

<span class="sd">If an item text has no file extension, ``.jpg`` will be appended by the server in a photos markers layer. This way the map source, in Inkscape, may display a very short, readable, indication, such as a single number: for instance, ``123`` will be replaced with ``photos/123.jpg``.</span>

<span class="sd">On the web server side, photos and sounds directory have to be created and contain the referenced files.</span>

<span class="sd">Markers text syntax</span>
<span class="sd">+++++++++++++++++++</span>

<span class="sd">Markers text may be a filename (which will be prefixed with the contents of the ``markers_base_url`` property, and possibly suffixed with ``.jpg``), or a list of such filenames::</span>

<span class="sd">    image1.jpg, video2.mp4, image3.jpg</span>

<span class="sd">or::</span>

<span class="sd">    image1, video2.mp4, image3</span>

<span class="sd">In addition to the &quot;direct URL&quot; mechanism above, it is also possible to specify, for each markers layer, a &quot;correspondance map&quot; file (using the ``markers_map`` property on the layer). This file will be read as a CSV file (with ``tab`` separators). Then texts in markers text in the SGV file will go through this map to get a &quot;final&quot; file name for the marker element. A given marker text can be found several times in the file, and then several files will be associated with the marker element. For instance if you use numbers for markers texts, ``1``, ``2``, ``3`` in the SVG map, a ``markers_map`` can specify final filenames such as::</span>

<span class="sd">    20220304_201758.jpg	1</span>
<span class="sd">    20220304_201802.jpg	2</span>
<span class="sd">    20220304_201804.jpg	1</span>
<span class="sd">    20220304_201815.jpg	3</span>
<span class="sd">    20220304_202652.jpg	2</span>
<span class="sd">    20220304_202810.jpg	1</span>

<span class="sd">will assign to marker ``1`` the files: ``20220304_201758.jpg``, ``20220304_201804.jpg``, ``20220304_202810.jpg``, and so on. Each of the file names will undergo the prefix/suffix transformations using ``markers_base_url`` etc.</span>


<span class="sd">map_to_meshes module</span>
<span class="sd">====================</span>

<span class="sd">This module is an extension of the :mod:`~catamap.svg_to_mesh` module and ist main class, :class:`~catamap.svg_to_mesh.SvgToMesh` for more specific purposes. This means the former is dedicated to generically read Inkscape files and convert elements to meshes, while the specialized classes here are dedicated to building catacombs maps.</span>

<span class="sd">:class:`~catamap.map_to_meshes.CataSvgToMesh` wiil build 3D maps meshes and objects</span>

<span class="sd">:class:`~catamap.map_to_meshes.CataMapTo2DMap` will build &quot;cleaner&quot; 2D maps (with some symbols replaced and enlarged, regions zooms and more, and export PDF and JPG versions.</span>


<span class="sd">map_to_meshes module API</span>
<span class="sd">------------------------</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="c1">#import anatomist.headless as ana</span>
<span class="c1">#a = ana.HeadlessAnatomist()</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">svg_to_mesh</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">.svg_to_mesh</span> <span class="kn">import</span> <span class="n">aims</span><span class="p">,</span> <span class="n">fake_aims</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Delaunay</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">xml.etree.cElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">distutils.spawn</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">time</span>  <span class="c1"># just for exec time stats</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
<span class="kn">import</span> <span class="nn">textwrap</span> <span class="k">as</span> <span class="nn">_textwrap</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">PIL.Image</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PIL</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># import bdalti module</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.altitude</span> <span class="kn">import</span> <span class="n">bdalti</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">bdalti</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">xml_help</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>

    <span class="k">pass</span>


<div class="viewcode-block" id="ItemProperties"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.ItemProperties">[docs]</a><span class="k">class</span> <span class="nc">ItemProperties</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    XML item properties structure, used by</span>
<span class="sd">    :class:`~catamap.map_to_meshes.CataSvgToMesh`. They represents properties</span>
<span class="sd">    read from the XML file elements.</span>

<span class="sd">    Properties match those documented in :class:`~catamap.map_to_meshes.xml_help`, except the ``height`` property which is named ``item_height`` in XML file elements (because ``height`` is already used in SVG).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">properties</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;eid&#39;</span><span class="p">,</span> <span class="s1">&#39;main_group&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_level&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span> <span class="s1">&#39;corridor&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;wall&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;arrow&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="s1">&#39;catflap&#39;</span><span class="p">,</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;depth_map&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;height_shift&#39;</span><span class="p">,</span> <span class="s1">&#39;border&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;alt_colors&#39;</span><span class="p">,</span> <span class="s1">&#39;label_alt_colors&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;well_read_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_interval&#39;</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;arrow_base_height_shift&#39;</span><span class="p">,</span> <span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;non_visibility&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;relative_to&#39;</span><span class="p">,</span> <span class="s1">&#39;inverse&#39;</span><span class="p">,</span> <span class="s1">&#39;use_height_map&#39;</span><span class="p">)</span>

    <span class="n">prop_types</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># will be initialized when used in get_typed_prop()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_properties</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inaccessible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corridor</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wall</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># self.wireframe = False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">well</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catflap</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_map</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height_shift</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrow_base_height_shift</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">border</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marker</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_colors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_alt_colors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">well_read_mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_interval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_visibility</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_to</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_height_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">))))</span>
        <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_typed_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">prop_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ItemProperties</span><span class="o">.</span><span class="n">prop_types</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;private&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;inaccessible&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;corridor&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;wall&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="c1"># &#39;wireframe&#39;: ItemProperties.is_true,</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;arrow&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;well&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;catflap&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;depth_map&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">float_value</span><span class="p">,</span>
                <span class="s1">&#39;height_shift&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">float_value</span><span class="p">,</span>
                <span class="s1">&#39;arrow_base_height_shift&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">float_value</span><span class="p">,</span>
                <span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">float_value</span><span class="p">,</span>
                <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
                <span class="s1">&#39;grid_interval&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">float_value</span><span class="p">,</span>
                <span class="s1">&#39;inverse&#39;</span><span class="p">:</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">type_f</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">prop_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_f</span> <span class="ow">is</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="n">prop</span><span class="p">:</span>
            <span class="c1"># speclal case which we should handle a better way...</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">type_f</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_true</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">float_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fill_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[],</span> <span class="n">set_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parents</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">parents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_properties</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># this one does not propagate to children</span>

        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eid</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">get_props</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_suffix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">eid</span> <span class="ow">and</span> <span class="n">props</span><span class="p">:</span>
                <span class="c1"># properties as layer name suffixes</span>
                <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">get_typed_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">eid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eid</span> <span class="o">=</span> <span class="n">eid</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid</span>

            <span class="c1"># properties tags</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_level&#39;</span><span class="p">,</span> <span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;well_read_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;grid_interval&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="s1">&#39;use_height_map&#39;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span>
                            <span class="n">ItemProperties</span><span class="o">.</span><span class="n">get_typed_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="c1"># alternative to &quot;private: true&quot;, using &quot;visibility: private&quot;</span>
            <span class="n">visibility</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;visibility&#39;</span><span class="p">)</span>
            <span class="c1">#if not visibility:</span>
                <span class="c1">#visibility = []</span>
            <span class="k">if</span> <span class="n">visibility</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">visibility</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
                    <span class="n">visibility</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">visibility</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="n">visibility</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;private&#39;</span> <span class="ow">in</span> <span class="n">visibility</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visibility</span> <span class="o">=</span> <span class="n">visibility</span>

            <span class="n">non_visibility</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;non_visibility&#39;</span><span class="p">)</span>
            <span class="c1">#if not non_visibility:</span>
                <span class="c1">#non_visibility = []</span>
            <span class="k">if</span> <span class="n">non_visibility</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">non_visibility</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
                    <span class="n">non_visibility</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">non_visibility</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">non_visibility</span> <span class="o">=</span> <span class="p">[</span><span class="n">non_visibility</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">non_visibility</span> <span class="o">=</span> <span class="n">non_visibility</span>

            <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;corridor&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;wall&#39;</span><span class="p">,</span> <span class="c1"># &#39;wireframe&#39;,</span>
                         <span class="s1">&#39;well&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;catflap&#39;</span><span class="p">,</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="s1">&#39;depth_map&#39;</span><span class="p">,</span> <span class="s1">&#39;arrow&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">):</span>
                <span class="c1"># + border ?</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_something</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="n">height_map</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height_map&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">height_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">height_map</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">height_map</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">height_map</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">depth_map</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">relative_to</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relative_to&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_map</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;depth_map&#39;</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">relative_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># exception: if a depth is relative to &quot;surface&quot; by default</span>
                <span class="n">relative_to</span> <span class="o">=</span> <span class="s1">&#39;surface&#39;</span>
            <span class="k">if</span> <span class="n">relative_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">relative_to</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
                    <span class="n">relative_to</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relative_to</span> <span class="o">=</span> <span class="n">relative_to</span>
            <span class="n">inverse</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inverse&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inverse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inverse</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">inverse</span><span class="p">)</span>
            <span class="c1"># if style is not None and style.get(&#39;display&#39;) == &#39;none&#39;:</span>
            <span class="c1">#     self.hidden = True</span>

            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span>  <span class="kc">True</span>

            <span class="c1"># label suffixes are an old, ambiguous, system. We must disable it</span>
            <span class="c1"># in some cases</span>
            <span class="n">use_suffix</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_map</span><span class="p">:</span>
                <span class="n">use_suffix</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">label</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">get_props</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">use_suffix</span><span class="o">=</span><span class="n">use_suffix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">and</span> <span class="n">props</span><span class="p">:</span>
                <span class="c1"># properties as layer name suffixes</span>
                <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">get_typed_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">label</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height_shift</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arrow_base_height_shift</span> \
                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_arrow_base_height_shift</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">set_defaults</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_level&#39;</span><span class="p">,</span> <span class="p">):</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">DefaultItemProperties</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>

            <span class="c1"># build main group (mesh object etc)</span>
            <span class="n">priv_str</span> <span class="o">=</span> <span class="s1">&#39;private&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="k">else</span> <span class="s1">&#39;public&#39;</span>
            <span class="n">access_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;inaccessible&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inaccessible</span>
                          <span class="k">else</span> <span class="s1">&#39;accessible&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no label for item:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;level None in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">priv_str</span><span class="p">,</span> <span class="n">access_str</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}&#39;</span>
                    <span class="s1">&#39;groupmode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;layer&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">label_alt_colors</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_alt_colors&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label_alt_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">label_alt_colors</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">label_alt_colors</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error reading JSON in label_alt_colors of&#39;</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span>
                          <span class="n">label</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;json code:&#39;</span><span class="p">,</span> <span class="n">label_alt_colors</span><span class="p">)</span>
                    <span class="k">raise</span>

            <span class="n">alt_colors</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alt_colors&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alt_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alt_colors</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">alt_colors</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error reading JSON in alt_colors of&#39;</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;json code:&#39;</span><span class="p">,</span> <span class="n">alt_colors</span><span class="p">)</span>
                    <span class="k">raise</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">well</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">well_read_mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">well_read_mode</span> <span class="o">=</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">well_read_modes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">well_read_mode</span> <span class="o">=</span> <span class="n">well_read_mode</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="ItemProperties.remove_word"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.ItemProperties.remove_word">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_word</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; remove word suffix to label (which may end with several</span>
<span class="sd">        variants, _word_0 etc)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">word</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">label</span>
        <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">word</span><span class="p">)</span> <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">word</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">label</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">_&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_&#39;</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">%</span> <span class="n">word</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_label_suffix</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">get_props</span><span class="p">,</span> <span class="n">use_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_props</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">use_suffix</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">layer_suffixes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_label</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">remove_word</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_label</span> <span class="o">!=</span> <span class="n">label</span> <span class="ow">and</span> <span class="n">get_props</span> <span class="ow">or</span> <span class="n">new_label</span> <span class="o">==</span> <span class="n">suffix</span><span class="p">:</span>
                    <span class="n">props</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">layers_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">suffix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">new_label</span>
        <span class="k">if</span> <span class="n">get_props</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">label</span><span class="p">,</span> <span class="n">props</span>
        <span class="k">return</span> <span class="n">label</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">get_props</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">remove_label_suffix</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">get_props</span><span class="p">,</span> <span class="n">use_suffix</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">get_props</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}id&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">remove_label_suffix</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">get_props</span><span class="p">,</span> <span class="n">use_suffix</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_corridor</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;corridor&#39;</span><span class="p">,</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">corridor_labels</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_block</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">block_labels</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_wall</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;wall&#39;</span><span class="p">,</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">wall_labels</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_hidden</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">hidden_labels</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_well</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">wells_labels</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_catflap</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;catflap&#39;</span><span class="p">,</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">catflap_labels</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_depth_map</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;depth_map&#39;</span><span class="p">,</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">depth_map_labels</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_border</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="s1">&#39;border&#39;</span><span class="p">,</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">border_labels</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_something</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_listed_element_type</span><span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">DefaultItemProperties</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_labels&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">,</span> <span class="p">()))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_listed_element_type</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">layers_list</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">layers_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># we don&#39;t know</span>

    <span class="k">def</span> <span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;item_height&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>

        <span class="k">for</span> <span class="n">etype</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">types_heights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">is_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_type</span><span class="p">:</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">h</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">heights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">h</span>

        <span class="k">return</span> <span class="n">height</span>

    <span class="k">def</span> <span class="nf">get_height_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="n">height_shift</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height_shift&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">height_shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">height_shift</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_shift</span>

        <span class="k">for</span> <span class="n">etype</span><span class="p">,</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">types_height_shifts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">is_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_type</span><span class="p">:</span>
                <span class="n">height_shift</span> <span class="o">=</span> <span class="n">shift</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">DefaultItemProperties</span><span class="o">.</span><span class="n">height_shifts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">height_shift</span> <span class="o">=</span> <span class="n">shift</span>

        <span class="k">return</span> <span class="n">height_shift</span>

    <span class="k">def</span> <span class="nf">get_arrow_base_height_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="n">height_shift</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arrow_base_height_shift&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">height_shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">height_shift</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_base_height_shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_base_height_shift</span>

        <span class="k">return</span> <span class="n">height_shift</span></div>


<div class="viewcode-block" id="DefaultItemProperties"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.DefaultItemProperties">[docs]</a><span class="k">class</span> <span class="nc">DefaultItemProperties</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Defaults and constant values.</span>

<span class="sd">    This is mainly a remaining of the v1 of the software, where fewer things</span>
<span class="sd">    were indicated in the SVG file, and the program was written originally for</span>
<span class="sd">    a single map (GRS, Paris 14e) with hard-coded labels.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ground_level</span> <span class="o">=</span> <span class="s1">&#39;surf&#39;</span>
    <span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;sup&#39;</span>
    <span class="n">upper_level</span> <span class="o">=</span> <span class="n">ground_level</span>

    <span class="c1"># layers containing these words are assigned corresponding properties</span>
    <span class="c1"># automatically</span>

    <span class="n">layer_suffixes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;inf&#39;</span><span class="p">:</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tech&#39;</span><span class="p">:</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gtech&#39;</span><span class="p">:</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GTech&#39;</span><span class="p">:</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;surf&#39;</span><span class="p">:</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;metro&#39;</span><span class="p">:</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;seine&#39;</span><span class="p">:</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;private&#39;</span><span class="p">:</span> <span class="s1">&#39;private&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inaccessibles&#39;</span><span class="p">:</span> <span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inaccessible&#39;</span><span class="p">:</span> <span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anciennes&#39;</span><span class="p">:</span> <span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">layers_aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GTech&#39;</span><span class="p">:</span> <span class="s1">&#39;tech&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gtech&#39;</span><span class="p">:</span> <span class="s1">&#39;tech&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inaccessibles&#39;</span><span class="p">:</span> <span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anciennes&#39;</span><span class="p">:</span> <span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># levels list</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;sup&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;esc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tech&#39;</span><span class="p">,</span>
        <span class="s1">&#39;surf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pe&#39;</span><span class="p">,</span>  <span class="c1"># ?</span>
        <span class="s1">&#39;metro&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># labels lists assigned with specific properties</span>

    <span class="n">corridor_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;galeries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;galeries big sud&#39;</span><span class="p">,</span>
        <span class="s1">&#39;piliers a bras&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inaccessible&#39;</span><span class="p">,</span>
        <span class="s1">&#39;galeries agrandissements&#39;</span><span class="p">,</span>
        <span class="s1">&#39;oss off&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anciennes galeries big&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aqueduc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;remblai epais&#39;</span><span class="p">,</span>
        <span class="s1">&#39;remblai leger&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ebauches&#39;</span><span class="p">,</span>
        <span class="s1">&#39;metro&#39;</span><span class="p">,</span>
        <span class="s1">&#39;esc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;escaliers&#39;</span><span class="p">,</span>
        <span class="s1">&#39;escaliers anciennes galeries big&#39;</span><span class="p">,</span>
        <span class="s1">&#39;galeries techniques&#39;</span><span class="p">,</span>
        <span class="s1">&#39;galeries techniques despe&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">block_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;calcaire 2010&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire ciel ouvert&#39;</span><span class="p">,</span>
        <span class="s1">&#39;calcaire masse2&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire masse&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire med&#39;</span><span class="p">,</span>
        <span class="s1">&#39;calcaire sup&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire vdg&#39;</span><span class="p">,</span>
        <span class="s1">&#39;piliers a bras&#39;</span><span class="p">,</span>
        <span class="s1">&#39;piliers&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maconneries&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;maçonneries&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;maçonneries anciennes galeries big&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hagues&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hagues effondrees&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cuves&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mur&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mur_ouvert&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bassin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bassin_recouvert&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rose&#39;</span><span class="p">,</span>
        <span class="s1">&#39;repetiteur&#39;</span><span class="p">,</span>
        <span class="s1">&#39;eau&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grille&#39;</span><span class="p">,</span>
        <span class="s1">&#39;porte&#39;</span><span class="p">,</span>
        <span class="s1">&#39;porte_ouverte&#39;</span><span class="p">,</span>
        <span class="s1">&#39;passage&#39;</span><span class="p">,</span> <span class="s1">&#39;grille-porte&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">wall_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;grilles&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">street_labels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;plaques rues&#39;</span><span class="p">,</span> <span class="p">}</span>

    <span class="n">symbol_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;symboles&#39;</span><span class="p">,</span>
        <span class="s1">&#39;marches&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stair_symbol&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">depth_map_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;profondeurs esc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profondeurs galeries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profondeurs&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">depth_map_names</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;profondeurs esc_esc_public_accessible&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profondeurs galeries_inf_public_accessible&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profondeurs galeries_sup_public_accessible&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profondeurs_metro_public_accessible&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;profondeurs_seine_public_accessible&#39;,</span>
        <span class="s1">&#39;profondeurs_tech_public_accessible&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;profondeurs surf&#39;,</span>
        <span class="c1"># &#39;profondeurs pe&#39;,</span>
    <span class="p">)</span>

    <span class="n">wells_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">u</span><span class="s1">&#39;échelle vers&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\xe9</span><span class="s1">chelle vers&#39;</span><span class="p">,</span> <span class="s1">&#39;PSh&#39;</span><span class="p">,</span> <span class="s1">&#39;PSh vers&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;PE anciennes galeries big&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PS&#39;</span><span class="p">,</span> <span class="s1">&#39;PS anciennes galeries big&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSh&#39;</span><span class="p">,</span> <span class="s1">&#39;PSh anciennes galeries big&#39;</span><span class="p">,</span>
        <span class="s1">&#39;P ossements&#39;</span><span class="p">,</span>
        <span class="s1">&#39;P ossements anciennes galeries big&#39;</span><span class="p">,</span>
        <span class="s1">&#39;echelle&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;échelle&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;échelle anciennes galeries big&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\xe9</span><span class="s1">chelle anciennes galeries big&#39;</span>
        <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\xe9</span><span class="s1">chelle&#39;</span>
        <span class="s1">&#39;sans&#39;</span><span class="p">,</span> <span class="s1">&#39;PS sans&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSh sans&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PS_sq&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">catflap_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;chatieres v3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chatieres private&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bas&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;injecté&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">hidden_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;indications_big_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;a_verifier&#39;</span><span class="p">,</span> <span class="s1">&#39;bord&#39;</span><span class="p">,</span> <span class="s1">&#39;bord_sud&#39;</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;légende_alt&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;découpage&#39;</span><span class="p">,</span> <span class="s1">&#39;raccords plan 2D&#39;</span><span class="p">,</span>
        <span class="s1">&#39;raccords 2D&#39;</span><span class="p">,</span>
        <span class="s1">&#39;masque vdg&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;masque cimetière&#39;</span><span class="p">,</span> <span class="s1">&#39;masque plage&#39;</span><span class="p">,</span>
        <span class="s1">&#39;agrandissement vdg&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;agrandissement cimetière&#39;</span><span class="p">,</span>
        <span class="s1">&#39;agrandissement plage&#39;</span><span class="p">,</span> <span class="s1">&#39;agrandissements fond&#39;</span><span class="p">,</span>
        <span class="s1">&#39;couleur_fond&#39;</span><span class="p">,</span> <span class="s1">&#39;couleur_fond sud&#39;</span><span class="p">,</span>
        <span class="s1">&#39;planches&#39;</span><span class="p">,</span> <span class="s1">&#39;planches fond&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire sup&#39;</span><span class="p">,</span>
        <span class="s1">&#39;calcaire limites&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire masse&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire masse2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lambert93&#39;</span><span class="p">,</span>
        <span class="c1">#&#39;légende&#39;,</span>
    <span class="p">}</span>
    <span class="n">hidden_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">depth_map_names</span><span class="p">)</span>

    <span class="n">types_height_shifts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;corridor&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
        <span class="s1">&#39;steet_sign&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">height_shifts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;aqueduc&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
        <span class="s1">&#39;fontis&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;lys&#39;</span><span class="p">:</span> <span class="mf">5.</span><span class="p">,</span>
        <span class="s1">&#39;grande_plaque&#39;</span><span class="p">:</span> <span class="mf">5.</span><span class="p">,</span>
        <span class="s1">&#39;chatieres v3&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;chatieres private&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;chatieres v3_inf&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;chatieres private_inf&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;injecté&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;bas&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;ossuaire&#39;</span><span class="p">:</span> <span class="mf">5.</span><span class="p">,</span>
        <span class="s1">&#39;stair_symbol&#39;</span><span class="p">:</span> <span class="mf">5.</span><span class="p">,</span>
        <span class="s1">&#39;etiage&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;etiage_water_tri&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;etiage_wall_tri&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;etiage_line&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;rose&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;remblai leger&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="s1">&#39;remblai epais&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;remblai leger_inf&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="s1">&#39;remblai epais_inf&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;remblai leger inaccessibles&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="s1">&#39;remblai epais inaccessibles&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;remblai leger inaccessibles_inf&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="s1">&#39;remblai epais inaccessibles_inf&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;calcaire 2010&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># this one as walls</span>
        <span class="s1">&#39;calcaire vdg&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># this one as walls</span>
        <span class="s1">&#39;PE&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
        <span class="s1">&#39;PE anciennes galeries big&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">9.</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">types_heights</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;corridor&#39;</span><span class="p">:</span> <span class="mf">2.</span><span class="p">,</span>
        <span class="s1">&#39;stair&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">heights</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;esc&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="s1">&#39;cuves&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;plaques rues&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;plaques rues volées&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;repetiteur&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="s1">&#39;bassin&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="s1">&#39;bassin_recouvert&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="s1">&#39;eau&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="s1">&#39;rose&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="s1">&#39;remblai leger&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
        <span class="s1">&#39;remblai epais&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;remblai leger_inf&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
        <span class="s1">&#39;remblai epais_inf&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;hagues effondrees&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
        <span class="s1">&#39;sans&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;PS sans&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;echelle&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;échelle&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="sa">u</span><span class="s1">&#39;échelle anciennes galeries big&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;PSh sans&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;PE&#39;</span><span class="p">:</span> <span class="mf">10.5</span><span class="p">,</span>
        <span class="s1">&#39;PE anciennes galeries big&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span>
        <span class="s1">&#39;mur&#39;</span><span class="p">:</span> <span class="mf">2.</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">well_read_modes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;PS&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PS galeries big&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PE&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PE galeries big&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;P ossements&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;P ossements galeries big&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSh&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSh galeries big&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSh vers&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;colim&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;échelle&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;échelle vers&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;échelle galeries big&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSh sans&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sans&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="CataSvgToMesh"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataSvgToMesh">[docs]</a><span class="k">class</span> <span class="nc">CataSvgToMesh</span><span class="p">(</span><span class="n">svg_to_mesh</span><span class="o">.</span><span class="n">SvgToMesh</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Process XML tree to build 3D meshes</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">proto_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">]])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concat_mesh</span><span class="o">=</span><span class="s1">&#39;list_bygroup&#39;</span><span class="p">,</span> <span class="n">skull_mesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CataSvgToMesh</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">concat_mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_maps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_meshes_def</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrenders</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skull_mesh</span> <span class="o">=</span> <span class="n">skull_mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">water_scale_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stair_symbol_mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fontis_mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lily_mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_sign_mesh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sounds_marker_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">photos_marker_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sounds_private</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">photos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">photos_private</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorset</span> <span class="o">=</span> <span class="s1">&#39;map_3d&#39;</span>  <span class="c1"># alt colors to translate to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorset_inheritance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span> <span class="o">=</span> <span class="s1">&#39;map_3d&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambert93_z_scaling</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">headless</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">anatomist</span> <span class="kn">import</span> <span class="n">headless</span> <span class="k">as</span> <span class="n">ana</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">ana</span><span class="o">.</span><span class="n">HeadlessAnatomist</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">headless</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">headless</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">anatomist.direct</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">ana</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">ana</span><span class="o">.</span><span class="n">Anatomist</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;anatomist is not available. It is needed &#39;</span>
                                   <span class="s1">&#39;for CataSvgToMesh to work.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="CataSvgToMesh.filter_element"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataSvgToMesh.filter_element">[docs]</a>    <span class="k">def</span> <span class="nf">filter_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_element</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">clean_return</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_group</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xml_element</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">is_group</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">clean_return</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_group</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props_stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;parse layer&#39;</span><span class="p">,</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
                    <span class="n">xml_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}metadata&#39;</span><span class="p">):</span>
                    <span class="n">z_scale</span> <span class="o">=</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z_scale&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">z_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">z_scale</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;Auto&#39;</span><span class="p">,</span> <span class="s1">&#39;AUTO&#39;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">lambert93_z_scaling</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;z_scale: based on Lambert93.&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lambert93_coords&#39;</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span> \
                                    <span class="o">=</span> <span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">slope</span><span class="p">)</span>
                                            <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">slope</span><span class="p">))</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;z_scale:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">z_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">z_scale</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span> <span class="o">=</span> <span class="n">z_scale</span>
                    <span class="n">colorset_inheritance</span> <span class="o">=</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;colorset_inheritance&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">colorset_inheritance</span><span class="p">:</span>
                        <span class="n">colorset_inheritance</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">colorset_inheritance</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">colorset_inheritance</span> <span class="o">=</span> <span class="n">colorset_inheritance</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;COLORSET INHERITANCE:&#39;</span><span class="p">,</span> <span class="n">colorset_inheritance</span><span class="p">)</span>

        <span class="n">item_props</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="p">()</span>
        <span class="n">item_props</span><span class="o">.</span><span class="n">fill_properties</span><span class="p">(</span><span class="n">xml_element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">props_stack</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props_stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explicitly_show</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_props</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">is_group</span><span class="p">:</span>
            <span class="c1"># maintain the stack of parent properties to allow inheritance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">props_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_props</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_maps</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># while reading depth indications layer, process things differently</span>
            <span class="k">if</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_depth_group</span><span class="p">,</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_depth_group</span><span class="p">]</span> <span class="o">+</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_depth_arrow</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_depth_text</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_depth_rect</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unknown depth child:&#39;</span><span class="p">,</span> <span class="n">xml_element</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noop</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span> <span class="o">=</span> <span class="n">item_props</span>
        <span class="c1"># keep this properties for the whole group (hope there are no</span>
        <span class="c1"># inconistencies)</span>
        <span class="k">if</span> <span class="n">item_props</span><span class="o">.</span><span class="n">main_group</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">item_props</span><span class="o">.</span><span class="n">main_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_props</span>
            <span class="c1"># print(item_props.main_group)</span>

        <span class="n">hidden</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">hidden</span>
                  <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">visibility</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                      <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">visibility</span><span class="p">)</span>
                  <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">non_visibility</span>
                      <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">non_visibility</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">main_group</span>

        <span class="k">if</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xml_element</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">title</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noop</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">item_props</span><span class="o">.</span><span class="n">label</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># depths are taken into account even when hidden (because they</span>
            <span class="c1"># are normally hidden in the svg file)</span>
            <span class="k">if</span> <span class="n">item_props</span><span class="o">.</span><span class="n">depth_map</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_depth_rect</span><span class="p">,</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_depth</span><span class="p">]</span> <span class="o">+</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item_props</span><span class="o">.</span><span class="n">marker</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MARKER:&#39;</span><span class="p">,</span> <span class="n">item_props</span><span class="o">.</span><span class="n">marker</span><span class="p">)</span>
                <span class="n">sname</span> <span class="o">=</span> <span class="n">item_props</span><span class="o">.</span><span class="n">marker</span>
                <span class="k">if</span> <span class="n">item_props</span><span class="o">.</span><span class="n">private</span><span class="p">:</span>
                    <span class="n">sname</span> <span class="o">+=</span> <span class="s1">&#39;_private&#39;</span>
                <span class="n">model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_marker_model&#39;</span> <span class="o">%</span> <span class="n">item_props</span><span class="o">.</span><span class="n">marker</span><span class="p">,</span>
                                <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photo_marker_model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_markers</span><span class="p">(</span><span class="n">xml_element</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">sname</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noop</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;lambert93&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_lambert93</span><span class="p">(</span><span class="n">xml_element</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noop</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hidden</span><span class="p">:</span>
            <span class="c1"># hidden layers are not rendered</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noop</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">item_props</span><span class="o">.</span><span class="n">well</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item_props</span><span class="o">.</span><span class="n">layer</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_well</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;etiage&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_water_scale</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;fontis&#39;</span><span class="p">,</span> <span class="s1">&#39;fontis_inf&#39;</span><span class="p">,</span> <span class="s1">&#39;fontis private&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;fontis private_inf&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_fontis</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;stair_symbol&#39;</span><span class="p">,</span> <span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_stair_symbol</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;arche&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_arch</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lys&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_lily</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;grande_plaque&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_large_sign</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;ossuaire&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_bones</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">clean_return</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_path</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">exit_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># print(&#39;leave group&#39;,</span>
        <span class="c1">#       self.props_stack[-1].main_group)</span>
        <span class="c1"># print(&#39;with properties:&#39;, self.item_props)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="CataSvgToMesh.read_path"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataSvgToMesh.read_path">[docs]</a>    <span class="k">def</span> <span class="nf">read_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_path</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;path with no group:&#39;</span><span class="p">,</span> <span class="n">xml_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">xml_path</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CataSvgToMesh</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">xml_path</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">arrow</span><span class="p">:</span>
            <span class="c1"># print(&#39;arrow&#39;)</span>
            <span class="n">vert</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
            <span class="n">nv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">xrange</span><span class="p">(</span><span class="n">nv</span><span class="p">):</span>
                <span class="n">vert</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">nv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1">## create mesh if it doesn&#39;t exist, and assign it arrow indices</span>
            <span class="c1">#gmesh = self.mesh_dict.setdefault(self.main_group,</span>
                                              <span class="c1">#aims.AimsTimeSurface(2))</span>
            <span class="c1">#if not hasattr(gmesh, &#39;arrow_indices&#39;):</span>
                <span class="c1">#gmesh.arrow_indices = []</span>
            <span class="c1">## keep track of each beginning of arrow object in a concatenated</span>
            <span class="c1">## mesh in order to postprocess arrow locations later</span>
            <span class="c1">#gmesh.arrow_indices.append(len(gmesh.vertex()))</span>
        <span class="k">return</span> <span class="n">mesh</span></div>


<div class="viewcode-block" id="CataSvgToMesh.read_paths"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataSvgToMesh.read_paths">[docs]</a>    <span class="k">def</span> <span class="nf">read_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="c1">#print(&#39;### read_paths&#39;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skull_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skull_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_skull_model</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">water_scale_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">water_scale_model</span> \
                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_water_scale_model</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fontis_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fontis_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_fontis_model</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stair_symbol_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stair_symbol_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_stair_symbol_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lily_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lily_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_lily_model</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_sign_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">large_sign_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_large_sign_model</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sounds_marker_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sounds_marker_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_sounds_marker_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">photos_marker_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">photos_marker_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_photos_marker_model</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CataSvgToMesh</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read_paths</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

        <span class="c1">#print(&#39;======= read_path done =======&#39;)</span>
        <span class="c1">#print(&#39;groups properties:&#39;, len(self.group_properties))</span>
        <span class="c1">#for k, v in self.group_properties.items():</span>
            <span class="c1">#print(k, &#39;:&#39;, v)</span>

        <span class="k">return</span> <span class="n">res</span></div>


    <span class="k">def</span> <span class="nf">text_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_item</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># add level information in text objects</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CataSvgToMesh</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">text_description</span><span class="p">(</span>
            <span class="n">xml_item</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">props</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>
            <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>
        <span class="k">return</span> <span class="n">desc</span>


    <span class="k">def</span> <span class="nf">read_well</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">well_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span>
        <span class="c1">#print(&#39;read_well&#39;, props)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">label</span>
        <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">well_read_mode</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_well_group</span><span class="p">(</span><span class="n">well_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">well_xml</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}path&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">well_xml</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1">#print(&#39;read_well path&#39;)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">well_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
        <span class="n">bmin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">bmax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bmin</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">bmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">bmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">bmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">((</span><span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bmax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">bmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mf">20.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
        <span class="n">wells_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">wells_spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
        <span class="c1">#print(&#39;well_type:&#39;, well_type, len(wells_spec))</span>

    <span class="k">def</span> <span class="nf">read_well_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stair_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">]</span>
        <span class="n">props</span><span class="o">.</span><span class="n">well</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">props</span><span class="o">.</span><span class="n">corridor</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">props</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">props</span><span class="o">.</span><span class="n">wall</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># we are looking for a group with a path child</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stair_xml</span><span class="p">[:])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1">#trans = self.get_transform(stair_xml, trans)</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">stair_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>

            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bmax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bmin</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">bmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">bmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">bmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">((</span><span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bmax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">bmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
            <span class="n">height</span> <span class="o">=</span> <span class="mf">20.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
            <span class="n">wells_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">wells_spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">read_bones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bones_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">bones_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span>
                                         <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="mf">0.</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="n">skull_mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skull_mesh</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">skull_mesh</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">skull_mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">skull_mesh</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;face_culling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>


    <span class="k">def</span> <span class="nf">read_fontis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fontis_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">fontis_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span>
                                         <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="mf">0.</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="n">fontis_mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fontis_mesh</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">fontis_mesh</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">fontis_mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fontis_mesh</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;face_culling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>

    <span class="k">def</span> <span class="nf">read_lily</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lily_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">lily_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span>
                                         <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="mf">0.</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="n">lily_mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lily_mesh</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">lily_mesh</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">lily_mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lily_mesh</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;face_culling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>


    <span class="k">def</span> <span class="nf">read_large_sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lily_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">lily_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span>
                                         <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="mf">0.</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lily_mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">large_sign_mesh</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mesh error:&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">large_sign_mesh</span><span class="p">),</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="p">)</span>
            <span class="k">return</span>
            <span class="c1">#raise</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">lily_mesh</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">lily_mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lily_mesh</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;face_culling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>


    <span class="k">def</span> <span class="nf">read_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">## don&#39;t apply transform, we will do it later on the mesh</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">]</span>
        <span class="n">props</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">arch_xml</span><span class="p">:</span>
            <span class="n">bboxc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bbox</span> <span class="o">=</span> <span class="n">bboxc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">bboxc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
                <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">bboxc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="mf">0.</span><span class="p">]</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">arch_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">arch_spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">center</span><span class="p">,</span> <span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">trans</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">read_water_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">]</span>
        <span class="n">props</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">ws_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="mf">4.</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mesh_id</span><span class="p">,</span> <span class="n">ws_model</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">water_scale_model</span><span class="p">):</span>
            <span class="n">ws_mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="n">ws_model</span><span class="p">)</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">ws_mesh</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">mesh_id</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ws_mesh</span><span class="p">)())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ws_model</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">mesh_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ws_mesh</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">read_stair_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">st_xml</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span>
                                         <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="mf">0.</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="n">stair_mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stair_symbol_mesh</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">stair_mesh</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">stair_mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stair_mesh</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;face_culling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>


    <span class="k">def</span> <span class="nf">make_psh_sq_well</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">faces</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="c1"># square well</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_psh_well</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">faces</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                  <span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">make_psh_well</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">faces</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                      <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">0.7</span>
        <span class="n">well</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">({</span>
            <span class="s1">&#39;point1&#39;</span><span class="p">:</span> <span class="n">p1</span><span class="p">,</span> <span class="s1">&#39;point2&#39;</span><span class="p">:</span> <span class="n">p2</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">r0</span><span class="p">,</span> <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="n">faces</span><span class="p">,</span>
            <span class="s1">&#39;smooth_tube&#39;</span><span class="p">:</span> <span class="n">smooth</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">rotate</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">()</span>
            <span class="n">rot</span><span class="o">.</span><span class="n">fromAxis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rotate</span><span class="p">)</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">tr</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">well</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">6.</span>
        <span class="n">hl</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">r0</span>
        <span class="n">nv0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="n">nv0</span>
        <span class="n">stair_step</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
        <span class="n">phb0</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">phb1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">phb2</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">phb3</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">phb5</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">phb4</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">phb7</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">phb6</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">zbari</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">stair_step</span><span class="p">)):</span>
            <span class="n">zbar</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">zbari</span> <span class="o">*</span> <span class="n">stair_step</span>
            <span class="n">ph0</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">phb0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phb0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">ph1</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">phb1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phb1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">ph2</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">phb2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phb2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">ph3</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">phb3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phb3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">ph4</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">phb4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phb4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">ph5</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">phb5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phb5</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">ph6</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">phb6</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phb6</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">ph7</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">phb7</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phb7</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>

            <span class="n">vert</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ph0</span><span class="p">,</span> <span class="n">ph1</span><span class="p">,</span> <span class="n">ph0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">hl</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">ph1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">hl</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                     <span class="n">ph2</span><span class="p">,</span> <span class="n">ph3</span><span class="p">,</span> <span class="n">ph2</span> <span class="o">+</span> <span class="p">(</span><span class="n">hl</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">ph3</span> <span class="o">+</span> <span class="p">(</span><span class="n">hl</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                     <span class="n">ph4</span><span class="p">,</span> <span class="n">ph5</span><span class="p">,</span> <span class="n">ph4</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">hl</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">ph5</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">hl</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                     <span class="n">ph6</span><span class="p">,</span> <span class="n">ph7</span><span class="p">,</span> <span class="n">ph6</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">hl</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">ph7</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">hl</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)]</span>
            <span class="n">poly</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">nv</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">nv</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
                     <span class="p">(</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span>
                     <span class="p">(</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span>
                     <span class="p">(</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)]</span>
            <span class="n">nv</span> <span class="o">+=</span> <span class="mi">16</span>
        <span class="n">norm</span> <span class="o">+=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span> <span class="o">-</span> <span class="n">nv0</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alt_color</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">.6</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
        <span class="n">well</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
                                     <span class="s1">&#39;face_culling&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">well</span>


    <span class="k">def</span> <span class="nf">make_ladder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">pole1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">pole2</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="mf">0.025</span>
        <span class="n">ladder</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">({</span>
            <span class="s1">&#39;point1&#39;</span><span class="p">:</span> <span class="n">pole1</span><span class="p">,</span>
            <span class="s1">&#39;point2&#39;</span><span class="p">:</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">r0</span><span class="p">,</span>
            <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">ladder2</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">({</span>
            <span class="s1">&#39;point1&#39;</span><span class="p">:</span> <span class="n">pole2</span><span class="p">,</span>
            <span class="s1">&#39;point2&#39;</span><span class="p">:</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">r0</span><span class="p">,</span>
            <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">ladder</span><span class="p">,</span> <span class="n">ladder2</span><span class="p">)</span>
        <span class="n">stair_step</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
        <span class="k">for</span> <span class="n">zbari</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">stair_step</span><span class="p">)):</span>
            <span class="n">zbar</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">zbari</span> <span class="o">*</span> <span class="n">stair_step</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">pole1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pole1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">pole2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pole2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zbar</span><span class="p">)</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">({</span>
                <span class="s1">&#39;point1&#39;</span><span class="p">:</span> <span class="n">b1</span><span class="p">,</span> <span class="s1">&#39;point2&#39;</span><span class="p">:</span> <span class="n">b2</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">r1</span><span class="p">,</span> <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">ladder</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alt_color</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">.6</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
        <span class="n">ladder</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">ladder</span>


    <span class="k">def</span> <span class="nf">make_spiral_stair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="n">well</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">({</span>
            <span class="s1">&#39;point1&#39;</span><span class="p">:</span> <span class="n">p1</span><span class="p">,</span> <span class="s1">&#39;point2&#39;</span><span class="p">:</span> <span class="n">p2</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">r0</span><span class="p">,</span> <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">6.</span>
        <span class="n">nv0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="n">nv0</span>
        <span class="n">stair_step</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">zbari</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">stair_step</span><span class="p">)):</span>
            <span class="n">zbar</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">zbari</span> <span class="o">*</span> <span class="n">stair_step</span>
            <span class="n">ph1</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="n">ph1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">zbar</span>
            <span class="n">ph0</span> <span class="o">=</span> <span class="n">ph1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stair_step</span><span class="p">)</span>
            <span class="n">ph2</span> <span class="o">=</span> <span class="n">ph0</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span>
                                               <span class="mf">0.</span><span class="p">)</span>
            <span class="n">ph3</span> <span class="o">=</span> <span class="n">ph2</span> <span class="o">+</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stair_step</span><span class="p">)</span>
            <span class="n">angle</span> <span class="o">+=</span> <span class="n">a</span>
            <span class="n">ph4</span> <span class="o">=</span> <span class="n">ph1</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span>
                                               <span class="mf">0.</span><span class="p">)</span>
            <span class="n">vert</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ph0</span><span class="p">,</span> <span class="n">ph1</span><span class="p">,</span> <span class="n">ph2</span><span class="p">,</span> <span class="n">ph3</span><span class="p">,</span> <span class="n">ph1</span><span class="p">,</span> <span class="n">ph3</span><span class="p">,</span> <span class="n">ph4</span><span class="p">]</span>
            <span class="n">poly</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">nv</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span>
                     <span class="p">(</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">nv</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)]</span>
            <span class="n">nv</span> <span class="o">+=</span> <span class="mi">7</span>
        <span class="n">well</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alt_color</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">.6</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
        <span class="n">well</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
                                     <span class="s1">&#39;face_culling&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">well</span>


    <span class="k">def</span> <span class="nf">make_ps_sq_well</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_ps_well</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span>
                                 <span class="n">faces</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>

<div class="viewcode-block" id="CataSvgToMesh.make_ps_well"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataSvgToMesh.make_ps_well">[docs]</a>    <span class="k">def</span> <span class="nf">make_ps_well</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span>
                     <span class="n">faces</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;PS or PE (blue), P ossements (yellow)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">well</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">({</span>
            <span class="s1">&#39;point1&#39;</span><span class="p">:</span> <span class="n">p1</span><span class="p">,</span> <span class="s1">&#39;point2&#39;</span><span class="p">:</span> <span class="n">p2</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">radius</span><span class="p">,</span> <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="n">faces</span><span class="p">,</span>
            <span class="s1">&#39;smooth_tube&#39;</span><span class="p">:</span> <span class="n">smooth</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">rotate</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">()</span>
            <span class="n">rot</span><span class="o">.</span><span class="n">fromAxis</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rotate</span><span class="p">)</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">tr</span> <span class="o">*</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">well</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alt_color</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">.6</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">well_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PE&#39;</span><span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">well_type</span> <span class="o">==</span> <span class="s1">&#39;PS&#39;</span> <span class="ow">or</span> <span class="n">well_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PS_&#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">well_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PS &#39;</span><span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">well_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;P ossements&#39;</span><span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
        <span class="n">well</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s1">&#39;face_culling&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">well</span></div>


    <span class="k">def</span> <span class="nf">make_well</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">well_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">well_type</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">label</span>
        <span class="k">if</span> <span class="n">well_type</span> <span class="o">==</span> <span class="s1">&#39;PS&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_ps_well</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="p">,</span>
                                     <span class="n">props</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">well_type</span> <span class="o">==</span> <span class="s1">&#39;PS_sq&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_ps_sq_well</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="p">,</span>
                                        <span class="n">props</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">well_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PSh&#39;</span><span class="p">,</span> <span class="s1">&#39;sans&#39;</span><span class="p">,</span> <span class="s1">&#39;PSh sans&#39;</span><span class="p">,</span> <span class="s1">&#39;PSh sans_sq&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_psh_well</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">well_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PSh_sq&#39;</span><span class="p">,</span> <span class="s1">&#39;sans_sq&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_psh_sq_well</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">well_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;echelle&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;échelle&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_ladder</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">well_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;colim&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_spiral_stair</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">well_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_sq&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_ps_sq_well</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="p">,</span>
                                        <span class="n">props</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_ps_well</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">make_arche</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius_and_trans</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># translate method name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_arch</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius_and_trans</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                              <span class="n">well_type</span><span class="o">=</span><span class="n">well_type</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius_and_trans</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">well_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">radius</span><span class="p">,</span> <span class="n">trans</span> <span class="o">=</span> <span class="n">radius_and_trans</span>
        <span class="c1"># get transform parent to children</span>
        <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">tmat</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tmat</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># mesh will be created in source space, apply its source space center</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">(</span><span class="n">tmat</span><span class="p">)</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span>
        <span class="n">center0</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># source scale</span>
        <span class="n">scl0</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">center0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="n">scl1</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">center0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="n">scl</span> <span class="o">=</span> <span class="p">(</span><span class="n">scl0</span> <span class="o">+</span> <span class="n">scl1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1">#print(&#39;arch:&#39;, center, &#39;, scl:&#39;, scl, scl0, scl1, &#39;, radius:&#39;, radius)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">scl</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">2.</span>   <span class="c1"># radius of the vault curve</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="c1"># radius of pillar stones</span>
        <span class="n">amax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">.35</span> <span class="c1"># max angle of the vault</span>
        <span class="n">zscl</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># Z scaling of the vault ellipse</span>
        <span class="n">wheight</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="c1"># straight wall height</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">amax</span> <span class="o">*</span> <span class="mf">0.98</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">center0</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wheight</span><span class="p">)</span>

        <span class="n">arch</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_3</span><span class="p">()</span>
        <span class="n">cyl</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">(</span><span class="n">c0</span> <span class="o">+</span> <span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">wheight</span><span class="p">),</span>
                                             <span class="n">c0</span> <span class="o">+</span> <span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">),</span>
                                             <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">cyl</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">amax</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="n">alpha2</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.07</span><span class="p">)</span> <span class="o">*</span> <span class="n">amax</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">+</span> <span class="p">(</span><span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">zscl</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">+</span> <span class="p">(</span><span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha2</span><span class="p">)</span> <span class="o">*</span> <span class="n">zscl</span><span class="p">)</span>
            <span class="n">cyl</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                                 <span class="kc">False</span><span class="p">)</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">cyl</span><span class="p">)</span>

        <span class="n">c0</span> <span class="o">=</span> <span class="n">center0</span> <span class="o">+</span> <span class="p">(</span><span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wheight</span><span class="p">)</span>
        <span class="n">cyl</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">(</span><span class="n">c0</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">wp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">wheight</span><span class="p">),</span>
                                             <span class="n">c0</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">wp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">),</span>
                                             <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">cyl</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">amax</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="n">alpha2</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.07</span><span class="p">)</span> <span class="o">*</span> <span class="n">amax</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">zscl</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha2</span><span class="p">)</span> <span class="o">*</span> <span class="n">zscl</span><span class="p">)</span>
            <span class="n">cyl</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cylinder</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                                 <span class="kc">False</span><span class="p">)</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">cyl</span><span class="p">)</span>

        <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">tmat</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tmat</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">tmat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">(</span><span class="n">tmat</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">tmat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">tmat2</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">center</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">(</span><span class="n">tmat2</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">arch</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">arch</span>

    <span class="k">def</span> <span class="nf">start_depth_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">level</span>
        <span class="n">mesh_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_meshes_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mesh_def</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: several depth meshes for level&#39;</span><span class="p">,</span>
                  <span class="n">level</span><span class="p">,</span> <span class="s1">&#39;, existing:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mesh_def</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;current:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="p">)</span>
            <span class="n">depth_mesh</span> <span class="o">=</span> <span class="n">mesh_def</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span>
                                                   <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_3</span><span class="p">())</span>
            <span class="n">depth_mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;face_culling&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_meshes_def</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="p">)</span>
        <span class="c1"># print(&#39;start_depth_rect&#39;, self.main_group, &#39;///&#39;, level)</span>
        <span class="c1"># print(&#39;level:&#39;, level)</span>
        <span class="c1"># print(self.item_props)</span>

    <span class="k">def</span> <span class="nf">clean_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_maps</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">read_depth_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;depth_group&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Nested depth group in main_group </span><span class="si">%s</span><span class="s1">, element: </span><span class="si">%s</span><span class="s1">, items: </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">child_xml</span><span class="p">),</span>
                   <span class="nb">repr</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">child_xml</span><span class="o">.</span><span class="n">items</span><span class="p">()))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_group</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="k">def</span> <span class="nf">clear_depth_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;depth_group&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;End of depth group outside of depth group. Current &#39;</span>
                <span class="s1">&#39;main_group: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">))</span>
        <span class="n">depth_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">depth_mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span><span class="p">))</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_group</span>


    <span class="k">def</span> <span class="nf">read_depth_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CataSvgToMesh</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">child_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_group</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;failed depth arrow, main_group:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">,</span>
                      <span class="s1">&#39;, vertices:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">read_depth_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">text_span</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">child_xml</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;tspan&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_span</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text_span</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in SVG, in depth text: found non-float value:&#39;</span><span class="p">,</span>
                      <span class="nb">repr</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="s1">&#39;in element:&#39;</span><span class="p">,</span> <span class="n">child_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
                      <span class="n">child_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">child_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;depth_group&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">depth_group</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">depth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># text outside a group: use its position</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">child_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">))</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">child_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in depth text position:&#39;</span><span class="p">,</span> <span class="n">child_xml</span><span class="p">,</span>
                          <span class="n">child_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">child_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">),</span>
                          <span class="s1">&#39;, in element:&#39;</span><span class="p">,</span> <span class="n">child_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
                    <span class="k">raise</span>
                <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">dot</span><span class="p">([[</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">depth_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">]</span>
                <span class="n">depth_mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">depth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">read_depth_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rect_xml</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span>  <span class="c1"># self.group_properties.get(self.main_group)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="o">.</span><span class="n">depth_map</span><span class="p">:</span>
            <span class="c1"># skip non-depth rects</span>
            <span class="k">return</span>
        <span class="n">depth_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rect_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rect_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">dot</span><span class="p">([[</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">rect_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)),</span>
                     <span class="nb">float</span><span class="p">(</span><span class="n">rect_xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))))</span> <span class="o">*</span> <span class="mf">10.</span>
        <span class="n">depth_mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">read_markers_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">csv</span>
        <span class="c1">#def _parse(item):</span>
            <span class="c1">#item = item.strip()</span>
            <span class="c1">#if &#39;&quot;&#39; not in item and &quot;&#39;&quot; not in item:</span>
                <span class="c1">#return [s.strip() for s in item.split(&#39; &#39;)]</span>
            <span class="c1">#q = item.find(&#39;&quot;&#39;)</span>
            <span class="c1">#if q &gt;= 0:</span>
                <span class="c1">#items = item.split(&#39;&quot;&#39;)</span>
            <span class="c1">#else:</span>
                <span class="c1">#items = item.split(&quot;&#39;&quot;)</span>
            <span class="c1">#parsed = []</span>
            <span class="c1">#i = 0</span>
            <span class="c1">#for item in items:</span>
              <span class="c1">#if i % 2 == 0:</span>
                  <span class="c1">#parsed += _parse(item)</span>
              <span class="c1">#else:</span>
                  <span class="c1">#parsed.append(item)</span>
              <span class="c1">#i += 1</span>
            <span class="c1">#return parsed</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mmap</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1">#for line in f.readlines():</span>
                    <span class="c1">#items = line.strip().split(&#39;\t&#39;)</span>
                    <span class="c1">#row = []</span>
                    <span class="c1">#for item in items:</span>
                        <span class="c1">#row += _parse(item)</span>

                <span class="n">dialect</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">Sniffer</span><span class="p">()</span><span class="o">.</span><span class="n">sniff</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1">#reader = csv.reader(f, delimiter=&#39;\t&#39;)</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># no \t separtator</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># still no split</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;marker without identifier:&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>  <span class="c1"># empty line</span>
                        <span class="n">mmap</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error reading markers map file:&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">mmap</span>

    <span class="k">def</span> <span class="nf">read_markers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">marker_model</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;READ&#39;</span><span class="p">,</span> <span class="n">mtype</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mtype</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="c1"># print(&#39;trans:&#39;, trans)</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;markers_base_url&#39;</span><span class="p">)</span>
        <span class="n">markers_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">markers_map_file</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;markers_map&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">markers_map_file</span><span class="p">:</span>
            <span class="n">markers_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_markers_map</span><span class="p">(</span><span class="n">markers_map_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="n">mtype</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

        <span class="n">layer_radius</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">layer_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layer_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">layer_radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer_radius</span> <span class="o">=</span> <span class="mf">10.</span>

        <span class="n">used_texts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missing_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">xml_element</span> <span class="ow">in</span> <span class="n">xml</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_props</span><span class="o">.</span><span class="n">level</span>
            <span class="n">text</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trans2</span> <span class="o">=</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
            <span class="n">trans_el</span> <span class="o">=</span> <span class="n">trans</span>
            <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">transm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">)</span>
                <span class="n">trans_el</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">*</span> <span class="n">transm</span>
            <span class="k">if</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span>
                <span class="n">xml_element</span> <span class="o">=</span> <span class="p">[</span><span class="n">xml_element</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sub_el</span> <span class="ow">in</span> <span class="n">xml_element</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">sub_el</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)),</span>
                                  <span class="nb">float</span><span class="p">(</span><span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))]</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_el</span><span class="p">[:])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sub_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> \
                                    <span class="ow">and</span> <span class="n">sub_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)),</span>
                                           <span class="nb">float</span><span class="p">(</span><span class="n">sub_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))]</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="s1">&#39;error while reading marker&#39;</span><span class="p">,</span>
                                        <span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
                                    <span class="k">raise</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="s1">&#39;error while reading marker&#39;</span><span class="p">,</span>
                                    <span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
                                <span class="k">raise</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">trans_el</span><span class="o">.</span><span class="n">dot</span><span class="p">([[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])[:</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">sub_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;marker with no text:&#39;</span><span class="p">,</span> <span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="n">sub_el</span><span class="p">)</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">sub_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
                    <span class="n">trans3</span> <span class="o">=</span> <span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
                    <span class="n">trans_el2</span> <span class="o">=</span> <span class="n">trans_el</span>
                    <span class="k">if</span> <span class="n">trans3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">transm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans3</span><span class="p">)</span>
                        <span class="n">trans_el2</span> <span class="o">=</span> <span class="n">trans_el</span> <span class="o">*</span> <span class="n">transm</span>
                    <span class="n">mesh</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CataSvgToMesh</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">sub_el</span><span class="p">,</span>
                                                                <span class="n">trans_el2</span><span class="p">,</span>
                                                                <span class="n">style</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;failed marker arrow in&#39;</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span>
                                  <span class="s1">&#39;, vertices:&#39;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()))</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">layer_radius</span>

            <span class="k">if</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">pos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>  <span class="c1"># list</span>
                    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
                    <span class="n">imlist</span> <span class="o">=</span> <span class="n">markers_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">imlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">markers_map</span><span class="p">:</span>
                            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">text</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
                        <span class="n">imlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span>
                    <span class="n">images</span> <span class="o">+=</span> <span class="n">imlist</span>
                    <span class="c1"># test existence of files</span>
                    <span class="c1"># warning: only works relative to current dir</span>
                    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">:</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="n">image</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                            <span class="n">missing_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">text</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
                    <span class="n">used_texts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pos</span> <span class="o">+</span> <span class="p">[</span><span class="n">level</span><span class="p">,</span> <span class="n">radius</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">base_url</span> <span class="o">+</span> <span class="n">image</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]])</span>
                <span class="c1"># print(&#39;%s:&#39; % mtype, markers[-1])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers</span><span class="p">),</span> <span class="n">mtype</span><span class="p">)</span>
        <span class="c1"># check and print duplicates</span>
        <span class="n">dup</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">used_texts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dup</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** Duplicate markers texts in layer&#39;</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="s1">&#39;: **&#39;</span><span class="p">)</span>
                    <span class="n">dup</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;marker:&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="s1">&#39;at positions:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    -&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** Missing correspondance for marker texts: **&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;at position:&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">missing_files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** Missing marker files: **&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing_files</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;at position:&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">read_lambert93</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;READ LAMBERT93&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">lambert_map</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xml_element</span> <span class="ow">in</span> <span class="n">xml</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;lambert93 element is not a group:&#39;</span><span class="p">,</span>
                                 <span class="n">xml_element</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trans2</span> <span class="o">=</span> <span class="n">xml_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
            <span class="n">trans_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">transm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">trans_el</span> <span class="o">=</span> <span class="n">transm</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trans_el</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">*</span> <span class="n">transm</span>
            <span class="k">for</span> <span class="n">sub_el</span> <span class="ow">in</span> <span class="n">xml_element</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">sub_el</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)),</span>
                               <span class="nb">float</span><span class="p">(</span><span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))]</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">sub_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
                    <span class="n">trans3</span> <span class="o">=</span> <span class="n">sub_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
                    <span class="n">trans_el2</span> <span class="o">=</span> <span class="n">trans_el</span>
                    <span class="k">if</span> <span class="n">trans3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">transm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans3</span><span class="p">)</span>
                        <span class="n">trans_el2</span> <span class="o">=</span> <span class="n">trans_el</span> <span class="o">*</span> <span class="n">transm</span>
                    <span class="n">mesh</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CataSvgToMesh</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">sub_el</span><span class="p">,</span>
                                                                <span class="n">trans_el2</span><span class="p">,</span>
                                                                <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;failed lambert93 arrow, vertices:&#39;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">lamb</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;incorrect lambert93 coordinates:&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">lambert_map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lamb</span><span class="p">]))</span>
                <span class="c1"># print(&#39;lambert93:&#39;, lambert_map[-1])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lambert93_coords</span> <span class="o">=</span> <span class="n">lambert_map</span>
        <span class="c1"># regress</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lambert_map</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lambert_map</span><span class="p">]</span>
        <span class="n">lamb_x</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lambert_map</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lambert_map</span><span class="p">]</span>
        <span class="n">lamb_y</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">class</span> <span class="nc">xy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span> <span class="o">=</span> <span class="n">xy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">lamb_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">lamb_y</span>
        <span class="c1"># print(&#39;Lambert93 slope:&#39;, lamb_x.slope, lamb_y.slope)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambert93_z_scaling</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span> \
                <span class="o">=</span> <span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">slope</span><span class="p">)</span>
                        <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">slope</span><span class="p">))</span>
            <span class="c1"># print(&#39;z_scale:&#39;, self.z_scale)</span>


    <span class="k">def</span> <span class="nf">change_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">dz</span><span class="p">):</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vert</span><span class="p">:</span>
            <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">delaunay</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()])</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">)</span>
        <span class="c1">#mesh.header()[&#39;material&#39;][&#39;face_culling&#39;] = 0</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build_depth_win</span><span class="p">(</span><span class="n">depth_mesh</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">object_win_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)):</span>
        <span class="n">headless</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">headless</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">anatomist.headless</span> <span class="k">as</span> <span class="nn">ana</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">ana</span><span class="o">.</span><span class="n">HeadlessAnatomist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">anatomist.api</span> <span class="k">as</span> <span class="nn">ana</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">ana</span><span class="o">.</span><span class="n">Anatomist</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">soma.qt_gui.qt_backend</span> <span class="kn">import</span> <span class="n">Qt</span>
        <span class="kn">import</span> <span class="nn">time</span>

        <span class="n">win</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">createWindow</span><span class="p">(</span><span class="s1">&#39;Axial&#39;</span><span class="p">)</span> <span class="c1">#, options={&#39;hidden&#39;: 1})</span>
        <span class="n">Qt</span><span class="o">.</span><span class="n">qApp</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">win</span><span class="o">.</span><span class="n">windowConfig</span><span class="p">(</span><span class="n">view_size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">cursor_visibility</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">Qt</span><span class="o">.</span><span class="n">qApp</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">Qt</span><span class="o">.</span><span class="n">qApp</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="n">admesh</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">toAObject</span><span class="p">(</span><span class="n">depth_mesh</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">releaseObject</span><span class="p">(</span><span class="n">admesh</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">qApp</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="n">win</span><span class="o">.</span><span class="n">addObjects</span><span class="p">(</span><span class="n">admesh</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">qApp</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">win</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">boundingMin</span><span class="p">()</span>
        <span class="n">bbmax</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">boundingMax</span><span class="p">()</span>
        <span class="n">bbsize</span> <span class="o">=</span> <span class="n">bbmax</span> <span class="o">-</span> <span class="n">bbmin</span>

        <span class="c1"># close up on center</span>
        <span class="n">tbbmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbmin</span> <span class="o">+</span> <span class="n">bbmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> \
            <span class="o">-</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">object_win_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">object_win_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tbbmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbmin</span> <span class="o">+</span> <span class="n">bbmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> \
            <span class="o">+</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">object_win_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">object_win_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tbbmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bbmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tbbmax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bbmax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">view</span><span class="o">.</span><span class="n">setExtrema</span><span class="p">(</span><span class="n">tbbmin</span><span class="p">,</span> <span class="n">tbbmax</span><span class="p">)</span>
        <span class="c1">#view.qglWidget().updateGL()</span>
        <span class="n">view</span><span class="o">.</span><span class="n">paintScene</span><span class="p">()</span>
        <span class="c1">#view.updateGL()</span>
        <span class="k">return</span> <span class="n">win</span><span class="p">,</span> <span class="n">admesh</span>


    <span class="k">def</span> <span class="nf">load_ground_altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground_img</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;load ground altitude image:&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">ground_img</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">alt_extr_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                                             <span class="s1">&#39;global.json&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;realding altidude extrema:&#39;</span><span class="p">,</span> <span class="n">alt_extr_filename</span><span class="p">)</span>
            <span class="n">alt_extr</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">alt_extr_filename</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;extrema:&#39;</span><span class="p">,</span> <span class="n">alt_extr</span><span class="p">)</span>

            <span class="n">scl_min</span> <span class="o">=</span> <span class="n">alt_extr</span><span class="p">[</span><span class="s1">&#39;scale_min&#39;</span><span class="p">]</span>
            <span class="n">scl_max</span> <span class="o">=</span> <span class="n">alt_extr</span><span class="p">[</span><span class="s1">&#39;scale_max&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no ground image&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Converter</span><span class="p">(</span><span class="n">intype</span><span class="o">=</span><span class="n">ground_img</span><span class="p">,</span> <span class="n">outtype</span><span class="o">=</span><span class="n">aims</span><span class="o">.</span><span class="n">Volume_FLOAT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground_img</span> \
            <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="n">ground_img</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">scl_max</span> <span class="o">-</span> <span class="n">scl_min</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span> <span class="o">+</span> <span class="n">scl_min</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svg</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">xml</span>
                  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
                     <span class="o">==</span> <span class="s1">&#39;altitude&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grp</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<div class="viewcode-block" id="CataSvgToMesh.load_ground_altitude_bdalti"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataSvgToMesh.load_ground_altitude_bdalti">[docs]</a>    <span class="k">def</span> <span class="nf">load_ground_altitude_bdalti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        filename:</span>
<span class="sd">            json map, to be used with the API module bdalti.py</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">bdalti</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning, bdalti module is not present&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bdalti_map</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bdalti_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning, BDAlti meta-map is not available, file </span><span class="si">%s</span><span class="s1"> &#39;</span>
                  <span class="s1">&#39;does not exist&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">ground_altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">use_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;bdalti_map&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lambert_coords&#39;</span><span class="p">):</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_altitude_bdalti</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_altitude_topomap</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_scale</span><span class="p">:</span>
            <span class="c1"># scale ground altitude the same way as depths in the map</span>
            <span class="n">alt</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
        <span class="k">return</span> <span class="n">alt</span>


    <span class="k">def</span> <span class="nf">ground_altitude_topomap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;alt_bounds&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span> <span class="ow">is</span> <span class="kc">None</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ground_img</span><span class="o">.</span><span class="n">getSizeX</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ground_img</span><span class="o">.</span><span class="n">getSizeY</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_img</span><span class="o">.</span><span class="n">getSizeX</span><span class="p">()</span> \
                <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_img</span><span class="o">.</span><span class="n">getSizeY</span><span class="p">():</span>
            <span class="k">return</span> <span class="mf">50.</span>  <span class="c1"># arbitrary</span>
        <span class="n">gray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_img</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gray</span>


    <span class="k">def</span> <span class="nf">ground_altitude_bdalti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">slope</span> \
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">intercept</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">slope</span> \
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambert_coords</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">intercept</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">bdalti</span><span class="o">.</span><span class="n">get_z</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bdalti_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bdalti_base</span><span class="p">,</span>
                         <span class="n">background_z</span><span class="o">=</span><span class="mf">50.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span>


    <span class="k">def</span> <span class="nf">add_ground_alt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># print(&#39;add_ground_alt on:&#39;, mesh)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_altitude</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">build_depth_wins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                         <span class="n">object_win_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_meshes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">todo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_meshes_def</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="n">level</span><span class="p">,</span> <span class="n">mesh_def</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;building depth map&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="n">depth_mesh</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">mesh_def</span>
            <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">relative_to</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    rel:&#39;</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">relative_to</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">relative_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                    <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">relative_to</span> <span class="o">!=</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">relative_to</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="p">:</span>
                    <span class="c1"># apply dependent map</span>
                    <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">inverse</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    height map&#39;</span><span class="p">)</span>
                        <span class="n">depth_mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">np</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    apply relative depth:&#39;</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">relative_to</span><span class="p">)</span>
                    <span class="n">dwin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">relative_to</span><span class="p">]</span>
                    <span class="n">view</span> <span class="o">=</span> <span class="n">dwin</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">vertex</span> <span class="ow">in</span> <span class="n">depth_mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
                        <span class="n">vertex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">vertex</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># depends on another map which has not been done</span>
                    <span class="c1"># WARNING: infinite loops are possible. TODO: Detect them</span>
                    <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">level</span><span class="p">,</span> <span class="p">(</span><span class="n">depth_mesh</span><span class="p">,</span> <span class="n">props</span><span class="p">)))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    delay depth map&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="s1">&#39;which depends on&#39;</span><span class="p">,</span>
                          <span class="n">props</span><span class="o">.</span><span class="n">relative_to</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="n">win</span><span class="p">,</span> <span class="n">amesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_depth_win</span><span class="p">(</span><span class="n">depth_mesh</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
                                              <span class="n">object_win_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth_meshes</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">amesh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">win</span>


    <span class="k">def</span> <span class="nf">release_depth_wins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_meshes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span>


    <span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">object_win_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># surface map</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_altitude</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="c1">#pt = objectPositionFromWindow(pos)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">()</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">cursorFromPosition</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">view</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
                   <span class="ow">or</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">view</span><span class="o">.</span><span class="n">height</span><span class="p">()):</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">tbbmin</span> <span class="o">=</span> <span class="n">pos</span> \
                <span class="o">-</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">object_win_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">object_win_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tbbmax</span> <span class="o">=</span> <span class="n">pos</span> \
                <span class="o">+</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">object_win_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">object_win_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">bbmin</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">boundingMin</span><span class="p">()</span>
            <span class="n">bbmax</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">boundingMax</span><span class="p">()</span>
            <span class="n">tbbmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bbmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">tbbmax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bbmax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">view</span><span class="o">.</span><span class="n">setExtrema</span><span class="p">(</span><span class="n">tbbmin</span><span class="p">,</span> <span class="n">tbbmax</span><span class="p">)</span>
            <span class="c1">#view.qglWidget().updateGL()</span>
            <span class="n">view</span><span class="o">.</span><span class="n">paintScene</span><span class="p">()</span>
            <span class="c1">##view.updateGL()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nrenders</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">cursorFromPosition</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">positionFromCursor</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">pt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1">#print(&#39;get_depth: point not found:&#39;, pos, pt)</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">get_alt_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">colorset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">get_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">colorset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colorset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorset</span>
        <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">colorset</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alt_color_s</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">colorset</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">colorset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorset_inheritance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colorset</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">get_bg</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bg&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bg</span><span class="p">:</span>
                <span class="n">bg</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fg&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">bg</span>
        <span class="k">return</span> <span class="n">col</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_alt_color_s</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">colorset</span><span class="o">=</span><span class="s1">&#39;map_3d&#39;</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">label_alt_colors</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">label_alt_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colorset</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="o">.</span><span class="n">alt_colors</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">alt_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colorset</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">convert_color</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">color</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span> <span class="o">/</span> <span class="mf">255.</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span>
                      <span class="nb">zip</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)]</span>
                <span class="c1">#print(&#39;alt color:&#39;, props.main_group, col)</span>
                <span class="k">return</span> <span class="n">col</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">color</span>

        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">conv</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">color</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">convert_color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">convert_color</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">color</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


    <span class="k">def</span> <span class="nf">apply_depths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrenders</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">object_win_size</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_depth_wins</span><span class="p">((</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">))</span>

        <span class="c1">#return  # FIXME</span>

        <span class="k">for</span> <span class="n">main_group</span><span class="p">,</span> <span class="n">mesh_l</span> <span class="ow">in</span> <span class="n">meshes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;skip group&#39;</span><span class="p">,</span> <span class="n">main_group</span><span class="p">,</span> <span class="s1">&#39;with no properties&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="n">props</span><span class="o">.</span><span class="n">depth_map</span> <span class="ow">or</span> <span class="n">props</span><span class="o">.</span><span class="n">arrow</span><span class="p">:</span>
                <span class="c1"># text and arrows will be done just after.</span>
                <span class="c1"># depth maps will not need it</span>
                <span class="k">continue</span>

            <span class="n">level</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">level</span>
            <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">win</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">win</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">view</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">not_ok</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">mesh_l</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processing corridor depth:&#39;</span><span class="p">,</span> <span class="n">main_group</span><span class="p">,</span> <span class="s1">&#39;(level:&#39;</span><span class="p">,</span>
                      <span class="n">level</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="n">alt_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alt_color</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>

                <span class="n">hshift</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">height_shift</span>
                          <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">height_shift</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh_l</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">mesh_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">mesh_l</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="n">mesh_l</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;vertex&#39;</span><span class="p">):</span>
                        <span class="c1"># not a mesh: skip it</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">alt_color</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
                            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">][</span><span class="s1">&#39;diffuse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_color</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">object_win_size</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">hshift</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;missed Z:&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="n">done</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">failed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;failed:&#39;</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="o">/</span> <span class="n">done</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;abnormal failure rate - &#39;</span>
                          <span class="s1">&#39;malfunction in 3D renderings ?&#39;</span><span class="p">)</span>
                        <span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># apply texts depths</span>
        <span class="n">text_zshift</span> <span class="o">=</span> <span class="mf">5.</span>
        <span class="k">for</span> <span class="n">main_group</span><span class="p">,</span> <span class="n">mesh_items</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">meshes</span><span class="p">):</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">props</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">text_item</span> <span class="ow">in</span> <span class="n">mesh_items</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">text_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="n">text_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">win</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">view</span> <span class="o">=</span> <span class="n">win</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
                        <span class="n">hshift</span> <span class="o">=</span> <span class="p">((</span><span class="n">props</span><span class="o">.</span><span class="n">height_shift</span>
                                   <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">height_shift</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">)</span>
                                  <span class="o">+</span> <span class="n">text_zshift</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">object_win_size</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">+</span> <span class="n">hshift</span> <span class="o">&gt;</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">hshift</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;built depths in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrenders</span><span class="p">,</span> <span class="s1">&#39;renderings&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">apply_arrow_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="n">alt_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alt_color</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alt_color</span><span class="p">:</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">][</span><span class="s1">&#39;diffuse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_color</span>

        <span class="n">arrow_type</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">label</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">level</span>
        <span class="n">tz_level</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">upper_level</span>
        <span class="n">hshift</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">height_shift</span>
        <span class="k">if</span> <span class="n">hshift</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hshift</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">hshift</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
        <span class="n">text_hshift</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">arrow_base_height_shift</span>
        <span class="k">if</span> <span class="n">text_hshift</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text_hshift</span> <span class="o">=</span> <span class="mf">4.</span>
        <span class="n">text_hshift</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
        <span class="n">text_win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tz_level</span><span class="p">)</span>
        <span class="n">object_win_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="n">hshift1</span> <span class="o">=</span> <span class="n">hshift</span> <span class="o">+</span> <span class="n">text_hshift</span>
        <span class="n">view</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">text_view</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">win</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">win</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">text_win</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text_view</span> <span class="o">=</span> <span class="n">text_win</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>

        <span class="c1"># print(&#39;ARROW DEPTH for&#39;, props)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">object_win_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">+=</span> <span class="n">hshift</span>
                <span class="n">old_z</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># old_z is a weight between text and z</span>
                <span class="n">text_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">text_view</span><span class="p">,</span> <span class="n">object_win_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">text_z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">text_z</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">text_z</span> <span class="o">+=</span> <span class="n">text_hshift</span>
                <span class="n">new_z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">old_z</span> <span class="o">+</span> <span class="n">text_z</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">old_z</span><span class="p">)</span>
                <span class="c1"># print(&#39;w:&#39;, old_z, &#39;, t: &#39;, text_z, &#39;, a:&#39;, z, &#39;:&#39;, new_z)</span>
                <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_z</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># warn ?</span>


    <span class="k">def</span> <span class="nf">build_wells_with_depths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshes</span><span class="p">):</span>

        <span class="n">views</span> <span class="o">=</span> <span class="p">{</span><span class="n">level</span><span class="p">:</span> <span class="n">win</span><span class="o">.</span><span class="n">view</span><span class="p">()</span> <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">main_group</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">meshes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="n">meshes</span><span class="p">[</span><span class="n">main_group</span><span class="p">]</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">specs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">stype</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">label</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;make_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stype</span><span class="p">):</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;make_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stype</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">props</span><span class="o">.</span><span class="n">well</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_well</span>
            <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">level</span>
                <span class="n">next_level</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">upper_level</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
                <span class="n">view_up</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">next_level</span><span class="p">)</span>

                <span class="n">wells</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">ws</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">traceback</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;= while processing&#39;</span><span class="p">,</span> <span class="n">main_group</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ws:&#39;</span><span class="p">,</span> <span class="n">ws</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;method:&#39;</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;specs:&#39;</span><span class="p">,</span> <span class="n">specs</span><span class="p">)</span>
                        <span class="k">raise</span>
                    <span class="n">c3</span> <span class="o">=</span> <span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>
                    <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">z0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">z0</span>
                    <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">view_up</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">z0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">height</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">-</span> <span class="n">z</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">height_shift</span>
                    <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">shift</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">pheight</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">height</span>
                    <span class="k">if</span> <span class="n">pheight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pheight</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">well</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span>
                                  <span class="n">z</span> <span class="o">+</span> <span class="n">shift</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span><span class="p">,</span>
                                  <span class="n">height</span> <span class="o">+</span> <span class="n">pheight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span><span class="p">,</span>
                                  <span class="n">well_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">props</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">wells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">wells</span> <span class="o">=</span> <span class="n">well</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">wells</span><span class="p">,</span> <span class="n">well</span><span class="p">)</span>
                <span class="n">meshes</span><span class="p">[</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_tri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wells</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_tri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>


    <span class="k">def</span> <span class="nf">tesselate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">anatomist.api</span> <span class="k">as</span> <span class="nn">ana</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ana</span><span class="o">.</span><span class="n">Anatomist</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">setUserLevel</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># needed to use tesselation fusion</span>
        <span class="n">orig_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="k">if</span> <span class="s1">&#39;transformation&#39;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="c1"># if the mesh has a 3D transformation, don&#39;t do that</span>
            <span class="n">flat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">flat</span><span class="p">:</span>
            <span class="c1"># tessalate at constant Z, then set back Z after tesselation</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
                <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">amesh</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">toAObject</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">releaseObject</span><span class="p">(</span><span class="n">amesh</span><span class="p">)</span>
        <span class="n">all_obj</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">getObjects</span><span class="p">()</span>
        <span class="n">atess</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">fusionObjects</span><span class="p">([</span><span class="n">amesh</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;TesselationMethod&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">atess</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot make tesselation object for:&#39;</span><span class="p">,</span> <span class="n">amesh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">atess_m</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">getObjects</span><span class="p">()</span>
                   <span class="k">if</span> <span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_obj</span> <span class="ow">and</span> <span class="n">o</span> <span class="o">!=</span> <span class="n">atess</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># force tesselating</span>
        <span class="n">atess</span><span class="o">.</span><span class="n">render</span><span class="p">([],</span> <span class="n">ana</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">ViewState</span><span class="p">())</span>
        <span class="n">tess</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">toAimsObject</span><span class="p">(</span><span class="n">atess_m</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flat</span><span class="p">:</span>
            <span class="c1">#print(&#39;tesselate flat. orig vert:&#39;, len(orig_pos), len(tess.vertex()))</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">ov</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">(),</span> <span class="n">orig_pos</span><span class="p">):</span>
                <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ov</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># find nearest vertex for tesselated</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tess</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># no tesselation</span>
        <span class="k">if</span> <span class="n">flat</span><span class="p">:</span>
            <span class="n">mvert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orig_pos</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tess</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">mvert</span> <span class="o">-</span> <span class="n">tv</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">tv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_pos</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">atess</span>
        <span class="k">del</span> <span class="n">atess_m</span>
        <span class="k">del</span> <span class="n">amesh</span>
        <span class="n">tess</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">())</span>
        <span class="k">if</span> <span class="s1">&#39;polygon_dimension&#39;</span> <span class="ow">in</span> <span class="n">tess</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">tess</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;polygon_dimension&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">in</span> <span class="n">tess</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">tess</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mat</span><span class="p">[</span><span class="s1">&#39;face_culling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">tess</span>


    <span class="k">def</span> <span class="nf">make_cat_flap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]):</span>
        <span class="k">def</span> <span class="nf">connected_meshes</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
            <span class="n">vert_mesh</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">polygon</span><span class="p">():</span>
                <span class="n">mesh1</span> <span class="o">=</span> <span class="n">vert_mesh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mesh2</span> <span class="o">=</span> <span class="n">vert_mesh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">mesh1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mesh2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># segment in new mesh</span>
                    <span class="n">mesh1</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">vert_mesh</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mesh1</span>
                    <span class="n">vert_mesh</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mesh1</span>
                <span class="k">elif</span> <span class="n">mesh1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># prepend to mesh2</span>
                    <span class="n">mesh2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">vert_mesh</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mesh2</span>
                <span class="k">elif</span> <span class="n">mesh2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># append to mesh1</span>
                    <span class="n">mesh1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">vert_mesh</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mesh1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># connect 2 meshes</span>
                    <span class="k">if</span> <span class="n">mesh1</span> <span class="ow">is</span> <span class="n">mesh2</span><span class="p">:</span>
                        <span class="c1"># loop</span>
                        <span class="c1"># print(&#39;mesh1 is mesh2&#39;)</span>
                        <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">mesh1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">mesh1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">continue</span>
                    <span class="n">mesh1</span> <span class="o">+=</span> <span class="n">mesh2</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh2</span><span class="p">:</span>
                        <span class="n">vert_mesh</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh1</span>
            <span class="c1"># check duplicates</span>
            <span class="n">meshes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">vert_mesh</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">meshes</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">m</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">meshes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">meshes</span>

        <span class="k">def</span> <span class="nf">slice_segment</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">xradius</span><span class="p">,</span>
                          <span class="n">zradius</span><span class="p">,</span> <span class="n">connected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prev_v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">next_v</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">shift_point</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span> <span class="n">sh_fac</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">p</span> \
                    <span class="o">+</span> <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shift_s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">shift_s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">shift_s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                       <span class="o">*</span> <span class="n">sh_fac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                    <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">shift_s</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="n">shift_s</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">shift_s</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> \
                       <span class="o">*</span> <span class="n">sh_fac</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">shift_s</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

            <span class="k">def</span> <span class="nf">section_vertices</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span> <span class="n">zdir</span><span class="p">,</span> <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span>
                                 <span class="n">sh_fac</span><span class="p">):</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">v0</span> <span class="o">-</span> <span class="n">xdir</span> <span class="o">*</span> <span class="n">xradius</span> <span class="o">-</span> <span class="n">zdir</span> <span class="o">*</span> <span class="n">zradius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">v0</span> <span class="o">-</span> <span class="n">xdir</span> <span class="o">*</span> <span class="n">xradius</span> <span class="o">+</span> <span class="n">zdir</span> <span class="o">*</span> <span class="n">zradius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">v0</span> <span class="o">-</span> <span class="n">xdir</span> <span class="o">*</span> <span class="n">xradius</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">zdir</span> <span class="o">*</span> <span class="n">zradius</span><span class="p">,</span>
                       <span class="n">v0</span> <span class="o">+</span> <span class="n">xdir</span> <span class="o">*</span> <span class="n">xradius</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">zdir</span> <span class="o">*</span> <span class="n">zradius</span><span class="p">,</span>
                       <span class="n">v0</span> <span class="o">+</span> <span class="n">xdir</span> <span class="o">*</span> <span class="n">xradius</span> <span class="o">+</span> <span class="n">zdir</span> <span class="o">*</span> <span class="n">zradius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">v0</span> <span class="o">+</span> <span class="n">xdir</span> <span class="o">*</span> <span class="n">xradius</span> <span class="o">-</span> <span class="n">zdir</span> <span class="o">*</span> <span class="n">zradius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">v0</span> <span class="o">+</span> <span class="n">xdir</span> <span class="o">*</span> <span class="n">xradius</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">zdir</span> <span class="o">*</span> <span class="n">zradius</span><span class="p">,</span>
                       <span class="n">v0</span> <span class="o">-</span> <span class="n">xdir</span> <span class="o">*</span> <span class="n">xradius</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">zdir</span> <span class="o">*</span> <span class="n">zradius</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">shift_point</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span> <span class="n">sh_fac</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">]</span>

            <span class="k">def</span> <span class="nf">add_prev_section_vertices</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">connected</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span>
                                          <span class="n">zdir</span><span class="p">,</span> <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span>
                                          <span class="n">sh_fac</span><span class="p">):</span>
                <span class="n">vert</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">[</span><span class="n">alt</span><span class="p">]</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">connected</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">alt</span><span class="p">]</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">vert</span> <span class="o">+=</span> <span class="n">section_vertices</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span> <span class="n">zdir</span><span class="p">,</span> <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span>
                                             <span class="n">shift_s</span><span class="p">,</span> <span class="n">sh_fac</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vert</span> <span class="o">+=</span> <span class="n">mesh</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">alt</span><span class="p">]</span><span class="o">.</span><span class="n">vertex</span><span class="p">()[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>

            <span class="k">def</span> <span class="nf">section_polygons</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="p">[((</span><span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">8</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">8</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">8</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
                <span class="c1">#poly = [((n+i+8, n+i, n+8+(i+1)%8),</span>
                         <span class="c1">#(n+8+(i+1)%8, n+i, n+(i+1)%8))</span>
                        <span class="c1">#for i in range(8)]</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">poly</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dp</span><span class="p">]</span>

            <span class="k">def</span> <span class="nf">build_shift</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">prev_v</span><span class="p">,</span> <span class="n">direc</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">prev_v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="n">prev_direc</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">-</span> <span class="n">prev_v</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                <span class="n">diff_axis</span> <span class="o">=</span> <span class="n">prev_direc</span><span class="o">.</span><span class="n">crossed</span><span class="p">(</span><span class="n">direc</span><span class="p">)</span> <span class="c1"># rotation axis</span>
                <span class="k">if</span> <span class="n">diff_axis</span><span class="o">.</span><span class="n">norm2</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">diff_plane</span> <span class="o">=</span> <span class="n">direc</span><span class="o">.</span><span class="n">crossed</span><span class="p">(</span><span class="n">diff_axis</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                    <span class="n">diff_offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff_plane</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">diff_axis</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">diff_axis</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="mf">0.95</span>
                    <span class="n">diff_angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">diff_depth</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">diff_angle</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="n">shift_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_plane</span><span class="p">,</span> <span class="n">diff_offset</span><span class="p">,</span> <span class="o">-</span><span class="n">diff_depth</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">shift_s</span>

            <span class="k">def</span> <span class="nf">build_shift2</span><span class="p">(</span><span class="n">next_v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">direc</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">next_v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="n">next_direc</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_v</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                <span class="n">diff_axis</span> <span class="o">=</span> <span class="n">direc</span><span class="o">.</span><span class="n">crossed</span><span class="p">(</span><span class="n">next_direc</span><span class="p">)</span> <span class="c1"># rotation axis</span>
                <span class="k">if</span> <span class="n">diff_axis</span><span class="o">.</span><span class="n">norm2</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">diff_plane</span> <span class="o">=</span> <span class="n">direc</span><span class="o">.</span><span class="n">crossed</span><span class="p">(</span><span class="n">diff_axis</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                    <span class="n">diff_offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff_plane</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">diff_axis</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">diff_axis</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="mf">0.95</span>
                    <span class="n">diff_angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">diff_depth</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">diff_angle</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="n">shift_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_plane</span><span class="p">,</span> <span class="n">diff_offset</span><span class="p">,</span> <span class="n">diff_depth</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">shift_s</span>

            <span class="n">direc</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v0</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
            <span class="n">mlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># zero length segment: nothing to do.</span>
                <span class="k">return</span> <span class="n">alt</span><span class="p">,</span> <span class="n">offset</span>

            <span class="c1"># section plane</span>
            <span class="n">xdir</span> <span class="o">=</span> <span class="n">direc</span><span class="o">.</span><span class="n">crossed</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">xdir</span><span class="o">.</span><span class="n">norm2</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xdir</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">zdir</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zdir</span> <span class="o">=</span> <span class="n">xdir</span><span class="o">.</span><span class="n">crossed</span><span class="p">(</span><span class="n">direc</span><span class="p">)</span>

            <span class="n">prev_shift_s</span> <span class="o">=</span> <span class="n">build_shift</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">prev_v</span><span class="p">,</span> <span class="n">direc</span><span class="p">)</span>
            <span class="c1">#next_v = None</span>
            <span class="n">next_shift_s</span> <span class="o">=</span> <span class="n">build_shift2</span><span class="p">(</span><span class="n">next_v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">direc</span><span class="p">)</span>
            <span class="n">shift_s</span> <span class="o">=</span> <span class="n">prev_shift_s</span> <span class="o">+</span> <span class="n">next_shift_s</span> <span class="o">+</span> <span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">vert</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">]</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">]</span>

            <span class="c1">## DEBUG</span>
            <span class="c1">#n = vert[0].size()</span>
            <span class="c1">#vert[0] += [v, v + shift_s[3]* 2, v + direc]</span>
            <span class="c1">#poly[0] += [(n, n+1, n+2)]</span>
            <span class="c1">#n = vert[1].size()</span>
            <span class="c1">#if next_v:</span>
                <span class="c1">#prev_direc = (next_v - v).normalize()</span>
                <span class="c1">#vert[1] += [v, v+shift_s[3]* 1.5, v0 + prev_direc*0.6]</span>
                <span class="c1">#poly[1] += [(n, n+1, n+2)]</span>

            <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">slen</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mlen</span><span class="p">))</span>
                <span class="n">add_prev_section_vertices</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span>
                                          <span class="n">zdir</span><span class="p">,</span> <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span>
                                          <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">sfac</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">mlen</span>
                <span class="n">vert</span><span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">section_vertices</span><span class="p">(</span><span class="n">v0</span> <span class="o">+</span> <span class="n">direc</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span> <span class="n">zdir</span><span class="p">,</span>
                                              <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span>
                                              <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">sfac</span><span class="p">,</span> <span class="n">sfac</span><span class="p">))</span>
                <span class="n">poly</span><span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">section_polygons</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">[</span><span class="n">alt</span><span class="p">])</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">mlen</span><span class="p">:</span>
                    <span class="n">alt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alt</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mlen</span> <span class="o">-</span> <span class="n">slen</span><span class="p">,</span> <span class="n">slen</span><span class="p">):</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">slen</span><span class="p">,</span> <span class="n">mlen</span><span class="p">)</span>
                <span class="n">sfac</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">mlen</span>
                <span class="n">add_prev_section_vertices</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">connected</span><span class="p">,</span>
                                          <span class="n">v0</span> <span class="o">+</span> <span class="n">direc</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span> <span class="n">zdir</span><span class="p">,</span> <span class="n">xradius</span><span class="p">,</span>
                                          <span class="n">zradius</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">sfac</span><span class="p">,</span> <span class="n">sfac</span><span class="p">))</span>
                <span class="n">sfac</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">/</span> <span class="n">mlen</span>
                <span class="n">vert</span><span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">section_vertices</span><span class="p">(</span><span class="n">v0</span> <span class="o">+</span> <span class="n">direc</span> <span class="o">*</span> <span class="n">x2</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span> <span class="n">zdir</span><span class="p">,</span>
                                              <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span>
                                              <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">sfac</span><span class="p">,</span> <span class="n">sfac</span><span class="p">))</span>
                <span class="n">poly</span><span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">section_polygons</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">[</span><span class="n">alt</span><span class="p">])</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">x2</span> <span class="o">&lt;=</span> <span class="n">mlen</span><span class="p">:</span>
                    <span class="n">alt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alt</span>
            <span class="k">if</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">mlen</span><span class="p">:</span>
                <span class="n">sfac</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">/</span> <span class="n">mlen</span>
                <span class="n">add_prev_section_vertices</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">connected</span><span class="p">,</span>
                                          <span class="n">v0</span> <span class="o">+</span> <span class="n">direc</span> <span class="o">*</span> <span class="n">x2</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span> <span class="n">zdir</span><span class="p">,</span>
                                          <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span>
                                          <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">sfac</span><span class="p">,</span> <span class="n">sfac</span><span class="p">))</span>
                <span class="n">vert</span><span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">section_vertices</span><span class="p">(</span><span class="n">v0</span> <span class="o">+</span> <span class="n">direc</span> <span class="o">*</span> <span class="n">mlen</span><span class="p">,</span> <span class="n">xdir</span><span class="p">,</span> <span class="n">zdir</span><span class="p">,</span>
                                              <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span> <span class="n">shift_s</span><span class="p">,</span>
                                              <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
                <span class="n">poly</span><span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">section_polygons</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">[</span><span class="n">alt</span><span class="p">])</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">mlen</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">mlen</span><span class="p">)</span> <span class="o">/</span> <span class="n">slen</span><span class="p">)</span> <span class="o">*</span> <span class="n">slen</span>
            <span class="k">return</span> <span class="n">alt</span><span class="p">,</span> <span class="n">offset</span>

        <span class="n">slen</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># length of zebra item</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">color</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]]</span> <span class="c1"># alterning colors</span>
        <span class="n">xradius</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="n">zradius</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">meshes</span> <span class="o">=</span> <span class="n">connected_meshes</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
        <span class="n">smesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">aims</span><span class="o">.</span><span class="n">AimsSurfaceTriangle</span><span class="p">(),</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsSurfaceTriangle</span><span class="p">()]</span>
        <span class="n">smesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="n">smesh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
        <span class="n">alt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sub_mesh</span> <span class="ow">in</span> <span class="n">meshes</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">prev_v</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1">#smesh = [aims.AimsSurfaceTriangle(), aims.AimsSurfaceTriangle()]</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">vert</span><span class="p">[</span><span class="n">sub_mesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_mesh</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_mesh</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">vert</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">next_v</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">next_v</span> <span class="o">=</span> <span class="n">vert</span><span class="p">[</span><span class="n">sub_mesh</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span>
                <span class="n">alt</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">slice_segment</span><span class="p">(</span><span class="n">smesh</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                            <span class="n">slen</span><span class="p">,</span> <span class="n">xradius</span><span class="p">,</span> <span class="n">zradius</span><span class="p">,</span> <span class="n">connected</span><span class="p">,</span>
                                            <span class="n">prev_v</span><span class="p">,</span> <span class="n">next_v</span><span class="p">)</span>
                <span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">prev_v</span> <span class="o">=</span> <span class="n">v0</span>
                <span class="n">v0</span> <span class="o">=</span> <span class="n">v1</span>

        <span class="n">smesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">smesh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">smesh</span>


    <span class="k">def</span> <span class="nf">recolor_text_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_specs</span><span class="p">,</span> <span class="n">diffuse</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tospec</span> <span class="ow">in</span> <span class="n">text_specs</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">tspec</span> <span class="ow">in</span> <span class="n">tospec</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]:</span>
                <span class="n">props</span> <span class="o">=</span> <span class="n">tspec</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">material</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;material&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">material</span><span class="p">[</span><span class="s1">&#39;diffuse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diffuse</span>


    <span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshes</span><span class="p">):</span>
        <span class="c1"># lighen texts for black background</span>
        <span class="n">tspec</span> <span class="o">=</span> <span class="n">meshes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;annotations_text&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recolor_text_specs</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="p">[</span><span class="mf">.8</span><span class="p">,</span> <span class="mf">.8</span><span class="p">,</span> <span class="mf">.8</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
        <span class="n">tspec</span> <span class="o">=</span> <span class="n">meshes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rues sans plaques_text&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recolor_text_specs</span><span class="p">(</span><span class="n">tspec</span><span class="p">,</span> <span class="p">[</span><span class="mf">.6</span><span class="p">,</span> <span class="mf">.6</span><span class="p">,</span> <span class="mf">.6</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

        <span class="c1"># move arrows in order to follow text in 3D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attach_arrows_to_text</span><span class="p">(</span><span class="n">meshes</span><span class="p">,</span> <span class="n">with_squares</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># get ground altitude map</span>
        <span class="c1">#self.load_ground_altitude(</span>
            <span class="c1">#os.path.join(os.path.dirname(self.svg_filename),</span>
                         <span class="c1">#&#39;altitude&#39;, &#39;real&#39;, &#39;alt_image.png&#39;))</span>
        <span class="n">bdalti_map</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">svg_filename</span><span class="p">),</span>
            <span class="s1">&#39;altitude&#39;</span><span class="p">,</span> <span class="s1">&#39;BDALTIV2_2-0_75M_ASC_LAMB93-IGN69_FRANCE_2020-04-28&#39;</span><span class="p">,</span>
            <span class="s1">&#39;BDALTIV2&#39;</span><span class="p">,</span> <span class="s1">&#39;map.json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_ground_altitude_bdalti</span><span class="p">(</span><span class="n">bdalti_map</span><span class="p">)</span>

        <span class="c1"># make depth maps</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">mesh_def</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_meshes_def</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mesh</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">mesh_def</span>
            <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">relative_to</span> <span class="o">==</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;add ground alt on:&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_ground_alt</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delaunay</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

        <span class="n">meshes</span><span class="p">[</span><span class="s1">&#39;grille surface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_ground_grid</span><span class="p">()</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="p">()</span>
        <span class="n">props</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;surf&#39;</span>
        <span class="n">props</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;Surface&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="s1">&#39;grille surface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>

        <span class="c1"># apply depths to corridors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_depths</span><span class="p">(</span><span class="n">meshes</span><span class="p">)</span>

        <span class="c1"># build wells with inf/sup depths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_wells_with_depths</span><span class="p">(</span><span class="n">meshes</span><span class="p">)</span>

        <span class="c1"># apply real depths to arrows</span>
        <span class="k">for</span> <span class="n">main_group</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">meshes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">props</span><span class="o">.</span><span class="n">arrow</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mesh_l</span> <span class="o">=</span> <span class="n">meshes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mesh_l</span><span class="p">:</span>
                <span class="n">contine</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh_l</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">mesh_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">mesh_l</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="n">mesh_l</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply_arrow_depth</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
                    <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> \
                        <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">][</span><span class="s1">&#39;line_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span>

        <span class="c1"># extrude corridors walls</span>
        <span class="k">for</span> <span class="n">main_group</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">meshes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># here we iterate through list(keys) instead of using items()</span>
            <span class="c1"># because some processings will insert new meshes in meshes,</span>
            <span class="c1"># and this would make the iteration fail</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># print(props)</span>
            <span class="n">mesh_l</span> <span class="o">=</span> <span class="n">meshes</span><span class="p">[</span><span class="n">main_group</span><span class="p">]</span>
            <span class="n">height_map</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">use_height_map</span>
            <span class="k">if</span> <span class="n">mesh_l</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">corridor</span> <span class="ow">or</span> <span class="n">props</span><span class="o">.</span><span class="n">block</span> <span class="ow">or</span> <span class="n">props</span><span class="o">.</span><span class="n">wall</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;extrude:&#39;</span><span class="p">,</span> <span class="n">main_group</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">corridor</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">block</span><span class="p">,</span>
                      <span class="n">height_map</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh_l</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">mesh_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">mesh_l</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="n">mesh_l</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;vertex&#39;</span><span class="p">):</span>
                        <span class="c1"># not a mesh</span>
                        <span class="k">continue</span>
                    <span class="n">height</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_scale</span>
                    <span class="n">ceil</span><span class="p">,</span> <span class="n">wall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrude</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">height_map</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ceil</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
                        <span class="n">ceil</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> \
                            <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
                    <span class="k">elif</span> <span class="s1">&#39;diffuse&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ceil</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]:</span>
                        <span class="n">ceil</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">][</span><span class="s1">&#39;diffuse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span>
                                                                <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ceil</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">][</span><span class="s1">&#39;diffuse&#39;</span><span class="p">])</span>
                        <span class="n">intensity</span> \
                            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">intensity</span> <span class="o">&lt;=</span> <span class="mf">0.75</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                                <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.4</span>
                                <span class="c1">#if c &gt; 1.:</span>
                                    <span class="c1">#c = 1.</span>
                                <span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                                    <span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">m</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                                <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.4</span>
                                <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
                                    <span class="n">c</span> <span class="o">=</span> <span class="mf">0.</span>
                                <span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                        <span class="n">ceil</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">][</span><span class="s1">&#39;diffuse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                    <span class="n">meshes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_wall&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wall</span><span class="p">)</span>
                    <span class="n">meshes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_ceil&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ceil</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_wall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_ceil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_floor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>

                    <span class="c1"># build floor or ceiling meshes using tesselated objects</span>
                    <span class="c1"># (anatomist)</span>
                    <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>
                        <span class="c1"># &quot;blocks&quot; have a closed ceiling</span>
                        <span class="n">tess_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">ceil</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tess_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">meshes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_ceil_tri&#39;</span><span class="p">,</span>
                                              <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tess_mesh</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_ceil_tri&#39;</span><span class="p">]</span> \
                                <span class="o">=</span> <span class="n">props</span>

                    <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">corridor</span><span class="p">:</span>
                        <span class="c1"># corridor have a closed floor</span>
                        <span class="c1"># print(&#39;tesselate corridor:&#39;, props.main_group)</span>
                        <span class="n">tess_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tess_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">meshes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">main_group</span><span class="o">+</span> <span class="s1">&#39;_floor_tri&#39;</span><span class="p">,</span>
                                              <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tess_mesh</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">main_group</span> <span class="o">+</span> <span class="s1">&#39;_floor_tri&#39;</span><span class="p">]</span> \
                                <span class="o">=</span> <span class="n">props</span>

        <span class="c1"># merge meshes in each group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_meshes_by_group</span><span class="p">(</span><span class="n">meshes</span><span class="p">)</span>

        <span class="c1"># fix normals of limestone parts</span>
        <span class="k">for</span> <span class="n">corridor</span><span class="p">,</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">meshes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">corridor</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calcaire&#39;</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">corridor</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_ceil_tri&#39;</span><span class="p">):</span>
                <span class="n">mesh</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># make cat flap mesh</span>
        <span class="n">catflap_col</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bas&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.56</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
                       <span class="sa">u</span><span class="s1">&#39;injecté&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.66</span><span class="p">,</span> <span class="mf">0.61</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">main_group</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">meshes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">props</span><span class="o">.</span><span class="n">catflap</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">meshes</span><span class="p">[</span><span class="n">main_group</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">catflap_col</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;material&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;diffuse&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
                <span class="n">cat_flap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_cat_flap</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
                <span class="n">meshes</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_0&#39;</span> <span class="o">%</span> <span class="n">main_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_flap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">meshes</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_1&#39;</span> <span class="o">%</span> <span class="n">main_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_flap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_0&#39;</span> <span class="o">%</span> <span class="n">main_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_1&#39;</span> <span class="o">%</span> <span class="n">main_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>
                <span class="k">del</span> <span class="n">meshes</span><span class="p">[</span><span class="n">main_group</span><span class="p">]</span>

        <span class="c1"># sounds and photos depth + markers meshes</span>
        <span class="n">object_win_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>

        <span class="n">protos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sounds&#39;</span><span class="p">:</span> <span class="s1">&#39;sounds_marker_model&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;sounds_private&#39;</span><span class="p">:</span> <span class="s1">&#39;sounds_marker_model&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;photos&#39;</span><span class="p">:</span> <span class="s1">&#39;photos_marker_model&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;photos_private&#39;</span><span class="p">:</span> <span class="s1">&#39;photos_marker_model&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">protos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">mesh_proto</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mtype</span><span class="p">,</span> <span class="s1">&#39;proto:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh_proto</span><span class="o">.</span><span class="n">vertex</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">mpos</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mtype</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">mpos</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">mpos</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">pos</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">],</span> <span class="n">win</span><span class="o">.</span><span class="n">view</span><span class="p">(),</span>
                                    <span class="n">object_win_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;failed to get depth for:&#39;</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">mpos</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
                <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
                <span class="c1"># print(&#39;marker:&#39;, level, pos)</span>
                <span class="n">mmesh</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">mesh_proto</span><span class="p">)(</span><span class="n">mesh_proto</span><span class="p">)</span>  <span class="c1"># copy</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">()</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">mmesh</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mesh</span> <span class="o">=</span> <span class="n">mmesh</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mmesh</span><span class="p">)</span>
                <span class="c1"># print(&#39;marker:&#39;, pos, len(mesh.vertex()))</span>
            <span class="k">if</span> <span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">main_group</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_mesh&#39;</span> <span class="o">%</span> <span class="n">mtype</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh_dict</span><span class="p">[</span><span class="n">main_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>
                <span class="n">meshes</span><span class="p">[</span><span class="n">main_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>
                <span class="n">props</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="p">()</span>
                <span class="n">props</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;markers&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="p">[</span><span class="n">main_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- marker mesh:&#39;</span><span class="p">,</span> <span class="n">main_group</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()),</span> <span class="n">props</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NO MARKER MESH:&#39;</span><span class="p">,</span> <span class="n">mtype</span><span class="p">)</span>


<div class="viewcode-block" id="CataSvgToMesh.extrude"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataSvgToMesh.extrude">[docs]</a>    <span class="k">def</span> <span class="nf">extrude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">height_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This is an overloaded version of the static SvgToMesh.extrude(mesh,</span>
<span class="sd">        distance)</span>

<span class="sd">        When height_map is given, use this level height map to shift Z</span>
<span class="sd">        positions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">height_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">extrude</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MAP extrude:&#39;</span><span class="p">,</span> <span class="n">height_map</span><span class="p">)</span>

        <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_wins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">height_map</span><span class="p">)</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">win</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>

        <span class="n">up</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">object_win_size</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">up</span><span class="o">.</span><span class="n">vertex</span><span class="p">():</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">object_win_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">distance</span>  <span class="c1"># fallback to default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we inverse (again) because depth maps are already inverted</span>
                <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">z</span>

        <span class="n">walls</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">walls</span><span class="o">.</span><span class="n">header</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">())]))</span>
        <span class="n">material</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;material&#39;</span> <span class="ow">in</span> <span class="n">walls</span><span class="o">.</span><span class="n">header</span><span class="p">():</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">walls</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span>
        <span class="n">material</span><span class="p">[</span><span class="s1">&#39;face_culling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">walls</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
        <span class="n">vert0</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
        <span class="n">poly0</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">walls</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">walls</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span>

        <span class="n">vert</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert0</span> <span class="o">+</span> <span class="n">up</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vert0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">poly0</span><span class="p">:</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nv</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nv</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nv</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">walls</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">up</span><span class="p">,</span> <span class="n">walls</span></div>

    <span class="k">def</span> <span class="nf">attach_arrows_to_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshes</span><span class="p">,</span> <span class="n">with_squares</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># find text attached to each arrow</span>
        <span class="k">for</span> <span class="n">arrow</span><span class="p">,</span> <span class="n">mesh_l</span> <span class="ow">in</span> <span class="n">meshes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">arrow</span> <span class="ow">and</span> <span class="n">mesh_l</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mesh_l</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">mesh_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">mesh_l</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="n">mesh_l</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;vertex&#39;</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** WARNING: ***&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A non-mesh object lies in an arrows &#39;</span>
                              <span class="s1">&#39;layer/group&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;faulty mesh:&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">text_o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_text_for_arrow</span><span class="p">(</span><span class="n">meshes</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">text_o</span><span class="p">:</span>
                        <span class="n">props</span> <span class="o">=</span> <span class="n">text_o</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
                        <span class="n">vert</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                        <span class="c1"># vert2 = aims.vector_POINT3DF(vert)</span>
                        <span class="n">decal</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vert</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> \
                            <span class="o">-</span> <span class="n">vert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1">#print(&#39;decal text&#39;, text_o[&#39;objects&#39;][0][&#39;properties&#39;][&#39;text&#39;], list(decal), &#39;to:&#39;, pos, &#39;, size&#39;, size)</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vert</span><span class="p">):</span>
                            <span class="c1"># v += decal * float(n - i) / n</span>
                            <span class="n">v</span> <span class="o">+=</span> <span class="n">decal</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">with_squares</span><span class="p">:</span>
                            <span class="c1"># debug: display rectangle around text location</span>
                            <span class="n">size</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                            <span class="n">x0</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="n">x1</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="n">y0</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="n">y1</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                            <span class="n">vert</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
                            <span class="n">z</span> <span class="o">=</span> <span class="n">vert</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
                            <span class="n">vert</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
                                     <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z</span><span class="p">)]</span>
                            <span class="n">poly</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span>
                            <span class="n">poly</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
                                     <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span>


    <span class="k">def</span> <span class="nf">find_text_for_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshes</span><span class="p">,</span> <span class="n">mesh</span><span class="p">):</span>
        <span class="n">dmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">text_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1">#print(&#39;find_text_for_arrow&#39;, mesh, point)</span>
        <span class="k">for</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">mesh_items</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">meshes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mtype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_text&#39;</span><span class="p">):</span>
                <span class="c1">#print(mtype, &#39; text:&#39;, mesh_items)</span>
                <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">mesh_items</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]:</span>
                    <span class="c1">#print(&#39;text:&#39;, text)</span>
                    <span class="n">props</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span>
                    <span class="c1">#print(&#39;props:&#39;, props)</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                    <span class="c1">#print(&#39;pos:&#39;, pos, &#39;, size:&#39;, size)</span>
                    <span class="c1"># distances to each segment</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x0</span><span class="p">:</span>
                        <span class="n">d0</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x1</span><span class="p">:</span>
                        <span class="n">d0</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d0</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y0</span><span class="p">:</span>
                        <span class="n">d1</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y1</span><span class="p">:</span>
                        <span class="n">d1</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">*</span> <span class="n">d0</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">d1</span>
                    <span class="k">if</span> <span class="n">dmin</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">dmin</span><span class="p">:</span>
                        <span class="n">dmin</span> <span class="o">=</span> <span class="n">d</span>
                        <span class="n">text_min</span> <span class="o">=</span> <span class="n">text</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># found a good match, skip other tests</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="n">text_min</span>


    <span class="k">def</span> <span class="nf">build_ground_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">border</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bord complet&#39;</span><span class="p">,</span> <span class="s1">&#39;bord_general&#39;</span><span class="p">,</span> <span class="s1">&#39;bord_sud&#39;</span><span class="p">):</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">svg</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
                        <span class="o">==</span> <span class="n">border</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No border layer found. Not building ground grid.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_2</span><span class="p">()</span>  <span class="c1"># no layer</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ground - border layer:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="o">=</span> <span class="n">label</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="c1"># print(&#39;ground grid bounds:&#39;, bounds)</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                 <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="mf">5.</span>
        <span class="k">if</span> <span class="n">props</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">grid_interval</span><span class="p">:</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">grid_interval</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">interval</span><span class="p">,</span>
                        <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span><span class="n">interval</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">grid_v</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">grid_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">grid_v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">grid_v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>
        <span class="n">grid_s</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> \
            <span class="o">+</span> <span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_2</span><span class="p">()</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">grid_v</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">grid_s</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground_grid</span> <span class="o">=</span> <span class="n">mesh</span>
        <span class="c1"># print(&#39;ground grid:&#39;, mesh.vertex().size(), &#39;vertices&#39;)</span>
        <span class="k">return</span> <span class="n">mesh</span>


    <span class="k">def</span> <span class="nf">make_skull_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">CataMapTo2DMap</span><span class="p">()</span>
        <span class="n">protos</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">find_protos</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">protos</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">skproto</span> <span class="o">=</span> <span class="n">protos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skproto</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">skproto</span> <span class="o">=</span> <span class="n">skproto</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ossuaire&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skproto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="o">=</span> <span class="s1">&#39;ossuaire_model&#39;</span>
        <span class="n">skmesh_l</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_2</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">skproto</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">]:</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span>
                <span class="n">skmesh_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">child</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">proto_scale</span> <span class="o">*</span> <span class="n">skproto</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">]))</span>
        <span class="n">skmesh_up_l</span><span class="p">,</span> <span class="n">skmesh_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrude</span><span class="p">(</span><span class="n">skmesh_l</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
        <span class="n">skmesh_bk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">skmesh_l</span><span class="p">)</span>
        <span class="n">skmesh_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">skmesh_up_l</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">invertSurfacePolygons</span><span class="p">(</span><span class="n">skmesh_w</span><span class="p">)</span>
        <span class="n">skmesh_w</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">invertSurfacePolygons</span><span class="p">(</span><span class="n">skmesh_bk</span><span class="p">)</span>
        <span class="n">skmesh_bk</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">skmesh_w</span><span class="p">,</span> <span class="n">skmesh_bk</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">skmesh_w</span><span class="p">,</span> <span class="n">skmesh_up</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">skmesh_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">bbmax</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbmin</span> <span class="o">+</span> <span class="n">bbmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">vert</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="n">skmesh_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">()</span>
        <span class="n">q</span><span class="o">.</span><span class="n">fromAxis</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">skmesh_w</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">skmesh_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">vert</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">bbmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">skmesh_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">skmesh_w</span>


    <span class="k">def</span> <span class="nf">make_fontis_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">CataMapTo2DMap</span><span class="p">()</span>
        <span class="n">protos</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">find_protos</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">protos</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">fproto</span> <span class="o">=</span> <span class="n">protos</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fontis&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fproto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="o">=</span> <span class="s1">&#39;fontis&#39;</span>
        <span class="n">fmesh_l</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_2</span><span class="p">()</span>
        <span class="n">fmesh_l</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">fproto</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span>
                <span class="n">fmesh_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">child</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">proto_scale</span> <span class="o">*</span> <span class="n">fproto</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">]))</span>
        <span class="n">fmesh_up_l</span><span class="p">,</span> <span class="n">fmesh_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrude</span><span class="p">(</span><span class="n">fmesh_l</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="n">fmesh_bk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">fmesh_l</span><span class="p">)</span>
        <span class="n">fmesh_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">fmesh_up_l</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">invertSurfacePolygons</span><span class="p">(</span><span class="n">fmesh_w</span><span class="p">)</span>
        <span class="n">fmesh_w</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">invertSurfacePolygons</span><span class="p">(</span><span class="n">fmesh_bk</span><span class="p">)</span>
        <span class="n">fmesh_bk</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">fmesh_w</span><span class="p">,</span> <span class="n">fmesh_bk</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">fmesh_w</span><span class="p">,</span> <span class="n">fmesh_up</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fmesh_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">bbmax</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbmin</span> <span class="o">+</span> <span class="n">bbmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">vert</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="n">fmesh_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fmesh_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">vert</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span> <span class="n">bbmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">fmesh_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fmesh_w</span>


    <span class="k">def</span> <span class="nf">make_water_scale_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">s9</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">0.9</span>
        <span class="n">s95</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">0.95</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">parallelepiped_wireframe</span><span class="p">(</span>
            <span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">s1</span><span class="p">),</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">s1</span><span class="p">))</span>
        <span class="n">para2</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">parallelepiped_wireframe</span><span class="p">(</span>
            <span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">s9</span><span class="p">,</span> <span class="n">s9</span><span class="p">,</span> <span class="n">s1</span><span class="p">),</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">s9</span><span class="p">,</span> <span class="n">s9</span><span class="p">,</span> <span class="n">s1</span><span class="p">))</span>
        <span class="n">para3</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">parallelepiped_wireframe</span><span class="p">(</span>
            <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">s2</span><span class="p">,</span> <span class="n">s95</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">),</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">para2</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">para3</span><span class="p">)</span>
        <span class="n">para</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.64</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>

        <span class="n">mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_3</span><span class="p">()</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cube</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">vert2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="mf">.9</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">vert</span><span class="p">,</span> <span class="n">vert2</span><span class="p">))</span> <span class="o">+</span> <span class="n">pos</span><span class="p">)</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">polygon</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">poly2</span> <span class="o">=</span> <span class="n">poly</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">poly2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">poly2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">poly2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

        <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">poly</span><span class="p">,</span> <span class="n">poly2</span><span class="p">))</span>

        <span class="n">poly2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                          <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">24</span><span class="p">)])</span>
        <span class="n">poly3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">poly2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">poly2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">poly2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="mi">12</span>

        <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">poly</span><span class="p">,</span> <span class="n">poly2</span><span class="p">,</span> <span class="n">poly3</span><span class="p">))</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

        <span class="n">vert3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span> \
            <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pos</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert3</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">cube</span><span class="p">)</span>

        <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.96</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.64</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>

        <span class="n">water</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_3</span><span class="p">()</span>
        <span class="n">vert3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">vert2</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span> <span class="o">+</span> <span class="n">pos</span>
        <span class="n">water</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert3</span><span class="p">)</span>
        <span class="n">water</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
        <span class="n">water</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                                      <span class="s1">&#39;face_culling&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;etiage_line&#39;</span><span class="p">:</span> <span class="n">para</span><span class="p">,</span>
                <span class="s1">&#39;etiage_wall_tri&#39;</span><span class="p">:</span> <span class="n">mesh</span><span class="p">,</span>
                <span class="s1">&#39;etiage_water_tri&#39;</span><span class="p">:</span> <span class="n">water</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">make_lily_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">CataMapTo2DMap</span><span class="p">()</span>
        <span class="n">protos</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">find_protos</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">protos</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">lproto</span> <span class="o">=</span> <span class="n">protos</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lys&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lproto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No proto for lys&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="o">=</span> <span class="s1">&#39;lys&#39;</span>
        <span class="n">lily_l</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_2</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">lproto</span><span class="p">[</span><span class="s1">&#39;element&#39;</span><span class="p">]:</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span>
                <span class="n">lily_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">child</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">proto_scale</span> <span class="o">*</span> <span class="n">lproto</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">]))</span>
        <span class="n">lily_up_l</span><span class="p">,</span> <span class="n">lily_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrude</span><span class="p">(</span><span class="n">lily_l</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">lily_bk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">lily_l</span><span class="p">)</span>
        <span class="n">lily_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">lily_up_l</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">invertSurfacePolygons</span><span class="p">(</span><span class="n">lily_w</span><span class="p">)</span>
        <span class="n">lily_w</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">invertSurfacePolygons</span><span class="p">(</span><span class="n">lily_bk</span><span class="p">)</span>
        <span class="n">lily_bk</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">lily_w</span><span class="p">,</span> <span class="n">lily_bk</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">lily_w</span><span class="p">,</span> <span class="n">lily_up</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lily_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">bbmax</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbmin</span> <span class="o">+</span> <span class="n">bbmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">vert</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="n">lily_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">()</span>
        <span class="n">q</span><span class="o">.</span><span class="n">fromAxis</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">lily_w</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lily_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">vert</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">bbmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">lily_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lily_w</span>


    <span class="k">def</span> <span class="nf">make_large_sign_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">CataMapTo2DMap</span><span class="p">()</span>
        <span class="n">lproto</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span>
                                 <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="s1">&#39;légende&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;grande_plaque&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">lproto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No proto for grande_plaque&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_group</span> <span class="o">=</span> <span class="s1">&#39;grande_plaque&#39;</span>
        <span class="n">lily_l</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_2</span><span class="p">()</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">lproto</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">lproto</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}g&#39;</span><span class="p">):</span>
                <span class="n">todo</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}text&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span>
                <span class="n">lily_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">child</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">proto_scale</span> <span class="o">*</span> <span class="n">trans</span><span class="p">))</span>
        <span class="n">lily_up_l</span><span class="p">,</span> <span class="n">lily_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrude</span><span class="p">(</span><span class="n">lily_l</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
        <span class="n">lily_bk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">lily_l</span><span class="p">)</span>
        <span class="n">lily_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tesselate</span><span class="p">(</span><span class="n">lily_up_l</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">invertSurfacePolygons</span><span class="p">(</span><span class="n">lily_w</span><span class="p">)</span>
        <span class="n">lily_w</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">invertSurfacePolygons</span><span class="p">(</span><span class="n">lily_bk</span><span class="p">)</span>
        <span class="n">lily_bk</span><span class="o">.</span><span class="n">updateNormals</span><span class="p">()</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">lily_w</span><span class="p">,</span> <span class="n">lily_bk</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">lily_w</span><span class="p">,</span> <span class="n">lily_up</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lily_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">bbmax</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbmin</span> <span class="o">+</span> <span class="n">bbmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">vert</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="n">lily_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">()</span>
        <span class="n">q</span><span class="o">.</span><span class="n">fromAxis</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">AffineTransformation3d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshTransform</span><span class="p">(</span><span class="n">lily_w</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lily_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span>
        <span class="n">bbmin</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">Point3df</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vert</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">vert</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">bbmin</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">lily_w</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lily_w</span>


    <span class="k">def</span> <span class="nf">make_stair_symbol_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_spiral_stair</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">make_sounds_marker_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">icosphere</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">cone</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cone</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
                                          <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">cone</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">mesh</span>


    <span class="k">def</span> <span class="nf">make_photos_marker_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">icosphere</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">cone</span> <span class="o">=</span> <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceGenerator</span><span class="o">.</span><span class="n">cone</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
                                          <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">aims</span><span class="o">.</span><span class="n">SurfaceManip</span><span class="o">.</span><span class="n">meshMerge</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">cone</span><span class="p">)</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">header</span><span class="p">()[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffuse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">mesh</span>


<div class="viewcode-block" id="CataSvgToMesh.save_mesh_dict"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataSvgToMesh.save_mesh_dict">[docs]</a>    <span class="k">def</span> <span class="nf">save_mesh_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshes</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">mesh_format</span><span class="o">=</span><span class="s1">&#39;.glb&#39;</span><span class="p">,</span>
                       <span class="n">mesh_wf_format</span><span class="o">=</span><span class="s1">&#39;.glb&#39;</span><span class="p">,</span> <span class="n">json_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">map2d_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># filter out wells definitions</span>
        <span class="k">def</span> <span class="nf">mod_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_3</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_tri&#39;</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">+=</span> <span class="s1">&#39;_tri&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">aims</span><span class="o">.</span><span class="n">AimsTimeSurface_2</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_line&#39;</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">+=</span> <span class="s1">&#39;_line&#39;</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="n">mdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">mod_key</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meshes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_wells&#39;</span><span class="p">)])</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="n">mesh_format</span>
        <span class="n">wf_format</span> <span class="o">=</span> <span class="n">mesh_wf_format</span>
        <span class="n">use_gltf</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">mesh_format</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.gltf&#39;</span><span class="p">,</span> <span class="s1">&#39;.glb&#39;</span><span class="p">):</span>
            <span class="c1"># don&#39;t build the GLTF dict because we need to split it in</span>
            <span class="c1"># categories</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">use_gltf</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">mesh_wf_format</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.gltf&#39;</span><span class="p">,</span> <span class="s1">&#39;.glb&#39;</span><span class="p">):</span>
            <span class="n">wf_format</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">use_gltf</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CataSvgToMesh</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save_mesh_dict</span><span class="p">(</span>
            <span class="n">mdict</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span>  <span class="n">mesh_format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">mesh_wf_format</span><span class="o">=</span><span class="n">wf_format</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_gltf</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">soma.aims</span> <span class="kn">import</span> <span class="n">gltf_io</span>
            <span class="n">gltf_dicts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># public</span>
            <span class="n">gltf_p_dicts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># private</span>

        <span class="c1"># output JSON dict</span>
        <span class="n">json_obj</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># date / version</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">build_version</span>
            <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">build_version</span><span class="p">)</span>
            <span class="c1"># increment build version</span>
            <span class="n">build_version</span><span class="o">.</span><span class="n">build_version</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># save modified build version</span>
            <span class="n">ver_file</span> <span class="o">=</span> <span class="n">build_version</span><span class="o">.</span><span class="vm">__file__</span>
            <span class="k">if</span> <span class="n">ver_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pyc&#39;</span><span class="p">):</span>
                <span class="n">ver_file</span> <span class="o">=</span> <span class="n">ver_file</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># get a .py</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rewrite version file:&#39;</span><span class="p">,</span> <span class="n">ver_file</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">ver_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;build_version = </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">build_version</span><span class="o">.</span><span class="n">build_version</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>  <span class="c1"># oh OK I can&#39;t write there.</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_version</span><span class="o">.</span><span class="n">build_version</span>
        <span class="n">title</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%04d</span><span class="s1">-</span><span class="si">%02d</span><span class="s1">-</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">map2d_filename</span><span class="p">:</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">map2d_filename</span>


        <span class="c1"># build 3D layers:</span>
        <span class="c1"># 0: main_corridors</span>
        <span class="c1"># 1: unreachable</span>
        <span class="c1"># 2: text</span>
        <span class="c1"># 3: parcels</span>
        <span class="c1"># 4: oss_off</span>
        <span class="c1"># 5: tech</span>
        <span class="c1"># 6: limestone</span>
        <span class="c1"># 7: legend</span>

        <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Couloirs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Inaccessible&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Textes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Parcelles&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ossuaire officiel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Galeries Tech.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Remblai&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Calcaire&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Légende&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Surface&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categories</span>
        <span class="n">def_categories</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">]</span>
        <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;default_categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">def_categories</span>
        <span class="n">used_layers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># print(&#39;summary:&#39;, summary, &#39;\n&#39;)</span>
        <span class="k">if</span> <span class="s1">&#39;meshes&#39;</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
            <span class="n">jmeshes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pmeshes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;meshes&#39;</span><span class="p">]):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">mesh</span>
                <span class="c1"># print(&#39;mesh:&#39;, mesh)</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_tri&#39;</span><span class="p">):</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">group</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_line&#39;</span><span class="p">):</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no props for mesh:&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>  <span class="c1"># remove extension</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="s1">&#39;bord&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># skip</span>
                <span class="k">if</span> <span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">depth_map</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEPTH MAP MESH:&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">layer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># not displayed</span>
                <span class="k">elif</span> <span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">category</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">props</span><span class="o">.</span><span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                        <span class="n">categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
                    <span class="n">layer</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># old way, specific</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;tech&#39;</span><span class="p">)</span> \
                            <span class="ow">or</span> <span class="s1">&#39;_tech_&#39;</span> <span class="ow">in</span> <span class="n">filename</span> \
                            <span class="ow">or</span> <span class="s1">&#39;techniques&#39;</span> <span class="ow">in</span> <span class="n">filename</span> \
                            <span class="ow">or</span> <span class="s1">&#39;gtech&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s1">&#39;ebauches&#39;</span> <span class="ow">in</span> <span class="n">filename</span> \
                            <span class="ow">or</span> <span class="s1">&#39;metro&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">5</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">arrow</span><span class="p">)</span> \
                            <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;plaques &#39;</span><span class="p">)</span> \
                            <span class="ow">or</span> <span class="sa">u</span><span class="s1">&#39; flèches&#39;</span> <span class="ow">in</span> <span class="n">filename</span> \
                            <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;etiage_&#39;</span><span class="p">):</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">elif</span> <span class="s1">&#39;parcelles&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">elif</span> <span class="s1">&#39;oss off&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">inaccessible</span><span class="p">)</span> \
                            <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;anciennes &#39;</span><span class="p">)</span> \
                            <span class="ow">or</span> <span class="s1">&#39;anciennes galeries&#39;</span> <span class="ow">in</span> <span class="n">filename</span> \
                            <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;aqueduc&#39;</span><span class="p">)</span> \
                            <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ex-&#39;</span><span class="p">)</span> \
                            <span class="ow">or</span> <span class="s1">&#39; inaccessibles&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;remblai&#39;</span><span class="p">):</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">6</span>
                    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calcaire&#39;</span><span class="p">):</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">7</span>
                    <span class="k">elif</span> <span class="sa">u</span><span class="s1">&#39;légende&#39;</span> <span class="ow">in</span> <span class="n">filename</span> \
                            <span class="ow">or</span> <span class="s1">&#39;grandes plaques&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">8</span>
                    <span class="k">elif</span> <span class="s1">&#39;grille surface&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="k">if</span> <span class="n">use_gltf</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;private&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">or</span> <span class="p">(</span><span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">private</span><span class="p">):</span>
                        <span class="n">gltf</span> <span class="o">=</span> <span class="n">gltf_p_dicts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gltf</span> <span class="o">=</span> <span class="n">gltf_dicts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gltf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">matrix</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">gltf_io</span><span class="o">.</span><span class="n">default_gltf_scene</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span> <span class="n">gltf</span><span class="o">=</span><span class="n">gltf</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdict</span><span class="p">[</span><span class="n">mesh</span><span class="p">]</span><span class="o">.</span><span class="n">vertex</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mesh has 0 size:&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gltf_io</span><span class="o">.</span><span class="n">mesh_to_gltf</span><span class="p">(</span><span class="n">mdict</span><span class="p">[</span><span class="n">mesh</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">gltf</span><span class="o">=</span><span class="n">gltf</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># print(&#39;mesh:&#39;, layer, &#39;:&#39;, filename, props)</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span>
                                                <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.obj&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">st_size</span>
                    <span class="c1"># hash</span>
                    <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span>
                                                        <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.obj&#39;</span><span class="p">),</span>
                                          <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;private&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">or</span> <span class="p">(</span><span class="n">props</span> <span class="ow">and</span> <span class="n">props</span><span class="o">.</span><span class="n">private</span><span class="p">):</span>
                        <span class="n">pmeshes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">layer</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">md5</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">jmeshes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">layer</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">md5</span><span class="p">])</span>

                <span class="n">used_layers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_gltf</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">pygltflib</span> <span class="kn">import</span> <span class="n">GLTF2</span><span class="p">,</span> <span class="n">BufferFormat</span><span class="p">,</span> <span class="n">ImageFormat</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">GLTF2</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># no GLTF/GLB conversion support</span>

            <span class="k">for</span> <span class="n">gltf_d</span><span class="p">,</span> <span class="n">private</span><span class="p">,</span> <span class="n">mmeshes</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">gltf_dicts</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">jmeshes</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">gltf_p_dicts</span><span class="p">,</span> <span class="s1">&#39;_private&#39;</span><span class="p">,</span> <span class="n">pmeshes</span><span class="p">)):</span>
                <span class="c1"># regroup GLTFs</span>
                <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">gltf</span> <span class="ow">in</span> <span class="n">gltf_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">layer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">category</span> <span class="o">=</span> <span class="n">categories</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">dirname</span><span class="p">,</span> <span class="n">category</span> <span class="o">+</span> <span class="n">private</span> <span class="o">+</span> <span class="n">mesh_format</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GLTF layer:&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

                    <span class="n">filename</span> <span class="o">=</span> <span class="n">gltf_io</span><span class="o">.</span><span class="n">save_gltf</span><span class="p">(</span><span class="n">gltf</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                                                 <span class="n">use_draco</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># print(&#39;GLTF mesh:&#39;, layer, &#39;:&#39;, filename, props)</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
                    <span class="k">if</span> <span class="n">layer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># layer -1 is hidden</span>
                        <span class="c1"># hash</span>
                        <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
                            <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                        <span class="n">mmeshes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">layer</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span>
                                        <span class="n">md5</span><span class="p">])</span>

            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;meshes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">jmeshes</span><span class="p">)</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;meshes_private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pmeshes</span><span class="p">)</span>

        <span class="n">new_nums</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">used_layers</span><span class="p">)}</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">used_layers</span><span class="p">]</span>
        <span class="c1"># re-number all items</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">jmeshes</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_nums</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pmeshes</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_nums</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categories</span>
        <span class="k">if</span> <span class="s1">&#39;Couloirs&#39;</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">def_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Couloirs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Ossuaire officiel&#39;</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">def_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Ossuaire officiel&#39;</span><span class="p">)</span>

        <span class="c1"># texts</span>
        <span class="c1"># TODO: separate them in different layers (hidden...)</span>
        <span class="k">if</span> <span class="s1">&#39;text_fnames&#39;</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;text_fnames&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;text_fnames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                          <span class="k">if</span> <span class="s1">&#39;private&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="p">])</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;text_fnames_private&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;text_fnames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                          <span class="k">if</span> <span class="s1">&#39;private&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">])</span>
            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;texts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">texts</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;text_fnames&#39;</span><span class="p">]:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span><span class="o">.</span><span class="n">st_size</span>
                <span class="c1"># hash</span>
                <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                                       <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">md5</span><span class="p">])</span>
            <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;texts_private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">texts</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;text_fnames_private&#39;</span><span class="p">]:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span><span class="o">.</span><span class="n">st_size</span>
                <span class="c1"># hash</span>
                <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                                       <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">md5</span><span class="p">])</span>

        <span class="c1"># sounds</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sounds</span><span class="p">:</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;sounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sounds</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sounds_private</span><span class="p">:</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;sounds_private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sounds_private</span>

        <span class="c1"># photos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">photos</span><span class="p">:</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;photos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">photos_private</span><span class="p">:</span>
            <span class="n">json_obj</span><span class="p">[</span><span class="s1">&#39;photos_private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photos_private</span>

        <span class="k">if</span> <span class="n">json_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_obj</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                        <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_obj</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                        <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json_obj</span></div></div>



<div class="viewcode-block" id="CataMapTo2DMap"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataMapTo2DMap">[docs]</a><span class="k">class</span> <span class="nc">CataMapTo2DMap</span><span class="p">(</span><span class="n">svg_to_mesh</span><span class="o">.</span><span class="n">SvgToMesh</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Process XML tree to build modified 2D maps</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">proto_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">]])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concat_mesh</span><span class="o">=</span><span class="s1">&#39;bygroup&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CataMapTo2DMap</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">concat_mesh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_protos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

        <span class="n">trans2</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">transm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">*</span> <span class="n">transm</span>

        <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">root</span>
                   <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                      <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
                      <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;légende&#39;</span>
                      <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">trans2</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">transm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">*</span> <span class="n">transm</span>
        <span class="n">trans_org</span> <span class="o">=</span> <span class="n">trans</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto_scale</span> <span class="o">*</span> <span class="n">trans_org</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#rep_child = [&#39;PSh&#39;, &#39;sans&#39;, &#39;PS sans&#39;, &#39;PSh sans&#39;, &#39;PS&#39;, &#39;P ossements&#39;,</span>
                      <span class="c1">#u&#39;échelle&#39;, u&#39;\xc3\xa9chelle&#39;, &#39;colim&#39;, &#39;PE&#39;, ]</span>
        <span class="n">rep_child</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">repl_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">ids</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">eid</span> <span class="ow">and</span> <span class="n">eid</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_proto&#39;</span><span class="p">):</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="n">eid</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">plabel</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
                <span class="n">pmap</span> <span class="o">=</span> <span class="n">ids</span>
                <span class="c1"># exception case: if label is the same without _proto</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ptype</span><span class="p">:</span>
                    <span class="n">plabel</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span>
                    <span class="n">pmap</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">and</span> <span class="n">label</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_proto&#39;</span><span class="p">):</span>
                    <span class="n">ptype</span> <span class="o">=</span> <span class="n">label</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
                    <span class="n">plabel</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span>
                    <span class="n">pmap</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="k">if</span> <span class="n">ptype</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="n">element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">plabel</span><span class="p">,</span> <span class="n">ptype</span><span class="p">)</span>
                <span class="n">item</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;element&#39;</span><span class="p">:</span> <span class="n">element</span><span class="p">}</span>
                <span class="n">etrans</span> <span class="o">=</span> <span class="n">trans</span>
                <span class="n">pscale</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;proto_scale&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pscale</span><span class="p">:</span>
                    <span class="n">pscale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pscale</span><span class="p">)</span>
                    <span class="n">pscalem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                    <span class="n">pscalem</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pscale</span>
                    <span class="n">pscalem</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pscale</span>
                    <span class="n">etrans</span> <span class="o">=</span> <span class="n">pscalem</span> <span class="o">*</span> <span class="n">trans_org</span>
                <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">etrans</span><span class="p">)</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;boundingbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bbox</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                  <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etrans</span>
                <span class="n">replace_children</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;replace_children&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">replace_children</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">replace_children</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">):</span>
                        <span class="n">replace_children</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">replace_children</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">rep_child</span><span class="p">:</span>
                    <span class="n">replace_children</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">replace_children</span><span class="p">:</span>
                    <span class="n">item</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pmap</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="k">return</span> <span class="n">repl_map</span>

    <span class="k">def</span> <span class="nf">transform_inf_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()]</span>

        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">map_trans</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;map_transform&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">map_trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="n">map_trans</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="n">map_trans</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">trans</span>
                <span class="n">element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>

            <span class="n">added</span> <span class="o">=</span> <span class="n">element</span><span class="p">[:]</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="n">added</span> <span class="o">+</span> <span class="n">todo</span>

    <span class="k">def</span> <span class="nf">shadow1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_id</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}filter&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Shadow&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;color-interpolation-filters:sRGB;&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">filter_id</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}filter&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Drop Shadow&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;color-interpolation-filters:sRGB;&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;filter14930&#39;</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feFlood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;flood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feFlood14920&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;0.498039&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-color&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(0,0,0)&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14922&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;composite1&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;SourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;flood&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feGaussianBlur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feGaussianBlur14924&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;stdDeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;blur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;composite1&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feOffset&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feOffset14926&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;-0.3&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;atop&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14928&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;fbSourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;SourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feColorMatrix&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feColorMatrix14932&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="s1">&#39;0 0 0 -1 0 0 0 0 -1 0 0 0 0 -1 0 0 0 0 1 0&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;fbSourceGraphicAlpha&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;fbSourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feFlood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;flood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-color&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(0,0,0)&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;fbSourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feFlood14934&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;0.498039&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;composite1&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14936&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;fbSourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;flood&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feGaussianBlur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;blur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;stdDeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;0.4&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feGaussianBlur14938&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;composite1&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feOffset&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feOffset14940&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;-0.4&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;0.4&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;over&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;composite2&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14942&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;fbSourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">shadow2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_id</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}filter&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Shadow&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;color-interpolation-filters:sRGB;&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">filter_id</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feFlood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;flood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feFlood14920&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-color&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(128,128,128)&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14922&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;composite1&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;SourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;flood&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feGaussianBlur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feGaussianBlur14924&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;stdDeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;blur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;composite1&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feOffset&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feOffset14926&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span> <span class="s1">&#39;-0.3&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;over&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14928&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;fbSourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;SourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">halo1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_id</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}filter&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Shadow&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;color-interpolation-filters:sRGB;&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">filter_id</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feMorphology&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;dilate1&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feMorphology44406&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">/</span> <span class="n">scale</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;dilate&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feFlood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;flood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feFlood14920&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;0.6&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-color&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(135,128,128)&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14922&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;composite1&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;dilate1&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;flood&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feGaussianBlur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feGaussianBlur14924&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;stdDeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.2</span> <span class="o">/</span> <span class="n">scale</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;blur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;composite1&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feFlood&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;flood2&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feFlood14921&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;1.&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;flood-color&#39;</span><span class="p">,</span> <span class="s1">&#39;rgb(0,0,0)&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14929&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;composite2&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;flood2&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;SourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;over&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14930&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;composite3&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;blur&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;composite2&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}feComposite&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;over&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;feComposite14928&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;fbSourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;SourceGraphic&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;in2&#39;</span><span class="p">,</span> <span class="s1">&#39;compisite3&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span>


    <span class="k">def</span> <span class="nf">make_shadow_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;shadow_filters&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shadow_filters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shadow_filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo1</span><span class="p">(</span><span class="s1">&#39;filter14930_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">defs</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}defs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>


    <span class="k">def</span> <span class="nf">add_shadow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">layer</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1">#for child in layer:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">style</span> <span class="o">+=</span> <span class="s1">&#39;; &#39;</span>
            <span class="n">style</span> <span class="o">+=</span> <span class="s1">&#39;filter:url(#</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">filter</span>
            <span class="n">child</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">add_shadows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inkscape_version</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># inkscape 1.1 has a problem with filters, it is extemely slow</span>
            <span class="c1"># and consumes memory. Rendering with inkscape 1.0 is 3 minutes for</span>
            <span class="c1"># a 360dpi map, and 185 minutes with inkscape 1.1</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;profondeurs&#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;background_bitm&#39;</span><span class="p">)):</span>
                <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">style</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;inline&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                <span class="n">shadow</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shadow&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shadow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shadow</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">,</span> <span class="s1">&#39;FALSE&#39;</span><span class="p">):</span>
                    <span class="n">shadow</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shadow</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">shadow</span> <span class="ow">or</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="s1">&#39;galeries inaccessibles inf&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;anciennes galeries inf&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries inf&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries inf private&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;anciennes galeries big&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries inaccessibles&#39;</span><span class="p">,</span> <span class="s1">&#39;galeries big PARIS&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries private&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries big 2&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries big sud&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries techniques&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;galeries inf private&#39;</span><span class="p">):</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">))</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
                    <span class="n">shadow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_shadow_filter</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_shadow</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">shadow</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_shadows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">defs</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}defs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}filter&#39;</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">defs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">roman</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
        <span class="n">onum</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">number</span> <span class="o">%</span> <span class="mi">1000</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">syms</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">))</span>
        <span class="n">div</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">number</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">syms</span><span class="p">)):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">div</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">onum</span> <span class="o">+=</span> <span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">syms</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">onum</span> <span class="o">+=</span> <span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">onum</span> <span class="o">+=</span> <span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">onum</span> <span class="o">+=</span> <span class="n">syms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">%</span> <span class="n">div</span>
            <span class="n">div</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">div</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">onum</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">formatted_date</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Janvier&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Février&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Mars&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Avril&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Mai&#39;</span><span class="p">,</span>
                  <span class="sa">u</span><span class="s1">&#39;Juin&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Juillet&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Août&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Septembre&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Octobre&#39;</span><span class="p">,</span>
                  <span class="sa">u</span><span class="s1">&#39;Novembre&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Décembre&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">months</span><span class="p">[</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">],</span>
                             <span class="n">CataMapTo2DMap</span><span class="o">.</span><span class="n">roman</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">in_region</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># bbox is used first to quickly discard points</span>
        <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                 <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># then check clip region polygon more thoroughfully</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;in_region check polygon:&#39;</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">polygon</span><span class="p">()</span>
        <span class="n">vert</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">vertex</span><span class="p">()</span>
        <span class="n">left_pts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="c1"># intersects with horizontal line on pt</span>
            <span class="n">intersect</span> <span class="o">=</span> <span class="p">((</span><span class="n">vert</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">vert</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">intersect</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># intersect abscissa</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vert</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">vert</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">vert</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">vert</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">xi</span> <span class="o">==</span> <span class="n">x</span><span class="p">:</span>
                <span class="c1"># just on border: in</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;__in__&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">left_pts</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># odd nb of intersections on the left (and right): in</span>
        <span class="c1"># even: out</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">left_pts</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="n">left_pts</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">left_pts</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="CataMapTo2DMap.box_in_region"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataMapTo2DMap.box_in_region">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">box_in_region</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; check if a box is totally inside a region, or totally outside, or</span>
<span class="sd">        intersecting</span>

<span class="sd">        Warning: if 4 corners are inside, the test says inside, whereas it is not always true for a non-convex clip polygon</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        1: inside</span>
<span class="sd">        0: intersecting</span>
<span class="sd">        -1: outside</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="p">[(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
               <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
               <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
               <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">nin</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">CataMapTo2DMap</span><span class="o">.</span><span class="n">in_region</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">bbox</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;box_in_region:&#39;</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">nin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">nin</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>


    <span class="k">def</span> <span class="nf">clip_and_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">target_layer</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">region_bbox</span><span class="p">,</span>
                       <span class="n">src_trans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clip_and_scale:&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="s1">&#39;into:&#39;</span><span class="p">,</span>
                  <span class="n">target_layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_copy</span><span class="p">:</span>
            <span class="n">target_layer</span> <span class="o">=</span> <span class="n">layer</span>
        <span class="n">trans2</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trans2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">src_trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">src_trans</span> <span class="o">=</span> <span class="n">trans2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">src_trans</span> <span class="o">=</span> <span class="n">src_trans</span> <span class="o">*</span> <span class="n">trans2</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copied</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#if layer.get(&#39;id&#39;) == &#39;layer31&#39;:</span>
            <span class="c1">#verbose = True</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">with_copy</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="n">target_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="n">copied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">src_trans</span><span class="p">)</span>
            <span class="c1">#print(&#39;bbox:&#39;, bbox)</span>
            <span class="k">if</span> <span class="n">bbox</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="n">in_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_in_region</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">region_bbox</span><span class="p">,</span>
                                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">in_out</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1">#print(&#39;out:&#39;, element.tag, element.get(&#39;id&#39;))</span>
                    <span class="c1">#to_remove.append(element)</span>
                <span class="c1">#elif in_out == 0:</span>
                    <span class="c1"># intesect</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;intersect:&#39;</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}g&#39;</span><span class="p">):</span>
                        <span class="c1"># group: look inside</span>
                        <span class="n">trans2</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">trans2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">src_trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">trans2</span> <span class="o">=</span> <span class="n">src_trans</span> <span class="o">*</span> <span class="n">trans2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">trans2</span> <span class="o">=</span> <span class="n">src_trans</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">clip_and_scale</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span>
                                            <span class="n">region_bbox</span><span class="p">,</span> <span class="n">src_trans</span><span class="p">,</span>
                                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># real object intersect: reject</span>
                        <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** in **:&#39;</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># text ? or other object with x, y attributes</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># no: something else: skip</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">trans2</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">trans2</span> <span class="o">=</span> <span class="n">src_trans</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trans2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">src_trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">trans2</span> <span class="o">=</span> <span class="n">src_trans</span> <span class="o">*</span> <span class="n">trans2</span>
                <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">trans2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1">#print(&#39;tag:&#39;, element.tag, x, y)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_region</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">region</span><span class="p">,</span> <span class="n">region_bbox</span><span class="p">,</span>
                                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">):</span>
                    <span class="c1">#print(&#39;remove from:&#39;, target_layer, target_layer.get(&#39;id&#39;))</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** in **:&#39;</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="n">target_layer</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">init_tr</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">init_tr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">init_tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">init_tr</span><span class="p">)</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">*</span> <span class="n">init_tr</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">copied</span><span class="p">:</span>
                <span class="n">trans2</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trans2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">trans2</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trans2</span> <span class="o">=</span> <span class="n">trans</span>
                <span class="n">element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_transform</span><span class="p">(</span><span class="n">trans2</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">enlarge_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_xml</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">keep_private</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">layer_label</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;masque </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">region</span>
        <span class="n">target_layer_label</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;agrandissement </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">region</span>
        <span class="n">mask_layer</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">src_xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
                <span class="o">==</span> <span class="n">layer_label</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mask_layer</span><span class="p">:</span>
            <span class="n">mask_layer</span> <span class="o">=</span> <span class="n">mask_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># this region doesn&#39;t exist in the map</span>
        <span class="n">target_layer</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
                <span class="o">==</span> <span class="n">target_layer_label</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">target_trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">target_layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">))</span>
        <span class="n">target_rect</span> <span class="o">=</span> <span class="n">target_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">target_rect</span><span class="p">,</span> <span class="n">target_trans</span><span class="p">)</span>
        <span class="c1">#rect = [float(target_rect.get(&#39;x&#39;)),</span>
                <span class="c1">#float(target_rect.get(&#39;y&#39;)),</span>
                <span class="c1">#float(target_rect.get(&#39;width&#39;)),</span>
                <span class="c1">#float(target_rect.get(&#39;height&#39;))]</span>
        <span class="c1">#rect[2] += rect[0]</span>
        <span class="c1">#rect[3] += rect[1]</span>
        <span class="c1">#print(&#39;target rect:&#39;, rect)</span>
        <span class="c1"># calculate transform</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">mask_layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">))</span>
        <span class="n">in_rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span><span class="p">(</span><span class="n">mask_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>
        <span class="c1">#print(&#39;in_rect:&#39;, in_rect)</span>
        <span class="n">transl</span> <span class="o">=</span> <span class="p">[</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">in_rect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">in_rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1">#print(&#39;transl:&#39;, transl)</span>
        <span class="n">enl_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">scl1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">in_rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">in_rect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">scl2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">in_rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">in_rect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#print(&#39;scales:&#39;, scl1, scl2)</span>
        <span class="n">scl</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">scl1</span><span class="p">,</span> <span class="n">scl2</span><span class="p">))</span>
        <span class="n">enl_tr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scl</span>
        <span class="n">enl_tr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scl</span>
        <span class="c1">#enl_tr[:2, 2] = np.expand_dims(transl[:2], 1) * scl</span>
        <span class="n">enl_tr</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> \
            <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">([</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
               <span class="o">-</span> <span class="n">enl_tr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">([</span><span class="n">in_rect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">in_rect</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.</span><span class="p">],</span> <span class="mi">1</span><span class="p">))[:</span><span class="mi">2</span><span class="p">,]</span>
        <span class="c1"># get back into target layer coords</span>
        <span class="n">enl_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">target_trans</span><span class="p">)</span> <span class="o">*</span> <span class="n">enl_tr</span>
        <span class="c1">#print(&#39;enlarge_region:&#39;, region)</span>
        <span class="c1">#print(&#39;rect:&#39;, rect)</span>
        <span class="c1">#print(&#39;in_rect:&#39;, in_rect)</span>
        <span class="c1">#print(&#39;enl_tr:&#39;, enl_tr)</span>
        <span class="c1">#print(&#39;target_trans:&#39;, target_trans)</span>

        <span class="c1"># replace rect by actual data</span>
        <span class="n">target_layer</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target_rect</span><span class="p">)</span>
        <span class="c1">#if region == &#39;vdg&#39;:</span>
            <span class="c1">## special case VDG: take specific corridors</span>
            <span class="c1">#corridors_layer = [</span>
                <span class="c1">#x for x in xml.getroot()</span>
                <span class="c1">#if x.get(&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;)</span>
                    <span class="c1">#== &#39;galeries big PARIS&#39;][0]</span>
            <span class="c1">#tr = self.get_transform(corridors_layer.get(&#39;transform&#39;))</span>
            <span class="c1">#group = [x for x in corridors_layer if x.tag.endswith(&#39;}g&#39;)][0]</span>
            <span class="c1">#tr *= self.get_transform(group.get(&#39;transform&#39;))</span>
            <span class="c1">#g2 = [x for x in group if x.get(&#39;id&#39;) == &#39;Z + VdG&#39;][0]</span>
            <span class="c1">## tr *= tr.get_transform(g2.get(&#39;transform&#39;))</span>
            <span class="c1">#new_g = copy.deepcopy(g2)</span>
            <span class="c1">##print(&#39;current tr:&#39;, tr)</span>
            <span class="c1">##print(&#39;final tr:&#39;, enl_tr * tr)</span>
            <span class="c1">#new_g.set(&#39;transform&#39;, self.to_transform(enl_tr * tr))</span>
            <span class="c1">#target_layer.append(new_g)</span>

        <span class="n">clip_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_path</span><span class="p">(</span><span class="n">mask_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}g&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;display:none&#39;</span> <span class="ow">in</span> <span class="n">style</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> \
                    <span class="ow">or</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;parcelles&#39;</span><span class="p">,</span> <span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;masque &#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;agrandissement &#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;bord &#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clip_and_scale</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">target_layer</span><span class="p">,</span> <span class="n">enl_tr</span><span class="p">,</span> <span class="n">clip_region</span><span class="p">,</span>
                                <span class="n">in_rect</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">with_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#print(&#39;in_rect:&#39;, in_rect)</span>
        <span class="c1">#print(np.asarray(clip_region.vertex()))</span>


<div class="viewcode-block" id="CataMapTo2DMap.replace_filter_element"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataMapTo2DMap.replace_filter_element">[docs]</a>    <span class="k">def</span> <span class="nf">replace_filter_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="c1">#if not self.keep_private and xml.get(&#39;level&#39;) in (&#39;tech&#39;, ):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_private</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tech&#39;</span><span class="p">,</span> <span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">xml</span></div>


    <span class="k">def</span> <span class="nf">do_remove_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span> \
                    <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">):</span>
                <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing layers:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_selected_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">non_visibility</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;non_visibility&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">non_visibility</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">non_visibility</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
                    <span class="n">non_visibility</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">non_visibility</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">non_visibility</span> <span class="o">=</span> <span class="p">[</span><span class="n">non_visibility</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span> <span class="ow">in</span> <span class="n">non_visibility</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="n">visibility</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;visibility&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">visibility</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">visibility</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
                <span class="n">visibility</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">visibility</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">visibility</span> <span class="o">==</span> <span class="s1">&#39;private&#39;</span><span class="p">:</span>  <span class="c1"># old style</span>
                    <span class="c1"># exception, here &#39;private&#39; is not a map type name but a</span>
                    <span class="c1"># variant (used in private, igc_private maps etc). It is</span>
                    <span class="c1"># filtered by remove_private(), and it is better to specify</span>
                    <span class="c1"># the tag private: true.</span>
                    <span class="k">continue</span>
                <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="n">visibility</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visibility</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_wip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;a_verifier&#39;</span><span class="p">,</span> <span class="s1">&#39;indications_big_2010&#39;</span><span class="p">,</span> <span class="s1">&#39;planches&#39;</span><span class="p">,</span>
             <span class="s1">&#39;calcaire 2010&#39;</span><span class="p">,</span>
             <span class="s1">&#39;work done calc&#39;</span><span class="p">,</span> <span class="s1">&#39;galeries techniques despe&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;à vérifier&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_south</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;galeries_big_sud&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="s1">&#39;couleur_fond&#39;</span><span class="p">,</span> <span class="s1">&#39;couleur_fond sud&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_private</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">priv_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;inscriptions&#39;</span><span class="p">,</span> <span class="s1">&#39;inscriptions conso&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;inscriptions inaccessibles&#39;</span><span class="p">,</span>
                        <span class="sa">u</span><span class="s1">&#39;inscriptions flèches&#39;</span><span class="p">,</span>
                        <span class="sa">u</span><span class="s1">&#39;inscriptions flèches inaccessibles&#39;</span><span class="p">,</span>
                        <span class="sa">u</span><span class="s1">&#39;inscriptions conso flèches&#39;</span><span class="p">,</span>
                        <span class="sa">u</span><span class="s1">&#39;maçonneries private&#39;</span><span class="p">,</span> <span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire 2010&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;work done calc&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;private&#39;</span><span class="p">))</span> \
                    <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;visibility&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;private&#39;</span> \
                    <span class="ow">or</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">priv_labels</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39; private&#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="s1">&#39;tech&#39;</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_private</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_wip</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;filter private in&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">))</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[(</span><span class="n">layer</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">element</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;visibility&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;private&#39;</span> \
                        <span class="ow">or</span> <span class="n">ItemProperties</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;private&#39;</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;remove:&#39;</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
                    <span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">todo</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">element</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">element</span><span class="p">]</span>
        
        
    <span class="k">def</span> <span class="nf">remove_gtech</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="s1">&#39;ebauches&#39;</span><span class="p">,</span> <span class="s1">&#39;galeries techniques&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;PS gtech&#39;</span><span class="p">,</span> <span class="s1">&#39;PSh gtech&#39;</span><span class="p">,</span> <span class="s1">&#39;PSh vers gtech&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;symboles gtech&#39;</span><span class="p">,</span> <span class="s1">&#39;eau gtech&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;raccords gtech 2D&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;metro&#39;</span><span class="p">,</span>
                                    <span class="sa">u</span><span class="s1">&#39;curiosités flèches GTech&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;curiosités GTech&#39;</span><span class="p">,</span>
                                    <span class="sa">u</span><span class="s1">&#39;échelle gtech&#39;</span><span class="p">,</span>
                                    <span class="sa">u</span><span class="s1">&#39;plaques de puits GTech&#39;</span><span class="p">,</span>
                                    <span class="sa">u</span><span class="s1">&#39;échelle vers gtech&#39;</span><span class="p">,</span>
                                    <span class="sa">u</span><span class="s1">&#39;plaques de puits GTech&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;annotations metro&#39;</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_calcaire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="s1">&#39;calcaire 2010&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire ciel ouvert&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;calcaire masse2&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire masse&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire med&#39;</span><span class="p">,</span>
        <span class="s1">&#39;calcaire sup&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire inf&#39;</span><span class="p">,</span> <span class="s1">&#39;calcaire vdg&#39;</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_igc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="s1">&#39;planches&#39;</span><span class="p">,</span> <span class="s1">&#39;planches fond&#39;</span><span class="p">,</span> <span class="s1">&#39;planches IGC&#39;</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_non_aqueduc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="s1">&#39;légende&#39;</span><span class="p">,</span> <span class="s1">&#39;grandes plaques&#39;</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_non_printable1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;masque bg&#39;</span><span class="p">,</span> <span class="s1">&#39;masques v1&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;d</span><span class="se">\xe9</span><span class="s1">coupage&#39;</span><span class="p">,</span>
             <span class="s1">&#39;chatieres old&#39;</span><span class="p">,</span> <span class="s1">&#39;photos&#39;</span><span class="p">,</span>
             <span class="c1">#&#39;bord_sud&#39;, &#39;galeries big sud&#39;,</span>
             <span class="sa">u</span><span class="s1">&#39;légende_alt&#39;</span><span class="p">,</span> <span class="s1">&#39;sons&#39;</span><span class="p">,</span> <span class="s1">&#39;altitude&#39;</span><span class="p">,</span> <span class="s1">&#39;lambert93&#39;</span><span class="p">,</span>
             <span class="s1">&#39;bord&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;profondeurs&#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;background_bitm&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_non_printable1_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;masque bg&#39;</span><span class="p">,</span> <span class="s1">&#39;masques v1&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;d</span><span class="se">\xe9</span><span class="s1">coupage&#39;</span><span class="p">,</span>
             <span class="s1">&#39;chatieres old&#39;</span><span class="p">,</span> <span class="s1">&#39;photos&#39;</span><span class="p">,</span>
             <span class="s1">&#39;bord_sud&#39;</span><span class="p">,</span> <span class="s1">&#39;galeries big sud&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;légende_alt&#39;</span><span class="p">,</span> <span class="s1">&#39;sons&#39;</span><span class="p">,</span> <span class="s1">&#39;altitude&#39;</span><span class="p">,</span> <span class="s1">&#39;lambert93&#39;</span><span class="p">,])</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;profondeurs&#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;background_bitm&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_non_printable1_pub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;masque bg&#39;</span><span class="p">,</span> <span class="s1">&#39;masques v1&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;d</span><span class="se">\xe9</span><span class="s1">coupage&#39;</span><span class="p">,</span>
             <span class="s1">&#39;chatieres old&#39;</span><span class="p">,</span> <span class="s1">&#39;photos&#39;</span><span class="p">,</span>
             <span class="s1">&#39;bord_sud&#39;</span><span class="p">,</span> <span class="s1">&#39;bord&#39;</span><span class="p">,</span> <span class="c1"># &#39;galeries big sud&#39;,</span>
             <span class="sa">u</span><span class="s1">&#39;légende_alt&#39;</span><span class="p">,</span> <span class="s1">&#39;sons&#39;</span><span class="p">,</span> <span class="s1">&#39;altitude&#39;</span><span class="p">,</span> <span class="s1">&#39;lambert93&#39;</span><span class="p">,])</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;profondeurs&#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;background_bitm&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_non_printable2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;galeries agrandissements&#39;</span><span class="p">,</span>
             <span class="s1">&#39;masque vdg&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;masque cimetière&#39;</span><span class="p">,</span>
             <span class="s1">&#39;masque plage&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_non_printable_igc_private</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;masque bg&#39;</span><span class="p">,</span> <span class="s1">&#39;masques v1&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;d</span><span class="se">\xe9</span><span class="s1">coupage&#39;</span><span class="p">,</span>
             <span class="s1">&#39;chatieres old&#39;</span><span class="p">,</span> <span class="s1">&#39;photos&#39;</span><span class="p">,</span>
             <span class="s1">&#39;bord&#39;</span><span class="p">,</span>
             <span class="c1">#&#39;bord_sud&#39;, &#39;galeries big sud&#39;,</span>
             <span class="sa">u</span><span class="s1">&#39;légende_alt&#39;</span><span class="p">,</span> <span class="s1">&#39;sons&#39;</span><span class="p">,</span> <span class="s1">&#39;altitude&#39;</span><span class="p">,</span> <span class="s1">&#39;lambert93&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;profondeurs&#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;background_bitm&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_limestone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;calcaire&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;masses&#39;</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_zooms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;agrandissement&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">resize_poster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">page_width</span><span class="o">=</span><span class="mi">1050</span><span class="p">):</span>
        <span class="n">target_width</span> <span class="o">=</span> <span class="n">page_width</span> <span class="o">/</span> <span class="mf">.254</span>  <span class="c1"># mm -&gt; inch</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_rect</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_rect</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>  <span class="c1"># main document</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">))</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">:</span>
            <span class="c1"># adapt for landscape orientation</span>
            <span class="n">target_height</span> <span class="o">=</span> <span class="n">target_width</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">target_height</span> <span class="o">/</span> <span class="n">height</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">target_width</span> <span class="o">/</span> <span class="n">width</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="s1">&#39;scale(</span><span class="si">%f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">scale</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_other</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_layers</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">replace_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">protos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_protos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_elements</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">protos</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">zoom_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;vdg&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;cimetière&#39;</span><span class="p">,</span> <span class="s1">&#39;plage&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enlarge_region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span>
                                <span class="n">keep_private</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_private</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">set_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">label</span> <span class="ow">and</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;légende&#39;</span><span class="p">))</span> \
                    <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># set date in appropriate field</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
                        <span class="n">child</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\xe9</span><span class="s1">dition du </span><span class="si">%s</span><span class="s1">&#39;</span> \
                          <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatted_date</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">show_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;display:inline&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">shadow_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">xml2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="n">todel</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}metadata&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shift_txt</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text_shadow_shift&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shift_txt</span><span class="p">:</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">shift_txt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml2</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
            <span class="c1"># shift (-0.075, 0.075)</span>
            <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>

        <span class="n">todo</span> <span class="o">=</span> <span class="p">[(</span><span class="n">xml2</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml2</span><span class="o">.</span><span class="n">getroot</span><span class="p">()[:]</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span>
            <span class="c1">#if tag not in (&#39;{http://www.w3.org/2000/svg}text&#39;,</span>
                           <span class="c1">#&#39;{http://www.w3.org/2000/svg}flowRoot&#39;,</span>
                           <span class="c1">#&#39;{http://www.w3.org/2000/svg}g&#39;):</span>
                <span class="c1">#parent.remove(elem)</span>
                <span class="c1">#continue</span>
            <span class="n">todo</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">elem</span><span class="p">,</span> <span class="n">sub_elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">sub_elem</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># else text</span>
            <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">style</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s1">&#39;{http://www.w3.org/2000/svg}text&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;{http://www.w3.org/2000/svg}flowRoot&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;{http://www.w3.org/2000/svg}tspan&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;{http://www.w3.org/2000/svg}flowRegion&#39;</span><span class="p">):</span>
                <span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#ffffff&#39;</span>
                <span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill-opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="k">if</span> <span class="n">style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
                <span class="n">style</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#ffffff&#39;</span>
                <span class="n">style</span><span class="p">[</span><span class="s1">&#39;stroke-opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

        <span class="n">xml2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/tmp/shadow_text.svg&#39;</span><span class="p">)</span>  <span class="c1"># FIXME debug</span>

        <span class="c1"># insert shadowed layers</span>
        <span class="n">insert_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">insert_pos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml2</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_pos</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
                <span class="n">insert_pos</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_alt_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">colorset</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">colorset</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">CataSvgToMesh</span><span class="o">.</span><span class="n">get_alt_color_s</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">colorset</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">colorset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorset_inheritance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colorset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">recolor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">colorset</span><span class="o">=</span><span class="s1">&#39;igc&#39;</span><span class="p">):</span>
        <span class="n">colorsets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">colorsets</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">colorset</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">legend_layer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get colorset_inheritance dict in metadata</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;colorset_inheritance&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colorset_inheritance</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}metadata&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">colorset_inheritance</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;colorset_inheritance&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">colorset_inheritance</span><span class="p">:</span>
                    <span class="n">colorset_inheritance</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">colorset_inheritance</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">colorset_inheritance</span> <span class="o">=</span> <span class="n">colorset_inheritance</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="p">()</span>
            <span class="n">props</span><span class="o">.</span><span class="n">fill_properties</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;recolor&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="n">todo</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">props</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">parents</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">props</span> <span class="o">=</span> <span class="n">ItemProperties</span><span class="p">()</span>
                <span class="n">props</span><span class="o">.</span><span class="n">fill_properties</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">parents</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">todo</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">parents</span> <span class="o">+</span> <span class="p">[</span><span class="n">props</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>

                <span class="n">corridor_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alt_color</span><span class="p">(</span>
                    <span class="n">props</span><span class="p">,</span> <span class="n">colorset</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">corridor_colors</span><span class="p">:</span>
                    <span class="n">corridor_colors</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">corridor_colors</span><span class="p">:</span>
                    <span class="c1"># print(&#39;skip recolor&#39;, label)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;légende&#39;</span><span class="p">:</span>
                    <span class="n">legend_layer</span> <span class="o">=</span> <span class="n">layer</span>
                <span class="c1"># allow legend to match labels found in map</span>
                <span class="c1"># however all items with this label will be affected...</span>
                <span class="c1">#if label not in colors:</span>
                    <span class="c1">#colors[label] = corridor_colors</span>
                <span class="n">bg</span> <span class="o">=</span> <span class="n">corridor_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bg&#39;</span><span class="p">)</span>
                <span class="n">op</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="n">fill_op</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="k">if</span> <span class="n">bg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">fill_op</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;0x</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]))</span> <span class="o">/</span> <span class="mf">255.</span>
                    <span class="n">bg</span> <span class="o">=</span> <span class="n">bg</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">fg</span> <span class="o">=</span> <span class="n">corridor_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fg&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;0x</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]))</span> <span class="o">/</span> <span class="mf">255.</span>
                    <span class="n">fg</span> <span class="o">=</span> <span class="n">fg</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bg</span> <span class="ow">and</span> <span class="s1">&#39;fill&#39;</span> <span class="ow">in</span> <span class="n">style</span><span class="p">:</span>
                        <span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bg</span>
                    <span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill-opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fill_op</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fg</span> <span class="ow">and</span> <span class="s1">&#39;stroke&#39;</span> <span class="ow">in</span> <span class="n">style</span><span class="p">:</span>
                        <span class="n">style</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fg</span>
                    <span class="n">style</span><span class="p">[</span><span class="s1">&#39;stroke-opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                    <span class="c1"># allow to replace other style elements</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">style_item</span> <span class="ow">in</span> <span class="n">corridor_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;fg&#39;</span><span class="p">,</span> <span class="s1">&#39;bg&#39;</span><span class="p">):</span>
                            <span class="n">style</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">style_item</span>

        <span class="c1"># recolor legend items</span>
        <span class="k">if</span> <span class="n">legend_layer</span><span class="p">:</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="n">legend_layer</span><span class="p">[:]</span>
            <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">todo</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[:]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">corridor_colors</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">corridor_colors</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
                    <span class="n">bg</span> <span class="o">=</span> <span class="n">corridor_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bg&#39;</span><span class="p">)</span>
                    <span class="n">fg</span> <span class="o">=</span> <span class="n">corridor_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fg&#39;</span><span class="p">)</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">fill_op</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="k">if</span> <span class="n">bg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="n">fill_op</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;0x</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]))</span> <span class="o">/</span> <span class="mf">255.</span>
                        <span class="n">bg</span> <span class="o">=</span> <span class="n">bg</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">fg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="n">op</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;0x</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]))</span> <span class="o">/</span> <span class="mf">255.</span>
                        <span class="n">fg</span> <span class="o">=</span> <span class="n">fg</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bg</span><span class="p">:</span>
                        <span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bg</span>
                        <span class="n">style</span><span class="p">[</span><span class="s1">&#39;fill-opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fill_op</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fg</span><span class="p">:</span>
                        <span class="n">style</span><span class="p">[</span><span class="s1">&#39;stroke&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fg</span>
                        <span class="n">style</span><span class="p">[</span><span class="s1">&#39;stroke-opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list_colorsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="n">colorsets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()]</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">alt_col</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alt_colors&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alt_col</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">alt_col</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">alt_col</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">colorsets</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">alt_col</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">label_alt_col</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label_alt_colors&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label_alt_col</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">label_alt_col</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">label_alt_col</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label_alt_col</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">colorsets</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="n">todo</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[:]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;available colorsets:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colorsets</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">col</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">colorsets</span>


    <span class="k">def</span> <span class="nf">split_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
        <span class="n">layer_setups</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">[</span><span class="s1">&#39;a_verifier&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;bord_sud&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;indications_big_2010&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;salles vdg&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;salles vdg private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;salles v1&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;salles inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;zones&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;curiosités vdg private&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;curiosités vdg&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;curiosités private&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;curiosités&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;curiosités inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;historiques&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rues vdg&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rues email&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rues v1 private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rues v1&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rues inf petit&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rues inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rues sans plaques&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;annotations vdg&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;annotations&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;plaques de puits&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;curiosités flèches dessus&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;rues flèches dessus&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;salles vdg flèches&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;salles v1 flèches&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;salles flèches private&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;curiosités flèches private&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;curiosités flèches&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;historiques flèches&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;rues v1 flèches private&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;rues v1 flèches&#39;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;inscriptions vdg&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;inscriptions conso&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;inscriptions&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;plaques rues volées&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;symboles gtech&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;PSh gtech&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;PSh vers gtech&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;échelle vers gtech&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;échelle vers gtech private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;eau gtech&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;ebauches&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;raccords gtech 2D&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;galeries techniques&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;galeries techniques despe&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;metro&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;inscriptions flèches&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;inscriptions conso flèches&#39;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;symboles private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;symboles&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;plaques rues&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;raccords plan 2D&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;sol-ciel&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;PSh&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;PS&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;PE&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;P ossements&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;escaliers&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;escaliers private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;escaliers inaccessibles&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;escaliers anciennes galeries big&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;PS sans&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;PSh sans&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;échelle&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;eau&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;maçonneries&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;maçonneries private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;cuves&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;galeries private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;galeries&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;galeries big sud&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;galeries inaccessibles&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;remblai epais&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;remblai leger&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;remblai epais inaccessibles&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;remblai leger inaccessibles&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;remblai epais inaccessibles inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;remblai leger inaccessibles inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;hagues&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;hagues effondrees&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;anciennes galeries big&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;cuves inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;symboles inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;galeries inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;anciennes galeries inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;galeries inaccessibles inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;chatieres private&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;chatieres v3&#39;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="p">[</span>
                 <span class="sa">u</span><span class="s1">&#39;légende_alt&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;légende&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;découpage&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;profondeurs gtech&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;profondeurs galeries&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;profondeurs seine&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;profondeurs esc&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;profondeurs galeries_inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;profondeurs metro&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;masque vdg&#39;</span><span class="p">,</span>
                 <span class="sa">u</span><span class="s1">&#39;masque cimetière&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;masque plage&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;agrandissement vdg&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;agrandissement cimetière&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;agrandissement plage&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;agrandissement fond&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire 2010&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire limites&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire masse&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire masse2&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire ciel ouvert&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire sup&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire med&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire inf&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;calcaire vdg&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;parcelles&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;altitude&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;couleur_fond1&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;couleur_fond&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;couleur_fond sud&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;planches&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;planches fond&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;planches IGC&#39;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">common</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;bord&#39;</span><span class="p">])</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">layer_setups</span><span class="p">[</span><span class="n">style</span><span class="p">]</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)):</span>
            <span class="n">mr</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">mr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="n">layer_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">to_all</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                <span class="c1"># common to all</span>
                <span class="n">to_all</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;layer_num&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">layer_num</span><span class="p">))</span>
            <span class="n">layer_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">common</span><span class="p">:</span>
                <span class="n">to_all</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">to_all</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lnames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">lnames</span><span class="p">:</span>
                    <span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">maps</span>


    <span class="k">def</span> <span class="nf">join_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_dummy</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">.svg&#39;</span><span class="p">)</span>

        <span class="c1">## clear xml</span>
        <span class="c1">#to_remove = []</span>
        <span class="c1">#labels = []</span>
        <span class="c1">#for layer in xml.getroot():</span>
            <span class="c1">#if layer.tag == &#39;{http://www.w3.org/2000/svg}g&#39;:</span>
                <span class="c1">#to_remove.append(layer)</span>
        <span class="c1">#for layer in to_remove:</span>
            <span class="c1">#xml.getroot().remove(layer)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pattern</span> <span class="o">%</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">%</span> <span class="n">i</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">mapi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xml</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xml</span> <span class="o">=</span> <span class="n">mapi</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">mapi</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;layer_num&#39;</span><span class="p">))</span>
                <span class="c1"># look where to insert it</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">xlayer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">xlayer</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">xlayer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xlayer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;layer_num&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">xlayer_num</span> <span class="o">==</span> <span class="n">layer_num</span><span class="p">:</span>
                        <span class="c1"># already here, do nothing</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">xlayer_num</span> <span class="o">&gt;</span> <span class="n">layer_num</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>

        <span class="c1"># now remove layer_num</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;layer_num&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">layer</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;layer_num&#39;</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">layer_opacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">opacity</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set layer opacity:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">opacity</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span> \
                        <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;found it.&#39;</span><span class="p">)</span>
                <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">style</span><span class="p">[</span><span class="s1">&#39;opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opacity</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;style:&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">))</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">map_layers_opacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;map layers opacity&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">lay_op</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;map_opacity&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lay_op</span><span class="p">:</span>
                <span class="n">lay_op</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lay_op</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span> <span class="ow">in</span> <span class="n">lay_op</span><span class="p">:</span>
                    <span class="n">opacity</span> <span class="o">=</span> <span class="n">lay_op</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map_name</span><span class="p">]</span>
                    <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">style</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">style</span><span class="p">[</span><span class="s1">&#39;opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opacity</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_clip_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">rect_def</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">rect_def</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">rect_def</span> \
                        <span class="ow">or</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">rect_def</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">child</span>

<div class="viewcode-block" id="CataMapTo2DMap.ensure_clip_rect"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.CataMapTo2DMap.ensure_clip_rect">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_clip_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_xml</span><span class="p">,</span> <span class="n">rect_id</span><span class="p">,</span> <span class="n">in_xml</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; if rect_id is not in out_xml, then take it from in_xml and copy it</span>
<span class="sd">        in a new layer un out_xml.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_clip_rect</span><span class="p">(</span><span class="n">out_xml</span><span class="p">,</span> <span class="n">rect_id</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c1"># OK</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">in_xml</span><span class="p">,</span> <span class="n">rect_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">elem</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;element not found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dims_or_rect</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">,</span> <span class="n">trans</span> <span class="o">=</span> <span class="n">elem</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;{http://www.w3.org/2000/svg}g&#39;</span><span class="p">)</span>
        <span class="n">out_xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}label&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;clip_border&#39;</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;{http://www.inkscape.org/namespaces/inkscape}groupmode&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;layer&#39;</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;display:none&#39;</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;clip_border&#39;</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">rect</span><span class="p">))</span>
        <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">rect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>  <span class="c1"># copy same id</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">build_2d_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">keep_private</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">filters</span><span class="o">=</span><span class="p">[],</span> <span class="n">map_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1">#igc_colorset = &#39;igc&#39;</span>
        <span class="c1">#if map_name.startswith(&#39;igcportail&#39;):</span>
            <span class="c1">#igc_colorset = &#39;igcportail&#39;</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

        <span class="n">recolor</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filters</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;recolor=&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">recolor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">colorsets</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;colorsets&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">colorsets</span><span class="p">:</span>
                <span class="n">colorsets</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">colorsets</span><span class="p">)</span>
                <span class="n">def_colorset</span> <span class="o">=</span> <span class="n">colorsets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">map_name</span><span class="p">)</span>
                <span class="c1"># TODO: remove the exception here:</span>
                <span class="k">if</span> <span class="n">def_colorset</span><span class="p">:</span> <span class="c1"># and not map_name.startswith(&#39;igc&#39;):</span>
                    <span class="n">filters</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;recolor=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">def_colorset</span><span class="p">)</span>
        <span class="c1"># if forcing recolor=default, just remove the filter</span>
        <span class="k">if</span> <span class="s1">&#39;recolor=&quot;default&quot;&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;recolor=&quot;default&quot;&#39;</span><span class="p">)</span>

        <span class="n">all_filters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;remove_private&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_private</span><span class="p">,</span>
            <span class="s1">&#39;remove_non_printable1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_non_printable1</span><span class="p">,</span>
            <span class="s1">&#39;remove_non_printable2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_non_printable2</span><span class="p">,</span>
            <span class="s1">&#39;remove_non_printable1_pub&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_non_printable1_pub</span><span class="p">,</span>
            <span class="s1">&#39;remove_non_printable1_main&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_non_printable1_main</span><span class="p">,</span>
            <span class="s1">&#39;remove_non_printable_igc_private&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_non_printable_igc_private</span><span class="p">,</span>
            <span class="s1">&#39;remove_non_printable&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;remove_non_printable1&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;remove_non_printable2&#39;</span><span class="p">],</span>
            <span class="s1">&#39;remove_wip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_wip</span><span class="p">,</span>
            <span class="s1">&#39;remove_south&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_south</span><span class="p">,</span>
            <span class="s1">&#39;remove_background&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_background</span><span class="p">,</span>
            <span class="s1">&#39;remove_limestone&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_limestone</span><span class="p">,</span>
            <span class="s1">&#39;remove_gtech&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_gtech</span><span class="p">,</span>
            <span class="s1">&#39;remove_non_aqueduc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_non_aqueduc</span><span class="p">,</span>
            <span class="s1">&#39;remove_calcaire&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_calcaire</span><span class="p">,</span>
            <span class="s1">&#39;remove_igc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_igc</span><span class="p">,</span>
            <span class="s1">&#39;remove_other&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_other</span><span class="p">,</span>
            <span class="s1">&#39;add_shadow&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_shadows</span><span class="p">,</span>
            <span class="s1">&#39;shift_inf_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_inf_level</span><span class="p">,</span>
            <span class="s1">&#39;replace_symbols&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_symbols</span><span class="p">,</span>
            <span class="s1">&#39;recolor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">recolor</span><span class="p">,</span>
            <span class="s1">&#39;zooms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_areas</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_date</span><span class="p">,</span>
            <span class="s1">&#39;show_all&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_all</span><span class="p">,</span>
            <span class="s1">&#39;split_layers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_layers</span><span class="p">,</span>
            <span class="s1">&#39;join_layers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_layers</span><span class="p">,</span>
            <span class="s1">&#39;layer_opacity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_opacity</span><span class="p">,</span>
            <span class="s1">&#39;remove_zooms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_zooms</span><span class="p">,</span>
            <span class="s1">&#39;resize_poster&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_poster</span><span class="p">,</span>
            <span class="s1">&#39;shadow_text&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shadow_text</span><span class="p">,</span>
            <span class="s1">&#39;map_layers_opacity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_layers_opacity</span><span class="p">,</span>
            <span class="s1">&#39;printable_map&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;remove_non_printable1&#39;</span><span class="p">,</span> <span class="s1">&#39;show_all&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;shift_inf_level&#39;</span><span class="p">,</span> <span class="s1">&#39;replace_symbols&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;zooms&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_non_printable2&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_igc&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;layer_opacity=[&quot;XIII masses&quot;, &quot;0.31&quot;]&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;map_layers_opacity&#39;</span><span class="p">],</span>
            <span class="s1">&#39;poster_map&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;remove_non_printable1_main&#39;</span><span class="p">,</span> <span class="s1">&#39;show_all&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;shift_inf_level&#39;</span><span class="p">,</span> <span class="s1">&#39;replace_symbols&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;zooms&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_non_printable2&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_igc&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;layer_opacity=[&quot;XIII masses&quot;, &quot;0.31&quot;]&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;map_layers_opacity&#39;</span><span class="p">],</span>
            <span class="s1">&#39;printable_map_public&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;remove_non_printable1_pub&#39;</span><span class="p">,</span> <span class="s1">&#39;show_all&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;shift_inf_level&#39;</span><span class="p">,</span> <span class="s1">&#39;replace_symbols&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;zooms&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_non_printable2&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_igc&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;layer_opacity=[&quot;XIII masses&quot;, &quot;0.31&quot;]&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;map_layers_opacity&#39;</span><span class="p">],</span>
            <span class="s1">&#39;igc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;remove_private&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_non_printable1_pub&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;remove_non_printable2&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;remove_background&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_limestone&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_zooms&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;remove_other=[&quot;raccords plan 2D&quot;, &quot;parcelles&quot;, &#39;</span>
                                  <span class="s1">&#39;&quot;raccords gtech 2D&quot;]&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show_all&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                    <span class="c1">#&#39;recolor=&quot;%s&quot;&#39; % igc_colorset,</span>
                    <span class="s1">&#39;layer_opacity=[&quot;planches IGC&quot;, &quot;0.44&quot;]&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;map_layers_opacity&#39;</span><span class="p">],</span>
            <span class="s1">&#39;igc_private&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;remove_wip&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_non_printable_igc_private&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;remove_non_printable2&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;remove_background&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_limestone&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_zooms&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;remove_other=[&quot;raccords plan 2D&quot;, &quot;parcelles&quot;, &#39;</span>
                                  <span class="s1">&#39;&quot;raccords gtech 2D&quot;]&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;show_all&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                    <span class="c1">#&#39;recolor=&quot;%s&quot;&#39; % igc_colorset,</span>
                    <span class="s1">&#39;layer_opacity=[&quot;planches IGC&quot;, &quot;0.44&quot;]&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;map_layers_opacity&#39;</span><span class="p">],</span>
            <span class="s1">&#39;aqueduc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;remove_non_printable1&#39;</span><span class="p">,</span> <span class="s1">&#39;show_all&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;shift_inf_level&#39;</span><span class="p">,</span> <span class="s1">&#39;replace_symbols&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;remove_background&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_wip&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;remove_other=[&quot;raccords plan 2D&quot;, &quot;parcelles&quot;, &#39;</span>
                                      <span class="s1">&#39;&quot;raccords gtech 2D&quot;]&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;replace_symbols&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_zooms&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;remove_non_printable2&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_igc&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;remove_calcaire&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_non_aqueduc&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;layer_opacity=[&quot;XIII masses&quot;, &quot;0.31&quot;]&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;map_layers_opacity&#39;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">map_2d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">map_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_private</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_transformed_properties</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;map_transform&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">map_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remove_selected_layers</span><span class="p">(</span><span class="n">map_2d</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">filters</span><span class="p">:</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">filt_val</span> <span class="o">=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filt_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">filter</span> <span class="o">=</span> <span class="n">filt_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">filt_val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
                <span class="n">filt_def</span> <span class="o">=</span> <span class="n">all_filters</span><span class="p">[</span><span class="nb">filter</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filt_def</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filt_def</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;apply filter:&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">filt_def</span><span class="p">(</span><span class="n">map_2d</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filters</span> <span class="o">=</span> <span class="n">filt_def</span> <span class="o">+</span> <span class="n">filters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">results</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;build_2d_map done.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span></div>


<span class="n">_inksape_ubuntu16</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">get_inkscape_ub16</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_inksape_ubuntu16</span>

    <span class="k">if</span> <span class="n">_inksape_ubuntu16</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_inksape_ubuntu16</span>

    <span class="n">inkscape_ub16</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;inkscape&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/etc/lsb-release&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/etc/lsb-release&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">info</span><span class="p">])</span>
        <span class="n">release</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DISTRIB_RELEASE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">release</span> <span class="ow">or</span> <span class="n">release</span> <span class="o">==</span> <span class="s1">&#39;16.04&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inkscape_ub16</span>
        <span class="n">pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pwd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">))):</span>
            <span class="n">pwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">)),</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">))</span>
        <span class="n">casa_distro</span> <span class="o">=</span> <span class="n">distutils</span><span class="o">.</span><span class="n">spawn</span><span class="o">.</span><span class="n">find_executable</span><span class="p">(</span><span class="s1">&#39;casa_distro&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">casa_distro</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inkscape_ub16</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;casa_distro&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">])</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">)]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">[{</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ubuntu-16.04&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;casa_distro&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">]</span> \
                <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;inkscape&#39;</span><span class="p">,</span> <span class="s1">&#39;--help&#39;</span><span class="p">])</span>
                <span class="n">inkscape_ub16</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;cwd=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pwd</span><span class="p">,</span> <span class="s1">&#39;inkscape&#39;</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="n">inkscape_ub16</span>


<span class="n">_inkscape_version</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">inkscape_version</span><span class="p">(</span><span class="n">inkscape_exe</span><span class="o">=</span><span class="s1">&#39;inkscape&#39;</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_inkscape_version</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inkscape_exe</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">inkscape_exe</span> <span class="o">=</span> <span class="p">[</span><span class="n">inkscape_exe</span><span class="p">]</span>

    <span class="n">ver</span> <span class="o">=</span> <span class="n">_inkscape_version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">inkscape_exe</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ver</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ver</span>

    <span class="n">over</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">inkscape_exe</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;--version&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;over:&#39;</span><span class="p">,</span> <span class="n">over</span><span class="p">)</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">over</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
    <span class="n">_inkscape_version</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">inkscape_exe</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ver</span>
    <span class="k">return</span> <span class="n">ver</span>


<span class="k">def</span> <span class="nf">export_pdf</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">inkscape_exe</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;inkscape&#39;</span><span class="p">]</span>
    <span class="n">iver</span> <span class="o">=</span> <span class="n">inkscape_version</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">iver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iver</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">92</span><span class="p">:</span>
            <span class="c1"># 0.92 has a but in pdf export</span>
            <span class="n">inkscape_exe</span> <span class="o">=</span> <span class="n">get_inkscape_ub16</span><span class="p">()</span>
        <span class="n">iver</span> <span class="o">=</span> <span class="n">inkscape_version</span><span class="p">(</span><span class="n">inkscape_exe</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pdf export exe:&#39;</span><span class="p">,</span> <span class="n">inkscape_exe</span><span class="p">,</span> <span class="n">iver</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># 1.x commandline options have competely changed</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">inkscape_exe</span> <span class="o">+</span> <span class="p">[</span>
             <span class="s1">&#39;--export-pdf-version&#39;</span><span class="p">,</span> <span class="s1">&#39;1.5&#39;</span><span class="p">,</span> <span class="s1">&#39;--export-area-page&#39;</span><span class="p">,</span>
             <span class="s1">&#39;--export-type&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">out_file</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">out_file</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="p">[</span><span class="n">in_file</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_file</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">in_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
            <span class="n">inkscape_exe</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-z&#39;</span><span class="p">,</span>
             <span class="s1">&#39;--export-pdf-version&#39;</span><span class="p">,</span> <span class="s1">&#39;1.5&#39;</span><span class="p">,</span> <span class="s1">&#39;--export-area-page&#39;</span><span class="p">,</span>
             <span class="s1">&#39;--export-pdf&#39;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">in_file</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">export_png</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">rect_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">inkscape_exe</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;inkscape&#39;</span><span class="p">]</span>
    <span class="n">iver</span> <span class="o">=</span> <span class="n">inkscape_version</span><span class="p">()</span>
    <span class="c1">#if iver[0] == 1:</span>
        <span class="c1">## 1.0 has a bug and crashes during png save</span>
        <span class="c1">## (both actually for large images)</span>
        <span class="c1">#inkscape_exe = get_inkscape_ub16()</span>
        <span class="c1">#iver = inkscape_version(inkscape_exe)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;png export exe:&#39;</span><span class="p">,</span> <span class="n">inkscape_exe</span><span class="p">,</span> <span class="s1">&#39;, version:&#39;</span><span class="p">,</span> <span class="n">iver</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out_file</span><span class="p">:</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">in_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ignore_errors</span><span class="p">:</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span>
    <span class="k">if</span> <span class="n">iver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># 1.x commandline options have competely changed</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">inkscape_exe</span> <span class="o">+</span> <span class="p">[</span>
             <span class="s1">&#39;--export-type&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;--export-dpi&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">),</span>
             <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rect_id</span><span class="p">:</span>
             <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--export-id&#39;</span><span class="p">,</span> <span class="n">rect_id</span><span class="p">]</span>
        <span class="n">call</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="p">[</span><span class="n">in_file</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">inkscape_exe</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-z&#39;</span><span class="p">,</span>
             <span class="s1">&#39;--export-dpi&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">),</span>
             <span class="s1">&#39;--export-png&#39;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rect_id</span><span class="p">:</span>
             <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;--export-id&#39;</span><span class="p">,</span> <span class="n">rect_id</span><span class="p">]</span>
        <span class="n">call</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="p">[</span><span class="n">in_file</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">convert_to_format</span><span class="p">(</span><span class="n">png_file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_pixels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">png_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">format</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">PIL</span><span class="p">:</span>
        <span class="c1"># use Pillow PIL module</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_pixels</span><span class="p">:</span>
            <span class="n">max_pixels</span> <span class="o">=</span> <span class="mi">30000</span> <span class="o">*</span> <span class="mi">30000</span>  <span class="c1"># large enough</span>
        <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">MAX_IMAGE_PIXELS</span> <span class="o">=</span> <span class="n">max_pixels</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">png_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">im</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;jpg&#39;</span><span class="p">:</span>
                    <span class="c1"># convert to RGB with alpha and white background</span>
                    <span class="n">front</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  <span class="c1"># copy because the image in read only</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">alpha</span> <span class="o">=</span> <span class="n">front</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># uint8</span>
                        <span class="n">front</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">front</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                               <span class="o">*</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                    <span class="n">front</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>

                    <span class="n">im</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="s1">&#39;RGBA&#39;</span><span class="p">)</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>

                <span class="n">save_options</span><span class="o">=</span><span class="p">{}</span>
                <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;tif&#39;</span><span class="p">:</span>
                    <span class="c1"># save_options[&#39;compression&#39;] = &#39;tiff_lzw&#39;</span>
                    <span class="n">save_options</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;jpeg&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">save_options</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">95</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="o">**</span><span class="n">save_options</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;tif&#39;</span><span class="p">:</span>
                        <span class="c1"># we smetimes run into the error:</span>
                        <span class="c1"># JPEGSetupEncode: RowsPerStrip must be multiple of 8</span>
                        <span class="c1"># for JPEG.</span>
                        <span class="c1"># I don&#39;t know how to handle it for now, so then switch</span>
                        <span class="c1"># to LZW compression (files will be much larger)</span>
                        <span class="n">save_options</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;tiff_lzw&#39;</span>
                        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="o">**</span><span class="n">save_options</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cannot convert&quot;</span><span class="p">,</span> <span class="n">infile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use ImageMagick convert tool</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;convert&#39;</span><span class="p">,</span> <span class="s1">&#39;-quality&#39;</span><span class="p">,</span> <span class="s1">&#39;98&#39;</span><span class="p">,</span> <span class="s1">&#39;-background&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;-flatten&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span>
              <span class="n">png_file</span><span class="p">,</span> <span class="n">outfile</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">png_file</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">build_2d_map</span><span class="p">(</span><span class="n">xml_et</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">map_name</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">clip_rect</span><span class="p">,</span>
                 <span class="n">dpi</span><span class="p">,</span> <span class="n">shadows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_pdf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_jpg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">georef</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">svg2d</span> <span class="o">=</span> <span class="n">CataMapTo2DMap</span><span class="p">()</span>

    <span class="n">meta</span> <span class="o">=</span> <span class="n">svg2d</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">xml_et</span><span class="p">)</span>
    <span class="n">main_clip_rects</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;main_clip_rect_id&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">main_clip_rects</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">main_clip_rects</span><span class="p">)</span>
    <span class="n">main_clip_rect</span> <span class="o">=</span> <span class="n">main_clip_rects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">clip_rect</span><span class="p">:</span>
        <span class="n">clip_rect</span> <span class="o">=</span> <span class="n">main_clip_rects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">map_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clip_rect</span><span class="p">:</span>
            <span class="n">clip_rect</span> <span class="o">=</span> <span class="n">main_clip_rect</span>
    <span class="c1">#print(&#39;clip_rect:&#39;, clip_rect, &#39;, main_clip_rect:&#39;, main_clip_rect)</span>

    <span class="n">svg2d</span><span class="o">.</span><span class="n">clip_rect_name</span> <span class="o">=</span> <span class="n">clip_rect</span>
    <span class="n">clip_rect_name</span> <span class="o">=</span> <span class="n">clip_rect</span>
    <span class="n">clip_rect</span> <span class="o">=</span> <span class="n">svg2d</span><span class="o">.</span><span class="n">find_clip_rect</span><span class="p">(</span><span class="n">xml_et</span><span class="p">,</span> <span class="n">clip_rect</span><span class="p">)</span>
    <span class="n">svg2d</span><span class="o">.</span><span class="n">clip_rect</span> <span class="o">=</span> <span class="n">clip_rect</span>
    <span class="n">map2d</span> <span class="o">=</span> <span class="n">svg2d</span><span class="o">.</span><span class="n">build_2d_map</span><span class="p">(</span><span class="n">xml_et</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">map_name</span><span class="o">=</span><span class="n">map_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clip_rect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clip_rect</span> <span class="o">=</span> <span class="n">clip_rect</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="n">xscale</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">yscale</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">xoffset</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">yoffset</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">clip_rect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">svg2d</span><span class="o">.</span><span class="n">ensure_clip_rect</span><span class="p">(</span><span class="n">map2d</span><span class="p">,</span> <span class="n">clip_rect</span><span class="p">,</span> <span class="n">xml_et</span><span class="p">)</span>
        <span class="n">svg2d</span><span class="o">.</span><span class="n">clip_page</span><span class="p">(</span><span class="n">map2d</span><span class="p">,</span> <span class="n">clip_rect</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">georef</span> <span class="ow">and</span> <span class="n">clip_rect_name</span> <span class="o">!=</span> <span class="n">main_clip_rect</span><span class="p">:</span>
            <span class="c1"># not the same clipping as the georefed one</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;recalculate georef scaling&#39;</span><span class="p">)</span>
            <span class="n">cr</span> <span class="o">=</span> <span class="n">svg2d</span><span class="o">.</span><span class="n">clip_rect</span>
            <span class="n">crref</span> <span class="o">=</span> <span class="n">svg2d</span><span class="o">.</span><span class="n">find_clip_rect</span><span class="p">(</span><span class="n">xml_et</span><span class="p">,</span> <span class="n">main_clip_rect</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">crref</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">crref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xscale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">))</span> \
                    <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">crref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">))</span>
                <span class="n">yscale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span> \
                    <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">crref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span>
                <span class="n">xoffset</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">crref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)))</span> \
                    <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">crref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">))</span>
                <span class="n">yoffset</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">crref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)))</span> \
                    <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">crref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;use scale/offset:&#39;</span><span class="p">,</span> <span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">)</span>

    <span class="n">map2d</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_flat.svg&#39;</span> <span class="o">%</span> <span class="n">map_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">shadows</span><span class="p">:</span>
        <span class="n">svg2d</span><span class="o">.</span><span class="n">add_shadows</span><span class="p">(</span><span class="n">map2d</span><span class="p">)</span>
    <span class="n">map2d</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.svg&#39;</span> <span class="o">%</span> <span class="n">map_name</span><span class="p">))</span>

    <span class="c1"># build bitmap and pdf versions</span>
    <span class="c1"># private</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="n">svg2d</span><span class="o">.</span><span class="n">find_clip_rect</span><span class="p">(</span><span class="n">map2d</span><span class="p">,</span> <span class="n">clip_rect</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">))</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;w, h:&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dpi:&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="p">)</span>
    <span class="n">wpix</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">dpi</span><span class="p">)</span> <span class="o">/</span> <span class="mf">25.4</span>
    <span class="n">hpix</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">dpi</span><span class="p">)</span> <span class="o">/</span> <span class="mf">25.4</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;in pixels:&#39;</span><span class="p">,</span> <span class="n">wpix</span><span class="p">,</span> <span class="n">hpix</span><span class="p">)</span>
    <span class="n">export_png</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.svg&#39;</span> <span class="o">%</span> <span class="n">map_name</span><span class="p">),</span>
               <span class="n">dpi</span><span class="p">,</span> <span class="n">clip_rect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_pdf</span><span class="p">:</span>
        <span class="n">export_pdf</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_flat.svg&#39;</span> <span class="o">%</span> <span class="n">map_name</span><span class="p">))</span>
        <span class="c1"># TODO: add scaling</span>
        <span class="c1"># for now to scale PDF:</span>
        <span class="c1"># pdfjam --outfile out.pdf --papersize &#39;{1050mm,1240.81mm}&#39; --landscape in.pdf</span>
        <span class="c1"># if needed, rotate:</span>
        <span class="c1"># qpdf --rotate=270:1 plan_14_fdc_2022_11_08_poster_private_flat.pdf plan_14_fdc_2022_11_08_poster_private_flat_270.pdf</span>

    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_flat.svg&#39;</span> <span class="o">%</span> <span class="n">map_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">do_jpg</span> <span class="ow">or</span> <span class="n">georef</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">georef</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;tif&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jpg&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;convert to&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">convert_to_format</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">map_name</span><span class="p">),</span>
                          <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">max_pixels</span><span class="o">=</span><span class="p">(</span><span class="n">wpix</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wpix</span><span class="o">+</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">georef</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">gdalcopyproj</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;gdal module is not installed - georeferencing data will &#39;</span>
                  <span class="s1">&#39;not be copied&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">tiff_file</span> <span class="o">=</span> <span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.tif&#39;</span> <span class="o">%</span> <span class="n">map_name</span><span class="p">)</span>
        <span class="n">gdalcopyproj</span><span class="o">.</span><span class="n">copy_geo_projection</span><span class="p">(</span>
            <span class="n">georef</span><span class="p">,</span> <span class="n">tiff_file</span><span class="p">,</span> <span class="n">scale_x</span><span class="o">=</span><span class="n">xscale</span><span class="p">,</span> <span class="n">scale_y</span><span class="o">=</span><span class="n">yscale</span><span class="p">,</span>
            <span class="n">offset_x</span><span class="o">=</span><span class="n">xoffset</span><span class="p">,</span> <span class="n">offset_y</span><span class="o">=</span><span class="n">yoffset</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;geolocalization info copied.&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="scale_georef_points_file"><a class="viewcode-back" href="../../index.html#catamap.map_to_meshes.scale_georef_points_file">[docs]</a><span class="k">def</span> <span class="nf">scale_georef_points_file</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">scale_factor_x</span><span class="p">,</span>
                             <span class="n">scale_factor_y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Rescale source positions in a QGis .points file in order to adapt</span>
<span class="sd">    to a different resolution</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">scale_factor_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale_factor_y</span> <span class="o">=</span> <span class="n">scale_factor_x</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># scale columns 2 and 3 (sourceX,sourceY)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_factor_x</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_factor_y</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># 1st line is not parsed correctly, write it by hand</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">do_2d</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_3d</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_igc</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_igc_private</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_split</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_join</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">do_recolor</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out_dirname</span> <span class="o">=</span> <span class="s1">&#39;meshes_obj&#39;</span>
    <span class="n">maps_dpi</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;180&#39;</span><span class="p">,</span>
        <span class="s1">&#39;public&#39;</span><span class="p">:</span> <span class="s1">&#39;360&#39;</span><span class="p">,</span>
        <span class="s1">&#39;private&#39;</span><span class="p">:</span> <span class="s1">&#39;360&#39;</span><span class="p">,</span>
        <span class="s1">&#39;private_wip&#39;</span><span class="p">:</span> <span class="s1">&#39;180&#39;</span><span class="p">,</span>
        <span class="s1">&#39;poster&#39;</span><span class="p">:</span> <span class="s1">&#39;360&#39;</span><span class="p">,</span>
        <span class="s1">&#39;poster_private&#39;</span><span class="p">:</span> <span class="s1">&#39;720&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igc&#39;</span><span class="p">:</span> <span class="s1">&#39;180&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igc_private&#39;</span><span class="p">:</span> <span class="s1">&#39;360&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igcportail&#39;</span><span class="p">:</span> <span class="s1">&#39;720&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igcportail_txt&#39;</span><span class="p">:</span> <span class="s1">&#39;720&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igcportail_legend&#39;</span><span class="p">:</span> <span class="s1">&#39;720&#39;</span><span class="p">,</span>
        <span class="s1">&#39;igcportail_tech&#39;</span><span class="p">:</span> <span class="s1">&#39;720&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">all_maps</span> <span class="o">=</span> <span class="s1">&#39;public,private,wip,poster,igc,igc_private,aqueduc,No_Gtech&#39;</span>

    <span class="k">class</span> <span class="nc">MultilineFormatter</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">HelpFormatter</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_fill_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">* &#39;</span><span class="p">,</span> <span class="s1">&#39;|n |n * &#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">* &#39;</span><span class="p">,</span> <span class="s1">&#39;|n * &#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;|n |n &#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whitespace_matcher</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|n&#39;</span><span class="p">)</span>
            <span class="n">multiline_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="n">paragraphs</span><span class="p">:</span>
                <span class="n">formatted_paragraph</span> <span class="o">=</span> <span class="n">_textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">paragraph</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">initial_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">subsequent_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">multiline_text</span> <span class="o">=</span> <span class="n">multiline_text</span> <span class="o">+</span> <span class="n">formatted_paragraph</span>
            <span class="k">return</span> <span class="n">multiline_text</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="s1">&#39;catamap&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Catacombs maps using SVG source map with codes inside it.</span>

<span class="s1">The program allows to produce:</span>

<span class="s1">* 2D &quot;readable&quot; maps with symbolsmain changed to larger ones, second level shifted to avoid superimposition of corridors, enlarged zooms, shadowing etc.</span>

<span class="s1">* 3D maps to be used in a 3D visualization program, a webGL server, or the CataZoom app.</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">MultilineFormatter</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--2d&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;do_2d&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Build 2D maps (several maps). the maps list is given via the &#39;</span>
        <span class="s1">&#39;--maps option. If the latter is not specified, do all.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--maps&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;do_2d_maps&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;specify which 2d maps should be built, ex: &#39;</span>
        <span class="s1">&#39;&quot;public,private,igc&quot;. Values are in (&quot;public&quot;, &quot;private&quot;, &quot;wip&quot;, &#39;</span>
        <span class="s1">&#39;&quot;poster&quot;, &quot;poster_private&quot;, &quot;igc&quot;, &quot;igc_private&quot;, &quot;aqueduc&quot;, &#39;</span>
        <span class="s1">&#39;&quot;No_GTech&quot;, &quot;igcportail&quot;, &#39;</span>
        <span class="s1">&#39;&quot;igcportail_txt&quot;, &quot;igcportail_legend&quot;, &quot;igcportail_tech&quot;). Default: &#39;</span>
        <span class="s1">&#39;all if --2d is used. If this option is specified, --2d is implied &#39;</span>
        <span class="s1">&#39;(thus is not needed)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--3d&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;do_3d&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Build 3D map meshes in the &quot;</span><span class="si">%s</span><span class="s1">/&quot; directory&#39;</span> <span class="o">%</span> <span class="n">out_dirname</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--color&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;recolor the maps using a color model. Available models are &#39;</span>
        <span class="s1">&#39;(currently): igc, bator, black (igc is used automatically in the &#39;</span>
        <span class="s1">&#39;--igc options). The colorset &quot;default&quot; forces to use the default &#39;</span>
        <span class="s1">&#39;colors in the map (and cancel any recolor specified in the map). The &#39;</span>
        <span class="s1">&#39;list of available colorsets for a SVG map can be &#39;</span>
        <span class="s1">&#39;obtained using the option --list-colorsets.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--list-colorsets&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;list available colorsets in this map&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--split&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;split the SVG file into 4 smaller ones, each containing a &#39;</span>
        <span class="s1">&#39;subset of the layers&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--dpi&#39;</span><span class="p">,</span> <span class="c1"># nargs=&#39;+&#39;,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output JPEG images resolution. May be global (for all outputs): &#39;</span>
        <span class="s1">&#39;&quot;360&quot;, or scoped to a single map: &quot;igc:360&quot;. Several --dpi options &#39;</span>
        <span class="s1">&#39;may specify resolutions for several output maps: &#39;</span>
        <span class="s1">&#39;&quot;--dpi 200,igc:360,private:280&quot;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--clip&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;clip using this rectangle ID in the inkscape SVG&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--no-pdf&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;do not generate PDF versions of the map&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--pdf&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;do generate PDF versions of the map&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--join&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;reverse the --split operation: concatenate layers from several &#39;</span>
        <span class="s1">&#39;files&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--output_filename&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;base filename for output 2D maps. The filename will be suffixed &#39;</span>
        <span class="s1">&#39;according to maps types (_imprimable, _imprimable_private, etc) &#39;</span>
        <span class="s1">&#39;(default: same as input file). Be careful that some maps are using &#39;</span>
        <span class="s1">&#39;files linked in the same input directory, and will not work if the &#39;</span>
        <span class="s1">&#39;output is in a different directory.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;input_file&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;input SVG Inkscape file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;output_3d_dir&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">out_dirname</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output 3D meshes directory (default: </span><span class="si">%(default)s</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;--georef&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Copy GeoTIFF information from the given source file to a .tif &#39;</span>
        <span class="s1">&#39;export&#39;</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">do_2d</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">do_2d</span>
    <span class="n">do_2d_maps</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">do_2d_maps</span>
    <span class="k">if</span> <span class="n">do_2d_maps</span><span class="p">:</span>
        <span class="n">do_2d</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">do_2d</span><span class="p">:</span>
        <span class="n">do_2d_maps</span> <span class="o">=</span> <span class="n">all_maps</span>

    <span class="n">do_3d</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">do_3d</span>
    <span class="n">do_split</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">split</span>
    <span class="n">do_join</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">join</span>
    <span class="n">do_pdf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">do_list_colorsets</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">list_colorsets</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">no_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">do_pdf</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">no_pdf</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">do_pdf</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pdf</span>
    <span class="n">out_filename</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">output_filename</span>
    <span class="n">colorset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">color</span><span class="p">:</span>
        <span class="n">do_recolor</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">colorset</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">color</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dpi</span><span class="p">:</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">dpi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">maps_dpi2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dpi</span><span class="p">:</span>
            <span class="n">dpi_spec</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
            <span class="n">resol</span> <span class="o">=</span> <span class="n">dpi_spec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dpi_spec</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">dpi_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">maps_dpi2</span><span class="p">[</span><span class="n">scope</span><span class="p">]</span> <span class="o">=</span> <span class="n">resol</span>
        <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">maps_dpi2</span><span class="p">:</span>
            <span class="c1"># &quot;default&quot; overrides all builtin settings</span>
            <span class="n">maps_dpi</span> <span class="o">=</span> <span class="n">maps_dpi2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise we just update</span>
            <span class="n">maps_dpi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">maps_dpi2</span><span class="p">)</span>
        <span class="c1"># print(&#39;resolutions:&#39;, maps_dpi)</span>

    <span class="n">clip_rect</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">clip</span>

    <span class="c1"># print(options)</span>

    <span class="n">svg_filename</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">input_file</span>
    <span class="n">out_dirname</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">output_3d_dir</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out_filename</span><span class="p">:</span>
        <span class="n">out_filename</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">input_file</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">):</span>
        <span class="n">out_filename</span> <span class="o">+=</span> <span class="s1">&#39;.svg&#39;</span>

    <span class="k">if</span> <span class="n">do_3d</span><span class="p">:</span>
        <span class="n">svg_mesh</span> <span class="o">=</span> <span class="n">CataSvgToMesh</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">svg_mesh</span> <span class="o">=</span> <span class="n">CataMapTo2DMap</span><span class="p">()</span>
    <span class="c1">#svg_mesh.debug = True</span>

    <span class="n">georef</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">georef</span>

    <span class="k">if</span> <span class="n">colorset</span><span class="p">:</span>
        <span class="n">svg_mesh</span><span class="o">.</span><span class="n">colorset</span> <span class="o">=</span> <span class="n">colorset</span>

    <span class="k">if</span> <span class="n">do_3d</span> <span class="ow">or</span> <span class="n">do_2d</span> <span class="ow">or</span> <span class="n">do_split</span> <span class="ow">or</span> <span class="n">do_recolor</span> <span class="ow">or</span> <span class="n">do_list_colorsets</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading SVG...&#39;</span><span class="p">)</span>
        <span class="n">xml_et</span> <span class="o">=</span> <span class="n">svg_mesh</span><span class="o">.</span><span class="n">read_xml</span><span class="p">(</span><span class="n">svg_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_list_colorsets</span><span class="p">:</span>
        <span class="n">svg_mesh</span><span class="o">.</span><span class="n">list_colorsets</span><span class="p">(</span><span class="n">xml_et</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_3d</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;extracting meshes...&#39;</span><span class="p">)</span>
        <span class="n">meshes</span> <span class="o">=</span> <span class="n">svg_mesh</span><span class="o">.</span><span class="n">read_paths</span><span class="p">(</span><span class="n">xml_et</span><span class="p">)</span>
        <span class="n">svg_mesh</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">meshes</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;saving meshes...&#39;</span><span class="p">)</span>
        <span class="c1">#mesh_format = (&#39;.obj&#39;, &#39;WAVEFRONT&#39;)</span>
        <span class="c1">#mesh_wf_format = (&#39;.obj&#39;, &#39;WAVEFRONT&#39;)</span>
        <span class="n">mesh_format</span> <span class="o">=</span> <span class="s1">&#39;.glb&#39;</span>
        <span class="n">mesh_wf_format</span> <span class="o">=</span> <span class="s1">&#39;.glb&#39;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">svg_mesh</span><span class="o">.</span><span class="n">save_mesh_dict</span><span class="p">(</span>
            <span class="n">meshes</span><span class="p">,</span> <span class="n">out_dirname</span><span class="p">,</span> <span class="n">mesh_format</span><span class="p">,</span> <span class="n">mesh_wf_format</span><span class="p">,</span>
            <span class="s1">&#39;map_objects.json&#39;</span><span class="p">,</span>
            <span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_imprimable_private.jpg&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">do_2d</span><span class="p">:</span>
        <span class="n">do_2d_maps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">do_2d_maps</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;build 2D maps:&#39;</span><span class="p">,</span> <span class="n">do_2d_maps</span><span class="p">)</span>

        <span class="n">col_filter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">do_recolor</span><span class="p">:</span>
            <span class="n">col_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;recolor=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">colorset</span><span class="p">]</span>

        <span class="n">maps_def</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;private&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;private&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">col_filter</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;remove_wip&#39;</span><span class="p">,</span> <span class="s1">&#39;printable_map&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;nord_sud_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;poster&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;poster&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">col_filter</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;remove_private&#39;</span><span class="p">,</span> <span class="s1">&#39;poster_map&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;grs_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;poster_private&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;poster_private&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">col_filter</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;remove_wip&#39;</span><span class="p">,</span> <span class="s1">&#39;poster_map&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;grs_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;wip&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;private_wip&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">col_filter</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;printable_map&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;nord_sud_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;public&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">col_filter</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;remove_private&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_gtech&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;printable_map_public&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;grs_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;igc&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;igc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;igc&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;grs_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;igc_private&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;igc_private&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;igc_private&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;nord_sud_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;igcportail&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;igcportail&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;igc_private&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;nord_sud_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;do_jpg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;igcportail_txt&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;igcportail_txt&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;igc_private&#39;</span><span class="p">,</span> <span class="s1">&#39;shadow_text&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;nord_sud_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;do_jpg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;igcportail_legend&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;igcportail_legend&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;igc_private&#39;</span><span class="p">,</span> <span class="s1">&#39;shadow_text&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;nord_sud_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;do_jpg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;igcportail_tech&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;igcportail_tech&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;igc_private&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;nord_sud_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;do_jpg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;aqueduc&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;aqueduc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">col_filter</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;aqueduc&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;aqueduc_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;No_GTech&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;No_GTech&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="n">col_filter</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;remove_wip&#39;</span><span class="p">,</span> <span class="s1">&#39;printable_map&#39;</span><span class="p">,</span><span class="s1">&#39;remove_gtech&#39;</span><span class="p">],</span>
                <span class="c1">#&#39;clip_rect&#39;: &#39;nord_sud_clip&#39;,</span>
                <span class="s1">&#39;shadows&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;do_pdf&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
           <span class="p">},</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">map_type</span> <span class="ow">in</span> <span class="n">do_2d_maps</span><span class="p">:</span>
            <span class="n">map_def</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">maps_def</span><span class="p">[</span><span class="n">map_type</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">clip_rect</span><span class="p">:</span>
                <span class="n">map_def</span><span class="p">[</span><span class="s1">&#39;clip_rect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clip_rect</span>
            <span class="k">if</span> <span class="n">do_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map_def</span><span class="p">[</span><span class="s1">&#39;do_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_pdf</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clip:&#39;</span><span class="p">,</span> <span class="n">map_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clip_rect&#39;</span><span class="p">))</span>
            <span class="n">georef_yscale</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="n">georef</span><span class="p">:</span>
                <span class="c1"># don&#39;t write jpg, we will use tiff</span>
                <span class="n">map_def</span><span class="p">[</span><span class="s1">&#39;do_jpg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">build_2d_map</span><span class="p">(</span>
                <span class="n">xml_et</span><span class="p">,</span>
                <span class="n">out_filename</span><span class="p">,</span>
                <span class="n">map_name</span><span class="o">=</span><span class="n">map_def</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">map_def</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">],</span>
                <span class="n">clip_rect</span><span class="o">=</span><span class="n">map_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clip_rect&#39;</span><span class="p">),</span>
                <span class="n">dpi</span><span class="o">=</span><span class="n">maps_dpi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">map_type</span><span class="p">,</span> <span class="n">maps_dpi</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]),</span>
                <span class="n">shadows</span><span class="o">=</span><span class="n">map_def</span><span class="p">[</span><span class="s1">&#39;shadows&#39;</span><span class="p">],</span>
                <span class="n">do_pdf</span><span class="o">=</span><span class="n">map_def</span><span class="p">[</span><span class="s1">&#39;do_pdf&#39;</span><span class="p">],</span>
                <span class="n">do_jpg</span><span class="o">=</span><span class="n">map_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;do_jpg&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">georef</span><span class="o">=</span><span class="n">georef</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_split</span><span class="p">:</span>
        <span class="n">svg2d</span> <span class="o">=</span> <span class="n">CataMapTo2DMap</span><span class="p">()</span>
        <span class="n">map2d_split</span> <span class="o">=</span> <span class="n">svg2d</span><span class="o">.</span><span class="n">build_2d_map</span><span class="p">(</span>
            <span class="n">xml_et</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;split_layers=&quot;default&quot;&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">map2d_split</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">.svg&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">do_join</span><span class="p">:</span>
        <span class="n">svg2d</span> <span class="o">=</span> <span class="n">CataMapTo2DMap</span><span class="p">()</span>
        <span class="n">map2d_join</span> <span class="o">=</span> <span class="n">svg2d</span><span class="o">.</span><span class="n">build_2d_map</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;join_layers=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">out_filename</span><span class="p">])</span>
        <span class="n">map2d_join</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;_joined.svg&#39;</span><span class="p">))</span>

    <span class="n">time_len</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_start</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;execution time: </span><span class="si">%d</span><span class="s1">:</span><span class="si">%05.2f</span><span class="s1"> min:sec.&#39;</span>
          <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time_len</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">),</span> <span class="n">time_len</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_len</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CataMap 2.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">catamap.map_to_meshes</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, FDC.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    </div>
  </body>
</html>